<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Extrair Texto de PDF</title>
    <!-- CSS Global -->
    <link rel="stylesheet" href="unified-pdf-tools.css">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Scripts PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    
    <style>
        /* Estilos específicos para visualização de texto */
        .text-preview-container {
            background: white;
            border: 1px solid var(--color-gray-200);
            border-radius: var(--radius-md);
            padding: 1rem;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 1rem;
            font-family: monospace;
            white-space: pre-wrap;
            font-size: 0.875rem;
            line-height: 1.5;
        }

        .text-page {
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px dashed var(--color-gray-300);
            max-width: 100%;
            overflow-wrap: break-word;
        }

        .text-page-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--color-primary);
        }

        /* Estilos para seleção de páginas */
        .page-preview.excluded {
            opacity: 0.5;
            filter: grayscale(100%);
        }
    </style>
</head>
<body class="converter-text">
    <div class="function-container">
        <!-- Área de Upload -->
        <div class="card upload-area">
            <div class="card-header">
                <h2 class="card-title">
                    <i class="fas fa-file-alt"></i> Extrair Texto de PDF
                </h2>
            </div>
            <div class="card-body">
                <div class="drop-zone" id="dropZone">
                    <div class="drop-zone-content">
                        <i class="fas fa-file-pdf upload-icon"></i>
                        <div class="upload-text">Selecione ou Arraste o arquivo PDF</div>                        
                        <input type="file" id="pdfInput" accept="application/pdf,.pdf" class="hidden">
                    </div>
                </div>
                <div id="fileInfo" class="mt-3"></div>
            </div>
        </div>

        <!-- Painel de Controle - Inicialmente Escondido -->
        <div class="card hidden" id="controlPanel">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-cog"></i> Configuração de Extração
                </h3>
            </div>
            <div class="card-body">
                <div class="settings-panel">
                    <button id="extractButton" class="pdf-action-button">
                        <i class="fas fa-file-alt"></i>
                        Extrair Texto do PDF
                    </button>
                </div>

                <div id="status" class="hidden status-message"></div>
                <div id="compressionInfo" class="hidden compression-info"></div>
                <progress id="progressBar" value="0" max="100" class="hidden w-full"></progress>

                <div id="buttonContainer" class="hidden">
                    <a id="downloadButton" href="#" class="download-link" download>
                        <i class="fas fa-download"></i>
                        Baixar Texto Extraído (TXT)
                    </a>
                </div>
            </div>
        </div>

        <!-- Container de Páginas - Inicialmente Escondido -->
        <div class="card hidden" id="previewContainer">
            <div class="card-header">
                <h2 class="card-title">
                    <i class="fas fa-eye"></i>
                    Pré-visualização das Páginas
                </h2>
            </div>
            <div class="card-body">
                <div id="pdfPreviewGrid" class="pdf-preview-grid"></div>
            </div>
        </div>

        <!-- Container de Resultado do Texto -->
        <div class="card hidden" id="textResultContainer">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-file-alt"></i> Texto Extraído
                </h3>
            </div>
            <div class="card-body">
                <div id="textContent" class="text-preview-container"></div>
                
                <div class="button-container mt-4">
                    <button id="copyTextButton" class="pdf-action-button" style="background-color: var(--color-primary-light); color: var(--color-primary);">
                        <i class="fas fa-copy"></i>
                        Copiar Todo o Texto
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="processing-overlay" id="processingOverlay">
        <div class="processing-message">
            <i class="fas fa-spinner fa-spin fa-2x"></i>
            <p class="mt-3" id="processingText">Processando PDF...</p>
        </div>
    </div>

    <script>
        // Configuração inicial do PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        
        document.addEventListener('DOMContentLoaded', function() {
            // Elementos do DOM
            const dropZone = document.getElementById('dropZone');
            const pdfInput = document.getElementById('pdfInput');
            const fileInfo = document.getElementById('fileInfo');
            const controlPanel = document.getElementById('controlPanel');
            const previewContainer = document.getElementById('previewContainer');
            const pdfPreviewGrid = document.getElementById('pdfPreviewGrid');
            const extractButton = document.getElementById('extractButton');
            const processingOverlay = document.getElementById('processingOverlay');
            const processingText = document.getElementById('processingText');
            const textResultContainer = document.getElementById('textResultContainer');
            const textContent = document.getElementById('textContent');
            const copyTextButton = document.getElementById('copyTextButton');
            const downloadButton = document.getElementById('downloadButton');
            const buttonContainer = document.getElementById('buttonContainer');
            const compressionInfo = document.getElementById('compressionInfo');
            
            // Variáveis globais
            let currentPdfFile = null;
            let pdfDoc = null;
            let totalPages = 0;
            let excludedPages = new Set();
            let extractedText = "";
            let pageContainers = []; // ✅ Array para armazenar containers
            let currentGridPage = 0;
            let totalGridPages = 0;
            const THUMBNAILS_PER_PAGE = 30;
            
            // Função para resetar estado
            function resetState() {
                currentPdfFile = null;
                pdfDoc = null;
                totalPages = 0;
                excludedPages.clear();
                extractedText = "";
                pageContainers = []; // ✅ Limpar array
                currentGridPage = 0;
                totalGridPages = 0;
                
                // Esconder elementos
                controlPanel.classList.add('hidden');
                previewContainer.classList.add('hidden');
                textResultContainer.classList.add('hidden');
                buttonContainer.classList.add('hidden');
                compressionInfo.classList.add('hidden');
                
                // Limpar conteúdo
                fileInfo.innerHTML = '';
                pdfPreviewGrid.innerHTML = '';
                textContent.innerHTML = '';
                
                // Reset input
                pdfInput.value = '';
            }
            
            // Função para mostrar processamento
            function showProcessing(show, message = 'Processando PDF...') {
                processingText.textContent = message;
                processingOverlay.style.display = show ? 'flex' : 'none';
            }
            
            // Função para mostrar erro
            function showError(message) {
                fileInfo.innerHTML = `
                    <div class="status-message error">
                        <i class="fas fa-exclamation-circle"></i>
                        ${message}
                    </div>`;
                showProcessing(false);
            }
            
            // Função para validar PDF
            async function validatePDF(file) {
                // Verificar tipo MIME
                if (file.type === 'application/pdf') return true;
                
                // Verificar extensão
                if (file.name.toLowerCase().endsWith('.pdf')) return true;
                
                // Verificar assinatura %PDF
                try {
                    const reader = new FileReader();
                    const headerPromise = new Promise((resolve, reject) => {
                        reader.onload = () => {
                            const arrayBuffer = reader.result;
                            const bytes = new Uint8Array(arrayBuffer).slice(0, 10);
                            const header = new TextDecoder('utf-8').decode(bytes);
                            resolve(header);
                        };
                        reader.onerror = reject;
                    });
                    
                    reader.readAsArrayBuffer(file.slice(0, 10));
                    const header = await headerPromise;
                    
                    if (header.includes('%PDF')) return true;
                    
                    // Validar com PDF.js
                    const arrayBuffer = await file.arrayBuffer();
                    const pdf = await pdfjsLib.getDocument({data: new Uint8Array(arrayBuffer)}).promise;
                    return pdf.numPages > 0;
                } catch (error) {
                    return false;
                }
            }
            
            // Função para processar arquivo
            async function handleFile(file) {
                if (!file) return;
                
                resetState();
                showProcessing(true, 'Verificando arquivo...');
                
                try {
                    const isValidPDF = await validatePDF(file);
                    
                    if (!isValidPDF) {
                        showError('Por favor, selecione um arquivo PDF válido');
                        return;
                    }
                    
                    await processValidFile(file);
                } catch (error) {
                    console.error('Erro ao processar arquivo:', error);
                    showError(`Erro ao validar arquivo: ${error.message}`);
                }
            }
            
            // Função para processar PDF válido
            async function processValidFile(file) {
                try {
                    showProcessing(true, 'Carregando PDF...');
                    
                    currentPdfFile = file;
                    
                    // Carregar PDF
                    const arrayBuffer = await file.arrayBuffer();
                    pdfDoc = await pdfjsLib.getDocument({
                        data: new Uint8Array(arrayBuffer),
                        cMapUrl: 'https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/cmaps/',
                        cMapPacked: true
                    }).promise;
                    
                    totalPages = pdfDoc.numPages;
                    
                    if (totalPages === 0) {
                        throw new Error('O PDF não contém páginas.');
                    }
                    
                    // Mostrar informações do arquivo
                    const fileSizeMB = (file.size / (1024 * 1024)).toFixed(2);
                    fileInfo.innerHTML = `
                        <div class="info-block">
                            <div class="info-line">
                                <i class="fas fa-check-circle"></i>
                                Arquivo Selecionado: ${file.name}
                            </div>
                            <div class="info-line">
                                <i class="fas fa-check-circle"></i>
                                Tamanho: ${fileSizeMB} MB
                            </div>
                            <div class="info-line">
                                <i class="fas fa-check-circle"></i>
                                Quantidade de páginas: ${totalPages}
                            </div>
                        </div>`;
                    
                    // Renderizar thumbnails
                    await renderThumbnails();
                    
                    // Mostrar controles e preview
                    controlPanel.classList.remove('hidden');
                    previewContainer.classList.remove('hidden');
                    
                    showProcessing(false);
                    
                } catch (error) {
                    console.error('Erro ao processar PDF:', error);
                    showError(`Erro ao processar PDF: ${error.message}`);
                }
            }
            
            // Função para renderizar thumbnails (CORRIGIDO - igual extrair_imagens.html)
            async function renderThumbnails() {
                pdfPreviewGrid.innerHTML = '';
                pageContainers = new Array(totalPages); // ✅ Inicializar array
                
                try {
                    // ✅ PRIMEIRO: Renderizar TODAS as páginas e armazenar
                    for (let pageNum = 1; pageNum <= totalPages; pageNum++) {
                        processingText.textContent = `Carregando páginas... ${pageNum}/${totalPages}`;
                        
                        const page = await pdfDoc.getPage(pageNum);
                        const viewport = page.getViewport({ scale: 0.8 }); // ✅ Escala igual ao extrair_imagens
                        
                        const canvas = document.createElement('canvas');
                        const context = canvas.getContext('2d');
                        canvas.height = viewport.height;
                        canvas.width = viewport.width;
                        
                        // Fundo branco
                        context.fillStyle = 'white';
                        context.fillRect(0, 0, canvas.width, canvas.height);
                        
                        await page.render({
                            canvasContext: context,
                            viewport: viewport
                        }).promise;
                        
                        // ✅ Criar container da página (igual extrair_imagens.html)
                        const pageContainer = document.createElement('div');
                        pageContainer.className = 'page-preview'; // ✅ Classe correta
                        pageContainer.dataset.page = pageNum;
                        
                        // ✅ Evento de clique para toggle
                        pageContainer.addEventListener('click', () => {
                            if (excludedPages.has(pageNum)) {
                                excludedPages.delete(pageNum);
                                pageContainer.classList.remove('excluded');
                            } else {
                                excludedPages.add(pageNum);
                                pageContainer.classList.add('excluded');
                            }
                        });
                        
                        // ✅ Adicionar canvas direto (não IMG)
                        canvas.className = 'image-preview'; // ✅ Classe correta
                        pageContainer.appendChild(canvas);
                        
                        // ✅ Número da página
                        const pageNumber = document.createElement('div');
                        pageNumber.className = 'page-number'; // ✅ Classe correta
                        pageNumber.textContent = `Página ${pageNum}`;
                        pageContainer.appendChild(pageNumber);
                        
                        // ✅ ARMAZENAR no array (não adicionar ao DOM ainda)
                        pageContainers[pageNum - 1] = pageContainer;
                    }
                    
                    // ✅ SEGUNDO: Calcular paginação
                    totalGridPages = Math.ceil(totalPages / THUMBNAILS_PER_PAGE);
                    
                    // ✅ TERCEIRO: Renderizar primeira página do grid
                    currentGridPage = 0;
                    renderGridPage(currentGridPage);
                    
                } catch (error) {
                    console.error('Erro ao renderizar thumbnails:', error);
                    showError(`Erro ao gerar visualização: ${error.message}`);
                }
            }
            
            // ✅ Função para renderizar uma página específica do grid
            function renderGridPage(pageIndex) {
                pdfPreviewGrid.innerHTML = '';
                
                // Calcular índices
                const startIndex = pageIndex * THUMBNAILS_PER_PAGE;
                const endIndex = Math.min(startIndex + THUMBNAILS_PER_PAGE, pageContainers.length);
                
                // ✅ Adicionar containers ao grid
                for (let i = startIndex; i < endIndex; i++) {
                    if (pageContainers[i]) {
                        pdfPreviewGrid.appendChild(pageContainers[i]);
                    }
                }
            }
            
            // Função para extrair texto
            async function extractText() {
                if (!currentPdfFile) return;
                
                showProcessing(true, 'Extraindo texto...');
                
                try {
                    const formData = new FormData();
                    formData.append('file', currentPdfFile);
                    
                    // Adicionar páginas a manter se houver exclusões
                    if (excludedPages.size > 0) {
                        const pagesToKeep = Array.from(
                            { length: totalPages },
                            (_, i) => i
                        ).filter(pageNum => !excludedPages.has(pageNum + 1));
                        
                        formData.append('pages_to_keep', JSON.stringify(pagesToKeep));
                    }
                    
                    const response = await fetch('pdf_to_text.php', {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.message || 'Erro ao extrair texto');
                    }
                    
                    const data = await response.json();
                    displayExtractedText(data);
                    
                } catch (error) {
                    console.error('Erro na extração:', error);
                    showError(`Erro ao extrair texto: ${error.message}`);
                } finally {
                    showProcessing(false);
                }
            }
            
            // Função para exibir texto extraído
            function displayExtractedText(data) {
                textContent.innerHTML = '';
                let fullText = "";
                
                // Processar diferentes formatos de resposta
                if (data && data.pages_text && Array.isArray(data.pages_text)) {
                    data.pages_text.forEach(page => {
                        const pageElement = document.createElement('div');
                        pageElement.className = 'text-page';
                        
                        const pageTitle = document.createElement('div');
                        pageTitle.className = 'text-page-title';
                        pageTitle.textContent = `Página ${page.page}`;
                        
                        const pageContent = document.createElement('div');
                        pageContent.textContent = page.text;
                        
                        pageElement.appendChild(pageTitle);
                        pageElement.appendChild(pageContent);
                        textContent.appendChild(pageElement);
                        
                        fullText += `--- Página ${page.page} ---\n${page.text}\n\n`;
                    });
                } else if (data && data.text && Array.isArray(data.text)) {
                    data.text.forEach(page => {
                        const pageElement = document.createElement('div');
                        pageElement.className = 'text-page';
                        
                        const pageTitle = document.createElement('div');
                        pageTitle.className = 'text-page-title';
                        pageTitle.textContent = `Página ${page.page}`;
                        
                        const pageContent = document.createElement('div');
                        pageContent.textContent = page.content;
                        
                        pageElement.appendChild(pageTitle);
                        pageElement.appendChild(pageContent);
                        textContent.appendChild(pageElement);
                        
                        fullText += `--- Página ${page.page} ---\n${page.content}\n\n`;
                    });
                } else if (data && data.full_text) {
                    fullText = data.full_text;
                    const singlePage = document.createElement('div');
                    singlePage.className = 'text-page';
                    singlePage.style.whiteSpace = 'pre-wrap';
                    singlePage.textContent = data.full_text;
                    textContent.appendChild(singlePage);
                } else {
                    let extractedContent = '';
                    if (typeof data.text === 'string') {
                        extractedContent = data.text;
                    } else if (data.content) {
                        extractedContent = data.content;
                    } else {
                        extractedContent = JSON.stringify(data, null, 2);
                    }
                    
                    const singlePage = document.createElement('div');
                    singlePage.className = 'text-page';
                    singlePage.textContent = extractedContent;
                    textContent.appendChild(singlePage);
                    fullText = extractedContent;
                }
                
                extractedText = fullText;
                
                // Preparar download
                const blob = new Blob([fullText], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                downloadButton.href = url;
                downloadButton.download = currentPdfFile.name.replace('.pdf', '.txt');
                
                // Mostrar resultado
                textResultContainer.classList.remove('hidden');
                buttonContainer.classList.remove('hidden');
                
                // Mostrar info de sucesso
                let totalPagesProcessed = totalPages - excludedPages.size;
                const pageText = totalPagesProcessed === 1 ? "página" : "páginas";
                
                compressionInfo.innerHTML = `
                    <div class="status-message success">
                        <i class="fas fa-check-circle"></i>
                        <div>
                            <strong>Extração concluída com sucesso!</strong>
                            <div class="mt-2">
                                Texto extraído de ${totalPagesProcessed} ${pageText}
                            </div>
                        </div>
                    </div>`;
                compressionInfo.classList.remove('hidden');
            }
            
            // Event Listeners
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                }, false);
            });
            
            ['dragenter', 'dragover'].forEach(eventName => {
                dropZone.addEventListener(eventName, () => {
                    dropZone.classList.add('drag-over');
                });
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, () => {
                    dropZone.classList.remove('drag-over');
                });
            });
            
            dropZone.addEventListener('drop', function(e) {
                const file = e.dataTransfer.files[0];
                handleFile(file);
            });
            
            dropZone.addEventListener('click', function() {
                resetState();
                pdfInput.click();
            });
            
            pdfInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                handleFile(file);
            });
            
            extractButton.addEventListener('click', extractText);
            
            copyTextButton.addEventListener('click', () => {
                if (extractedText) {
                    navigator.clipboard.writeText(extractedText).then(() => {
                        const originalText = copyTextButton.innerHTML;
                        copyTextButton.innerHTML = '<i class="fas fa-check"></i> Texto Copiado!';
                        setTimeout(() => {
                            copyTextButton.innerHTML = originalText;
                        }, 2000);
                    }).catch(err => {
                        console.error('Erro ao copiar texto: ', err);
                    });
                }
            });
            
            // Limpeza
            window.addEventListener('beforeunload', () => {
                if (downloadButton.href && downloadButton.href !== '#') {
                    URL.revokeObjectURL(downloadButton.href);
                }
            });
        });
    </script>
</body>
</html>