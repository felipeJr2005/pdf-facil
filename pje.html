<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Extrator de PDF com Mozilla PDF.js</title>
    <style>
        body { font-family: sans-serif; margin: 20px; }
        input { width: 100%; padding: 5px; margin-bottom: 10px; }
        button { padding: 5px 10px; margin-right: 5px; }
        pre { border: 1px solid #ccc; padding: 10px; max-height: 300px; overflow: auto; }
        .log { font-family: monospace; font-size: 12px; }
        #pdf-frame { width: 100%; height: 600px; border: 1px solid #ccc; }
    </style>
</head>
<body>
    <h3>Extrator de PDF com Mozilla PDF.js</h3>
    
    <div>
        <input type="url" id="pdf-url" placeholder="Cole o link do PDF do PJe aqui">
        <div>
            <button id="btn-view-mozilla">Abrir no Visualizador Mozilla</button>
            <button id="btn-capture">Tentar Capturar Texto</button>
        </div>
    </div>
    
    <div style="margin-top: 15px;">
        <iframe id="pdf-frame" allowfullscreen></iframe>
    </div>
    
    <h4>Texto Extraído:</h4>
    <pre id="result"></pre>
    
    <h4>Log:</h4>
    <div id="log" class="log"></div>
    
    <script>
        // Elementos DOM
        const urlInput = document.getElementById('pdf-url');
        const btnViewMozilla = document.getElementById('btn-view-mozilla');
        const btnCapture = document.getElementById('btn-capture');
        const pdfFrame = document.getElementById('pdf-frame');
        const result = document.getElementById('result');
        const logElement = document.getElementById('log');
        
        // Eventos
        btnViewMozilla.addEventListener('click', openInMozillaViewer);
        btnCapture.addEventListener('click', captureText);
        
        // Funções
        function log(message) {
            console.log(message);
            const timestamp = new Date().toLocaleTimeString();
            logElement.innerHTML += `[${timestamp}] ${message}<br>`;
            logElement.scrollTop = logElement.scrollHeight;
        }
        
        function openInMozillaViewer() {
            const url = urlInput.value.trim();
            if (!url) {
                log('Digite uma URL válida');
                return;
            }
            
            // URL do visualizador Mozilla PDF.js
            const viewerUrl = `https://mozilla.github.io/pdf.js/web/viewer.html?file=${encodeURIComponent(url)}`;
            
            log(`Abrindo PDF no visualizador Mozilla: ${url}`);
            pdfFrame.src = viewerUrl;
        }
        
        function captureText() {
            log('Tentando capturar texto do visualizador...');
            
            try {
                // Tentar acessar o iframe
                const frameWindow = pdfFrame.contentWindow;
                const frameDocument = frameWindow.document;
                
                // Tentar método 1: Usar API do PDF.js
                if (frameWindow.PDFViewerApplication) {
                    log('PDF.js API detectada, tentando extrair texto...');
                    
                    const pdfViewer = frameWindow.PDFViewerApplication.pdfViewer;
                    const currentPageNumber = pdfViewer.currentPageNumber;
                    const pageCount = pdfViewer.pagesCount;
                    
                    log(`PDF tem ${pageCount} páginas, página atual: ${currentPageNumber}`);
                    
                    // Tentar acessar o texto
                    const textContent = frameDocument.querySelector('.textLayer');
                    if (textContent) {
                        const text = textContent.innerText;
                        result.textContent = text;
                        log('Texto extraído da camada de texto');
                        return;
                    }
                }
                
                // Método 2: Capturar divs da camada de texto
                const textDivs = frameDocument.querySelectorAll('.textLayer div');
                if (textDivs && textDivs.length > 0) {
                    log(`Encontradas ${textDivs.length} divs de texto`);
                    
                    let text = '';
                    textDivs.forEach(div => {
                        text += div.textContent + ' ';
                    });
                    
                    result.textContent = text;
                    log('Texto extraído das divs da camada de texto');
                    return;
                }
                
                // Método 3: Buscar texto em qualquer lugar
                const bodyText = frameDocument.body.innerText;
                if (bodyText) {
                    // Filtrar texto da UI do visualizador
                    const lines = bodyText.split('\n').filter(line => 
                        !line.includes('of') && 
                        !line.includes('Page') && 
                        line.trim().length > 0
                    );
                    
                    result.textContent = lines.join('\n');
                    log('Texto extraído do corpo do documento');
                    return;
                }
                
                throw new Error('Não foi possível encontrar texto no visualizador');
                
            } catch (error) {
                log(`Erro ao capturar texto: ${error.message}`);
                
                if (error.message.includes('cross-origin') || error.message.includes('security')) {
                    log('Erro de segurança cross-origin detectado');
                    
                    // Sugerir método manual
                    result.textContent = `
Não foi possível extrair o texto automaticamente devido a restrições de segurança.

Como alternativa, você pode usar o visualizador Mozilla que está aberto:
1. Clique no ícone de seleção de texto (ícone com cursor de texto)
2. Selecione o texto que deseja copiar
3. Use Ctrl+C para copiar e cole aqui`;
                }
            }
        }
        
        // Carregar URL da última sessão
        const savedUrl = localStorage.getItem('pje-pdf-url');
        if (savedUrl) {
            urlInput.value = savedUrl;
            log('URL carregada da sessão anterior');
        }
        
        // Salvar URL ao digitar
        urlInput.addEventListener('input', () => {
            localStorage.setItem('pje-pdf-url', urlInput.value);
        });
        
        log('Extrator com visualizador Mozilla inicializado');
    </script>
</body>
</html>