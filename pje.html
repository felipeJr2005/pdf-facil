<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Extrator de Texto do PJe</title>
    <style>
        body { font-family: sans-serif; margin: 20px; }
        input { width: 100%; padding: 5px; margin-bottom: 10px; }
        button { padding: 5px 10px; margin-right: 5px; }
        pre { border: 1px solid #ccc; padding: 10px; max-height: 300px; overflow: auto; }
        .log { font-family: monospace; font-size: 12px; }
    </style>
</head>
<body>
    <h3>Extrator de Texto do PJe</h3>
    
    <div>
        <input type="url" id="pdf-url" placeholder="Cole o link do PDF do PJe aqui">
        <div>
            <button id="btn-view">Abrir PDF</button>
            <button id="btn-download">Baixar PDF</button>
            <button id="btn-extract">Extrair com Fetch</button>
            <button id="btn-xhr">Extrair com XHR</button>
        </div>
    </div>
    
    <div id="pdf-container" style="display:none; margin-top: 15px;">
        <iframe id="pdf-iframe" width="100%" height="400" style="border:1px solid #ccc;"></iframe>
    </div>
    
    <h4>Texto Extraído:</h4>
    <pre id="result"></pre>
    
    <h4>Log:</h4>
    <div id="log" class="log"></div>
    
    <script>
        // Elementos
        const urlInput = document.getElementById('pdf-url');
        const btnView = document.getElementById('btn-view');
        const btnDownload = document.getElementById('btn-download');
        const btnExtract = document.getElementById('btn-extract');
        const btnXhr = document.getElementById('btn-xhr');
        const pdfContainer = document.getElementById('pdf-container');
        const pdfIframe = document.getElementById('pdf-iframe');
        const result = document.getElementById('result');
        const logElement = document.getElementById('log');
        
        // Carregar PDF.js
        let pdfJsLoaded = false;
        
        // Eventos
        btnView.addEventListener('click', viewPdf);
        btnDownload.addEventListener('click', downloadPdf);
        btnExtract.addEventListener('click', extractWithFetch);
        btnXhr.addEventListener('click', extractWithXhr);
        
        // Funções
        function log(message) {
            console.log(message);
            logElement.innerHTML += message + '<br>';
            logElement.scrollTop = logElement.scrollHeight;
        }
        
        function viewPdf() {
            const url = urlInput.value.trim();
            if (!url) {
                log('Digite uma URL válida');
                return;
            }
            
            pdfIframe.src = url;
            pdfContainer.style.display = 'block';
            log(`PDF aberto: ${url}`);
        }
        
        function downloadPdf() {
            const url = urlInput.value.trim();
            if (!url) {
                log('Digite uma URL válida');
                return;
            }
            
            // Abrir em nova janela para download
            window.open(url, '_blank');
            log('PDF aberto em nova janela para download');
        }
        
        // Método 1: Extrair com Fetch API
        async function extractWithFetch() {
            const url = urlInput.value.trim();
            if (!url) {
                log('Digite uma URL válida');
                return;
            }
            
            log(`Tentando extrair texto com Fetch: ${url}`);
            result.textContent = 'Processando...';
            
            try {
                // Tentar com credenciais incluídas
                const response = await fetch(url, {
                    credentials: 'include',
                    mode: 'cors',
                    headers: {
                        'Accept': 'application/pdf,*/*'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`Erro HTTP: ${response.status}`);
                }
                
                const pdfData = await response.arrayBuffer();
                log(`PDF obtido: ${pdfData.byteLength} bytes`);
                
                // Carregar PDF.js se necessário
                if (!pdfJsLoaded) {
                    await loadPdfJs();
                }
                
                // Extrair texto
                const text = await extractTextFromPdf(pdfData);
                result.textContent = text;
                log('Texto extraído com sucesso');
                
            } catch (error) {
                log(`Erro: ${error.message}`);
                result.textContent = `Erro: ${error.message}`;
            }
        }
        
        // Método 2: Extrair com XMLHttpRequest
        function extractWithXhr() {
            const url = urlInput.value.trim();
            if (!url) {
                log('Digite uma URL válida');
                return;
            }
            
            log(`Tentando extrair texto com XHR: ${url}`);
            result.textContent = 'Processando...';
            
            const xhr = new XMLHttpRequest();
            xhr.open('GET', url, true);
            xhr.responseType = 'arraybuffer';
            xhr.withCredentials = true;
            
            xhr.onload = async function() {
                if (this.status >= 200 && this.status < 300) {
                    try {
                        log(`PDF obtido: ${xhr.response.byteLength} bytes`);
                        
                        // Carregar PDF.js se necessário
                        if (!pdfJsLoaded) {
                            await loadPdfJs();
                        }
                        
                        // Extrair texto
                        const text = await extractTextFromPdf(xhr.response);
                        result.textContent = text;
                        log('Texto extraído com sucesso');
                        
                    } catch (error) {
                        log(`Erro ao processar PDF: ${error.message}`);
                        result.textContent = `Erro: ${error.message}`;
                    }
                } else {
                    log(`Erro HTTP: ${this.status}`);
                    result.textContent = `Erro HTTP: ${this.status}`;
                }
            };
            
            xhr.onerror = function() {
                log('Erro de rede ao buscar o PDF');
                result.textContent = 'Erro de rede ao buscar o PDF';
            };
            
            xhr.send();
        }
        
        // Carregar PDF.js
        async function loadPdfJs() {
            log('Carregando PDF.js...');
            
            return new Promise((resolve, reject) => {
                // Carregar script principal
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/pdfjs-dist@3.4.120/build/pdf.min.js';
                script.onload = function() {
                    // Configurar worker
                    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdn.jsdelivr.net/npm/pdfjs-dist@3.4.120/build/pdf.worker.min.js';
                    pdfJsLoaded = true;
                    log('PDF.js carregado com sucesso');
                    resolve();
                };
                script.onerror = function() {
                    reject(new Error('Erro ao carregar PDF.js'));
                };
                document.head.appendChild(script);
            });
        }
        
        // Extrair texto do PDF
        async function extractTextFromPdf(arrayBuffer) {
            const loadingTask = pdfjsLib.getDocument({data: new Uint8Array(arrayBuffer)});
            const pdf = await loadingTask.promise;
            
            log(`PDF carregado: ${pdf.numPages} página(s)`);
            
            let fullText = '';
            
            // Processar cada página
            for (let i = 1; i <= pdf.numPages; i++) {
                log(`Processando página ${i}...`);
                const page = await pdf.getPage(i);
                const textContent = await page.getTextContent();
                
                // Extrair texto dos itens
                const pageText = textContent.items
                    .map(item => item.str)
                    .join(' ');
                
                fullText += `--- Página ${i} ---\n${pageText}\n\n`;
            }
            
            return fullText;
        }
        
        // Carregar URL da última sessão
        const savedUrl = localStorage.getItem('pje-pdf-url');
        if (savedUrl) {
            urlInput.value = savedUrl;
            log('URL carregada da sessão anterior');
        }
        
        // Salvar URL ao digitar
        urlInput.addEventListener('input', () => {
            localStorage.setItem('pje-pdf-url', urlInput.value);
        });
        
        log('Extrator de texto do PJe inicializado');
    </script>
</body>
</html>