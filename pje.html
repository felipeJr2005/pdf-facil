<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>PJe PDF Interceptor</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .panel { border: 1px solid #ddd; margin-bottom: 20px; padding: 15px; }
        .form-control { width: 100%; padding: 8px; margin-bottom: 10px; box-sizing: border-box; }
        .btn { padding: 8px 15px; margin-right: 10px; cursor: pointer; }
        .btn-primary { background: #007bff; color: white; border: none; }
        #pdf-viewer { width: 100%; height: 500px; border: 1px solid #ddd; }
        #log { background: #f8f9fa; padding: 10px; height: 200px; overflow-y: auto; font-family: monospace; font-size: 12px; white-space: pre-wrap; }
        .success { color: green; font-weight: bold; }
        .error { color: red; font-weight: bold; }
        .info { color: blue; }
    </style>
</head>
<body>
    <h2>PJe PDF Interceptor - Teste de Captura</h2>
    
    <div class="panel">
        <h3>1. URL do PJe</h3>
        <input type="url" id="pdf-url" class="form-control" placeholder="Cole o link do PDF do PJe aqui" value="https://pje.cloud.tjpe.jus.br/1g/seam/resource/rest/pje-legacy/documento/download/137195928">
        <button id="btn-load" class="btn btn-primary">Carregar PJe</button>
        <button id="btn-start-intercept" class="btn btn-primary">üïµÔ∏è Ativar Intercepta√ß√£o</button>
        <button id="btn-clear-log" class="btn">Limpar Log</button>
    </div>
    
    <div class="panel">
        <h3>2. PJe Iframe</h3>
        <iframe id="pdf-viewer"></iframe>
    </div>
    
    <div class="panel">
        <h3>3. Log de Intercepta√ß√£o</h3>
        <div id="log">Aguardando intercepta√ß√£o...</div>
    </div>

    <script>
        const urlInput = document.getElementById('pdf-url');
        const btnLoad = document.getElementById('btn-load');
        const btnIntercept = document.getElementById('btn-start-intercept');
        const btnClearLog = document.getElementById('btn-clear-log');
        const pdfViewer = document.getElementById('pdf-viewer');
        const logDiv = document.getElementById('log');
        
        let interceptActive = false;
        let capturedPdf = null;
        
        // Fun√ß√£o de log
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'success' ? 'success' : type === 'error' ? 'error' : 'info';
            logDiv.innerHTML += `[${timestamp}] <span class="${className}">${message}</span>\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${timestamp}] ${message}`);
        }
        
        // Carregar PJe
        btnLoad.addEventListener('click', function() {
            const url = urlInput.value.trim();
            if (!url) {
                log('‚ùå URL n√£o informada', 'error');
                return;
            }
            
            log('üîÑ Carregando PJe no iframe...', 'info');
            pdfViewer.src = url;
            
            pdfViewer.onload = function() {
                log('‚úÖ PJe carregado no iframe', 'success');
                log('üí° Fa√ßa login e prepare para clicar no bot√£o roxo', 'info');
            };
            
            pdfViewer.onerror = function() {
                log('‚ùå Erro ao carregar PJe no iframe', 'error');
            };
        });
        
        // Ativar intercepta√ß√£o
        btnIntercept.addEventListener('click', function() {
            if (interceptActive) {
                log('‚ö†Ô∏è Intercepta√ß√£o j√° est√° ativa', 'info');
                return;
            }
            
            interceptActive = true;
            log('üïµÔ∏è Ativando intercepta√ß√£o de downloads...', 'info');
            setupInterception();
            btnIntercept.textContent = '‚úÖ Intercepta√ß√£o Ativa';
            btnIntercept.disabled = true;
        });
        
        // Limpar log
        btnClearLog.addEventListener('click', function() {
            logDiv.innerHTML = 'Log limpo...\n';
        });
        
        // Setup da intercepta√ß√£o
        function setupInterception() {
            log('üîß Configurando intercepta√ß√£o de fetch/XMLHttpRequest...', 'info');
            
            // Interceptar fetch
            const originalFetch = window.fetch;
            window.fetch = function(...args) {
                const url = args[0];
                
                if (typeof url === 'string') {
                    log(`üîç Fetch detectado: ${url.substring(0, 100)}...`, 'info');
                    
                    // URLs que nos interessam
                    const isPjeDownload = url.includes('pje.cloud.tjpe.jus.br') && url.includes('documento/download');
                    const isMinioUrl = url.includes('docs-1g-minio-api.pje.cloud.tjpe.jus.br');
                    const isAwsSignedUrl = url.includes('X-Amz-Algorithm');
                    
                    if (isPjeDownload || isMinioUrl || isAwsSignedUrl) {
                        log(`üéØ URL PJe interceptada!`, 'success');
                        log(`üìã URL: ${url.substring(0, 150)}...`, 'info');
                        
                        return originalFetch.apply(this, args)
                            .then(response => {
                                log(`üìÑ Resposta recebida: Status ${response.status}`, 'info');
                                
                                if (response.ok) {
                                    const contentType = response.headers.get('content-type') || '';
                                    const contentDisposition = response.headers.get('content-disposition') || '';
                                    
                                    log(`üìÑ Content-Type: ${contentType}`, 'info');
                                    log(`üìé Content-Disposition: ${contentDisposition}`, 'info');
                                    
                                    // Se √© PDF ou conte√∫do baix√°vel
                                    if (contentType.includes('application/pdf') || 
                                        contentType.includes('application/octet-stream') ||
                                        isMinioUrl || isAwsSignedUrl) {
                                        
                                        log('üéâ PDF DETECTADO! Capturando...', 'success');
                                        
                                        // Clonar resposta para capturar
                                        const clonedResponse = response.clone();
                                        clonedResponse.blob().then(blob => {
                                            log(`üíæ PDF capturado! Tamanho: ${blob.size} bytes`, 'success');
                                            
                                            // Salvar PDF capturado
                                            capturedPdf = blob;
                                            
                                            // Verificar se √© realmente PDF
                                            const reader = new FileReader();
                                            reader.onload = function(e) {
                                                const arrayBuffer = e.target.result;
                                                const bytes = new Uint8Array(arrayBuffer.slice(0, 4));
                                                const header = String.fromCharCode(...bytes);
                                                
                                                if (header === '%PDF') {
                                                    log('‚úÖ CONFIRMADO: √â um PDF v√°lido!', 'success');
                                                    log('üéØ CAPTURA REALIZADA COM SUCESSO!', 'success');
                                                    
                                                    // Aqui podemos adicionar o OCR depois
                                                    log('üí° Pr√≥ximo passo: implementar OCR...', 'info');
                                                } else {
                                                    log(`‚ö†Ô∏è Header n√£o √© PDF: ${header}`, 'error');
                                                }
                                            };
                                            reader.readAsArrayBuffer(blob.slice(0, 10));
                                            
                                        }).catch(err => {
                                            log(`‚ùå Erro ao capturar blob: ${err.message}`, 'error');
                                        });
                                    }
                                } else {
                                    log(`‚ùå Resposta com erro: ${response.status} - ${response.statusText}`, 'error');
                                }
                                
                                return response;
                            })
                            .catch(error => {
                                log(`‚ùå Erro na intercepta√ß√£o: ${error.message}`, 'error');
                                return Promise.reject(error);
                            });
                    }
                }
                
                return originalFetch.apply(this, args);
            };
            
            // Interceptar XMLHttpRequest
            const originalXHR = window.XMLHttpRequest;
            window.XMLHttpRequest = function() {
                const xhr = new originalXHR();
                const originalOpen = xhr.open;
                
                xhr.open = function(method, url, ...args) {
                    if (typeof url === 'string' && (
                        url.includes('documento/download') || 
                        url.includes('docs-1g-minio-api') ||
                        url.includes('X-Amz-Algorithm')
                    )) {
                        log(`üîç XHR interceptado: ${url.substring(0, 100)}...`, 'info');
                        
                        xhr.addEventListener('load', function() {
                            if (xhr.status === 200) {
                                log('üéâ XHR PDF detectado!', 'success');
                                
                                if (xhr.response instanceof Blob) {
                                    log(`üíæ PDF XHR capturado! Tamanho: ${xhr.response.size} bytes`, 'success');
                                    capturedPdf = xhr.response;
                                } else if (xhr.responseType === 'arraybuffer') {
                                    const blob = new Blob([xhr.response], {type: 'application/pdf'});
                                    log(`üíæ PDF XHR (ArrayBuffer) capturado! Tamanho: ${blob.size} bytes`, 'success');
                                    capturedPdf = blob;
                                }
                            }
                        });
                    }
                    
                    return originalOpen.apply(this, [method, url, ...args]);
                };
                
                return xhr;
            };
            
            // Interceptar downloads diretos (elementos <a>)
            document.addEventListener('click', function(event) {
                const target = event.target.closest('a');
                if (target && target.href) {
                    const href = target.href;
                    
                    if (href.includes('download') || href.includes('documento') || 
                        href.includes('minio') || href.includes('.pdf')) {
                        log(`üñ±Ô∏è Click em link de download: ${href.substring(0, 100)}...`, 'info');
                    }
                }
            }, true);
            
            log('‚úÖ Intercepta√ß√£o ativa!', 'success');
            log('üéØ Monitorando: fetch, XHR, clicks em links', 'info');
            log('üí° Agora clique no bot√£o ROXO no PJe!', 'info');
        }
        
        // Auto-carregar URL se j√° estiver preenchida
        window.addEventListener('load', function() {
            if (urlInput.value.trim()) {
                log('üîÑ Auto-carregando URL...', 'info');
                btnLoad.click();
            }
        });
    </script>
</body>
</html>