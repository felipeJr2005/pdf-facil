<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Extrator de Texto de PDF Renderizado</title>
    <style>
        body { font-family: sans-serif; margin: 20px; }
        input { width: 100%; padding: 5px; margin-bottom: 10px; }
        button { padding: 5px 10px; margin-right: 5px; margin-bottom: 10px; }
        pre { border: 1px solid #ccc; padding: 10px; max-height: 300px; overflow: auto; }
        .log { font-family: monospace; font-size: 12px; }
        #pdf-iframe { border: 1px solid #ccc; }
    </style>
</head>
<body>
    <h3>Extrator de Texto de PDF Renderizado</h3>
    
    <div>
        <input type="url" id="pdf-url" placeholder="Cole o link do PDF do PJe aqui">
        <div>
            <button id="btn-view">Abrir PDF</button>
            <button id="btn-capture-rendered">Capturar Texto Renderizado</button>
        </div>
    </div>
    
    <div id="pdf-container" style="margin-top: 15px;">
        <iframe id="pdf-iframe" width="100%" height="500"></iframe>
    </div>
    
    <h4>Texto Extraído:</h4>
    <pre id="result"></pre>
    
    <h4>Log:</h4>
    <div id="log" class="log"></div>
    
    <script>
        // Elementos
        const urlInput = document.getElementById('pdf-url');
        const btnView = document.getElementById('btn-view');
        const btnCaptureRendered = document.getElementById('btn-capture-rendered');
        const pdfIframe = document.getElementById('pdf-iframe');
        const result = document.getElementById('result');
        const logElement = document.getElementById('log');
        
        // Eventos
        btnView.addEventListener('click', viewPdf);
        btnCaptureRendered.addEventListener('click', captureRenderedText);
        pdfIframe.addEventListener('load', onIframeLoad);
        
        // Inicialização
        let pdfLoaded = false;
        
        // Funções
        function log(message) {
            console.log(message);
            logElement.innerHTML += message + '<br>';
            logElement.scrollTop = logElement.scrollHeight;
        }
        
        function viewPdf() {
            const url = urlInput.value.trim();
            if (!url) {
                log('Digite uma URL válida');
                return;
            }
            
            pdfLoaded = false;
            log(`Abrindo PDF: ${url}`);
            
            // Tentar abrir o PDF com visualizador personalizado para facilitar extração
            const viewerUrl = `${getBaseUrl()}/web/viewer.html?file=${encodeURIComponent(url)}`;
            pdfIframe.src = viewerUrl;
            
            // Se falhar após 3 segundos, tentar método direto
            setTimeout(() => {
                if (!pdfLoaded) {
                    log('Tentando método de visualização direta...');
                    pdfIframe.src = url;
                }
            }, 3000);
        }
        
        function onIframeLoad() {
            pdfLoaded = true;
            log('PDF carregado no iframe');
            
            // Detectar se o visualizador PDF.js foi carregado
            try {
                const iframeDoc = pdfIframe.contentDocument || pdfIframe.contentWindow.document;
                if (iframeDoc && iframeDoc.querySelector('.textLayer')) {
                    log('Visualizador PDF.js detectado');
                }
            } catch (e) {
                log('Não foi possível acessar o conteúdo do iframe (restrições de segurança)');
            }
        }
        
        function captureRenderedText() {
            log('Tentando capturar texto renderizado...');
            
            try {
                // Tentar acessar o documento do iframe
                const iframeDoc = pdfIframe.contentDocument || pdfIframe.contentWindow.document;
                
                if (!iframeDoc) {
                    throw new Error('Não foi possível acessar o documento do iframe');
                }
                
                // Tentar método 1: Capturar texto da camada de texto do PDF.js
                const textLayerElements = iframeDoc.querySelectorAll('.textLayer div');
                if (textLayerElements && textLayerElements.length > 0) {
                    log(`Encontrados ${textLayerElements.length} elementos de texto`);
                    
                    let text = '';
                    textLayerElements.forEach(element => {
                        text += element.textContent + ' ';
                    });
                    
                    result.textContent = text;
                    log('Texto capturado com sucesso da camada de texto');
                    return;
                }
                
                // Tentar método 2: Capturar todo o texto visível
                const bodyText = iframeDoc.body.innerText;
                if (bodyText) {
                    result.textContent = bodyText;
                    log('Texto capturado do corpo do documento');
                    return;
                }
                
                // Tentar método 3: Capturar todos os nós de texto
                const textNodes = [];
                const walker = iframeDoc.createTreeWalker(
                    iframeDoc.body, 
                    NodeFilter.SHOW_TEXT,
                    null, 
                    false
                );
                
                let node;
                while (node = walker.nextNode()) {
                    if (node.textContent.trim()) {
                        textNodes.push(node.textContent.trim());
                    }
                }
                
                if (textNodes.length > 0) {
                    result.textContent = textNodes.join('\n');
                    log(`Capturados ${textNodes.length} nós de texto`);
                    return;
                }
                
                // Se chegamos aqui, não conseguimos extrair texto
                throw new Error('Nenhum texto encontrado no documento');
                
            } catch (error) {
                log(`Erro: ${error.message}`);
                
                // Sugerir alternativa
                const manualApproach = `
Não foi possível extrair o texto automaticamente devido a restrições de segurança.

Como alternativa, você pode:
1. Usar a ferramenta Copiar do visualizador de PDF (geralmente um ícone ou comando no menu de contexto)
2. Selecionar o texto manualmente e copiar (Ctrl+C)
3. Usar um leitor de PDF externo que permita cópia`;
                
                result.textContent = manualApproach;
            }
        }
        
        // Obter URL base para o PDF.js
        function getBaseUrl() {
            // Usar CDN público do PDF.js
            return 'https://mozilla.github.io/pdf.js';
        }
        
        // Carregar URL da última sessão
        const savedUrl = localStorage.getItem('pje-pdf-url');
        if (savedUrl) {
            urlInput.value = savedUrl;
            log('URL carregada da sessão anterior');
        }
        
        // Salvar URL ao digitar
        urlInput.addEventListener('input', () => {
            localStorage.setItem('pje-pdf-url', urlInput.value);
        });
        
        log('Extrator de texto de PDF renderizado inicializado');
    </script>
</body>
</html>