<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Extrator de PDF com Proxy CORS</title>
    <style>
        body { font-family: sans-serif; margin: 20px; }
        input { width: 100%; padding: 5px; margin-bottom: 10px; }
        button { padding: 5px 10px; margin-right: 5px; }
        pre { border: 1px solid #ccc; padding: 10px; max-height: 300px; overflow: auto; }
        .log { font-family: monospace; font-size: 12px; }
        #pdf-viewer { width: 100%; height: 500px; border: 1px solid #ccc; }
    </style>
</head>
<body>
    <h3>Extrator de PDF com Proxy CORS</h3>
    
    <div>
        <input type="url" id="pdf-url" placeholder="Cole o link do PDF do PJe aqui">
        <div>
            <button id="btn-view">Abrir PDF</button>
            <button id="btn-extract-proxy">Extrair com Proxy</button>
            <button id="btn-extract-allorigins">Extrair com AllOrigins</button>
        </div>
    </div>
    
    <div style="margin-top: 15px;">
        <iframe id="pdf-viewer"></iframe>
    </div>
    
    <h4>Texto Extraído:</h4>
    <pre id="result"></pre>
    
    <h4>Log:</h4>
    <div id="log" class="log"></div>
    
    <script>
        // Elementos DOM
        const urlInput = document.getElementById('pdf-url');
        const btnView = document.getElementById('btn-view');
        const btnExtractProxy = document.getElementById('btn-extract-proxy');
        const btnExtractAllOrigins = document.getElementById('btn-extract-allorigins');
        const pdfViewer = document.getElementById('pdf-viewer');
        const result = document.getElementById('result');
        const logElement = document.getElementById('log');
        
        // Carregar PDF.js
        let pdfJsLoaded = false;
        
        // Eventos
        btnView.addEventListener('click', viewPdf);
        btnExtractProxy.addEventListener('click', extractWithCorsProxy);
        btnExtractAllOrigins.addEventListener('click', extractWithAllOrigins);
        
        // Funções
        function log(message) {
            console.log(message);
            const timestamp = new Date().toLocaleTimeString();
            logElement.innerHTML += `[${timestamp}] ${message}<br>`;
            logElement.scrollTop = logElement.scrollHeight;
        }
        
        function viewPdf() {
            const url = urlInput.value.trim();
            if (!url) {
                log('Digite uma URL válida');
                return;
            }
            
            log(`Abrindo PDF: ${url}`);
            pdfViewer.src = url;
        }
        
        // Extração usando o proxy CORS do Google
        async function extractWithCorsProxy() {
            const url = urlInput.value.trim();
            if (!url) {
                log('Digite uma URL válida');
                return;
            }
            
            log(`Tentando extrair com proxy CORS: ${url}`);
            result.textContent = 'Processando...';
            
            try {
                // Usar o proxy CORS do Google para buscar o PDF
                const proxyUrl = `https://cors-anywhere.herokuapp.com/${url}`;
                
                log(`Acessando via proxy: ${proxyUrl}`);
                
                const response = await fetch(proxyUrl);
                
                if (!response.ok) {
                    throw new Error(`Erro HTTP: ${response.status}`);
                }
                
                const pdfData = await response.arrayBuffer();
                log(`PDF obtido: ${pdfData.byteLength} bytes`);
                
                // Carregar PDF.js se necessário
                if (!pdfJsLoaded) {
                    await loadPdfJs();
                }
                
                // Extrair texto
                const text = await extractTextFromPdf(pdfData);
                result.textContent = text;
                log('Texto extraído com sucesso');
                
            } catch (error) {
                log(`Erro: ${error.message}`);
                result.textContent = `Erro: ${error.message}`;
                
                if (error.message.includes('cors-anywhere')) {
                    log('Nota: O CORS Anywhere pode exigir ativação prévia em https://cors-anywhere.herokuapp.com/');
                }
            }
        }
        
        // Extração usando AllOrigins
        async function extractWithAllOrigins() {
            const url = urlInput.value.trim();
            if (!url) {
                log('Digite uma URL válida');
                return;
            }
            
            log(`Tentando extrair com AllOrigins: ${url}`);
            result.textContent = 'Processando...';
            
            try {
                // Usar o serviço AllOrigins para buscar o PDF
                const allOriginsUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`;
                
                log(`Acessando via AllOrigins: ${allOriginsUrl}`);
                
                const response = await fetch(allOriginsUrl);
                
                if (!response.ok) {
                    throw new Error(`Erro HTTP: ${response.status}`);
                }
                
                const pdfData = await response.arrayBuffer();
                log(`PDF obtido: ${pdfData.byteLength} bytes`);
                
                // Carregar PDF.js se necessário
                if (!pdfJsLoaded) {
                    await loadPdfJs();
                }
                
                // Extrair texto
                const text = await extractTextFromPdf(pdfData);
                result.textContent = text;
                log('Texto extraído com sucesso');
                
            } catch (error) {
                log(`Erro: ${error.message}`);
                result.textContent = `Erro: ${error.message}`;
            }
        }
        
        // Carregar PDF.js
        async function loadPdfJs() {
            log('Carregando PDF.js...');
            
            return new Promise((resolve, reject) => {
                // Carregar script principal
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/pdfjs-dist@3.4.120/build/pdf.min.js';
                script.onload = function() {
                    // Configurar worker
                    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdn.jsdelivr.net/npm/pdfjs-dist@3.4.120/build/pdf.worker.min.js';
                    pdfJsLoaded = true;
                    log('PDF.js carregado com sucesso');
                    resolve();
                };
                script.onerror = function() {
                    reject(new Error('Erro ao carregar PDF.js'));
                };
                document.head.appendChild(script);
            });
        }
        
        // Extrair texto do PDF
        async function extractTextFromPdf(arrayBuffer) {
            const loadingTask = pdfjsLib.getDocument({data: new Uint8Array(arrayBuffer)});
            const pdf = await loadingTask.promise;
            
            log(`PDF carregado: ${pdf.numPages} página(s)`);
            
            let fullText = '';
            
            // Processar cada página
            for (let i = 1; i <= pdf.numPages; i++) {
                log(`Processando página ${i}...`);
                const page = await pdf.getPage(i);
                const textContent = await page.getTextContent();
                
                // Extrair texto dos itens
                const pageText = textContent.items
                    .map(item => item.str)
                    .join(' ');
                
                fullText += `--- Página ${i} ---\n${pageText}\n\n`;
            }
            
            return fullText;
        }
        
        // Carregar URL da última sessão
        const savedUrl = localStorage.getItem('pje-pdf-url');
        if (savedUrl) {
            urlInput.value = savedUrl;
            log('URL carregada da sessão anterior');
        }
        
        // Salvar URL ao digitar
        urlInput.addEventListener('input', () => {
            localStorage.setItem('pje-pdf-url', urlInput.value);
        });
        
        log('Extrator de PDF com proxy inicializado');
    </script>
</body>
</html>