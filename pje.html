<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>PJe Multi-Interceptor - Todas as Abordagens</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .panel { border: 1px solid #ddd; margin: 10px 0; padding: 15px; }
        .form-control { width: 100%; padding: 8px; margin: 5px 0; box-sizing: border-box; }
        .btn { padding: 8px 15px; margin: 5px; cursor: pointer; background: #007bff; color: white; border: none; }
        .btn-success { background: #28a745; }
        .btn-warning { background: #ffc107; color: black; }
        .btn-danger { background: #dc3545; }
        #pdf-viewer { width: 100%; height: 400px; border: 1px solid #ddd; }
        #log { background: #f8f9fa; padding: 10px; height: 200px; overflow-y: auto; font-family: monospace; font-size: 11px; white-space: pre-wrap; }
        .success { color: green; font-weight: bold; }
        .error { color: red; font-weight: bold; }
        .warning { color: orange; font-weight: bold; }
    </style>
</head>
<body>
    <h2>üöÄ PJe Multi-Interceptor - TODAS AS ABORDAGENS</h2>
    
    <div class="panel">
        <h3>üéØ URL e Controles</h3>
        <input type="url" id="pdf-url" class="form-control" value="https://pje.cloud.tjpe.jus.br/1g/seam/resource/rest/pje-legacy/documento/download/137195928">
        <button id="btn-load" class="btn">Carregar PJe</button>
        <button id="btn-all" class="btn btn-success">üî• ATIVAR TODAS AS INTERCEPTA√á√ïES</button>
        <button id="btn-clear" class="btn btn-warning">Limpar Log</button>
    </div>
    
    <div class="panel">
        <h3>üì± Intercepta√ß√µes Individuais</h3>
        <button id="btn-fetch" class="btn">1Ô∏è‚É£ Fetch Hook</button>
        <button id="btn-xhr" class="btn">2Ô∏è‚É£ XHR Hook</button>
        <button id="btn-sw" class="btn">3Ô∏è‚É£ Service Worker</button>
        <button id="btn-dom" class="btn">4Ô∏è‚É£ DOM Monitor</button>
        <button id="btn-network" class="btn">5Ô∏è‚É£ Network Monitor</button>
        <button id="btn-iframe" class="btn">6Ô∏è‚É£ Iframe Injection</button>
        <button id="btn-proxy" class="btn">7Ô∏è‚É£ URL Proxy</button>
    </div>
    
    <div class="panel">
        <h3>üñ•Ô∏è PJe Iframe</h3>
        <iframe id="pdf-viewer"></iframe>
    </div>
    
    <div class="panel">
        <h3>üìä Log de Intercepta√ß√µes</h3>
        <div id="log">Aguardando intercepta√ß√µes...\n</div>
    </div>

    <script>
        const urlInput = document.getElementById('pdf-url');
        const pdfViewer = document.getElementById('pdf-viewer');
        const logDiv = document.getElementById('log');
        
        let interceptionsActive = [];
        let capturedData = [];
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'success' ? 'success' : type === 'error' ? 'error' : type === 'warning' ? 'warning' : '';
            logDiv.innerHTML += `[${timestamp}] <span class="${className}">${message}</span>\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${timestamp}] ${message}`);
        }
        
        // ===== CARREGAR PJE =====
        document.getElementById('btn-load').addEventListener('click', () => {
            const url = urlInput.value.trim();
            log('üîÑ Carregando PJe...', 'info');
            pdfViewer.src = url;
            pdfViewer.onload = () => log('‚úÖ PJe carregado', 'success');
        });
        
        // ===== LIMPAR LOG =====
        document.getElementById('btn-clear').addEventListener('click', () => {
            logDiv.innerHTML = 'Log limpo...\n';
        });
        
        // ===== ATIVAR TODAS =====
        document.getElementById('btn-all').addEventListener('click', () => {
            log('üî• ATIVANDO TODAS AS INTERCEPTA√á√ïES!', 'warning');
            setupFetchHook();
            setupXHRHook();
            setupServiceWorker();
            setupDOMMonitor();
            setupNetworkMonitor();
            setupIframeInjection();
            setupURLProxy();
            log('üöÄ TODAS AS INTERCEPTA√á√ïES ATIVAS!', 'success');
        });
        
        // ===== 1Ô∏è‚É£ FETCH HOOK =====
        document.getElementById('btn-fetch').addEventListener('click', setupFetchHook);
        
        function setupFetchHook() {
            if (interceptionsActive.includes('fetch')) return;
            interceptionsActive.push('fetch');
            
            log('1Ô∏è‚É£ Ativando Fetch Hook...', 'info');
            
            const originalFetch = window.fetch;
            window.fetch = function(...args) {
                const url = args[0];
                
                if (typeof url === 'string') {
                    log(`üîç [FETCH] ${url.substring(0, 100)}...`, 'info');
                    
                    if (url.includes('pje') || url.includes('documento') || url.includes('minio') || url.includes('.pdf')) {
                        log(`üéØ [FETCH] PJe URL detectada!`, 'success');
                        
                        return originalFetch.apply(this, args)
                            .then(response => {
                                log(`üìÑ [FETCH] Status: ${response.status}`, 'info');
                                
                                if (response.ok) {
                                    const contentType = response.headers.get('content-type') || '';
                                    
                                    if (contentType.includes('pdf') || url.includes('.pdf')) {
                                        log(`üéâ [FETCH] PDF DETECTADO!`, 'success');
                                        
                                        const cloned = response.clone();
                                        cloned.blob().then(blob => {
                                            log(`üíæ [FETCH] PDF Capturado: ${blob.size} bytes`, 'success');
                                            capturedData.push({method: 'fetch', blob, url});
                                        });
                                    }
                                }
                                
                                return response;
                            });
                    }
                }
                
                return originalFetch.apply(this, args);
            };
            
            log('‚úÖ [FETCH] Hook ativo', 'success');
        }
        
        // ===== 2Ô∏è‚É£ XHR HOOK =====
        document.getElementById('btn-xhr').addEventListener('click', setupXHRHook);
        
        function setupXHRHook() {
            if (interceptionsActive.includes('xhr')) return;
            interceptionsActive.push('xhr');
            
            log('2Ô∏è‚É£ Ativando XHR Hook...', 'info');
            
            const originalXHR = window.XMLHttpRequest;
            window.XMLHttpRequest = function() {
                const xhr = new originalXHR();
                const originalOpen = xhr.open;
                
                xhr.open = function(method, url, ...args) {
                    if (typeof url === 'string') {
                        log(`üîç [XHR] ${method} ${url.substring(0, 100)}...`, 'info');
                        
                        if (url.includes('pje') || url.includes('documento') || url.includes('minio') || url.includes('.pdf')) {
                            log(`üéØ [XHR] PJe URL detectada!`, 'success');
                            
                            xhr.addEventListener('load', function() {
                                if (xhr.status === 200) {
                                    log(`üéâ [XHR] Resposta OK recebida!`, 'success');
                                    
                                    if (xhr.response instanceof Blob) {
                                        log(`üíæ [XHR] Blob capturado: ${xhr.response.size} bytes`, 'success');
                                        capturedData.push({method: 'xhr', blob: xhr.response, url});
                                    } else if (xhr.responseType === 'arraybuffer') {
                                        const blob = new Blob([xhr.response], {type: 'application/pdf'});
                                        log(`üíæ [XHR] ArrayBuffer capturado: ${blob.size} bytes`, 'success');
                                        capturedData.push({method: 'xhr', blob, url});
                                    }
                                }
                            });
                        }
                    }
                    
                    return originalOpen.apply(this, [method, url, ...args]);
                };
                
                return xhr;
            };
            
            log('‚úÖ [XHR] Hook ativo', 'success');
        }
        
        // ===== 3Ô∏è‚É£ SERVICE WORKER =====
        document.getElementById('btn-sw').addEventListener('click', setupServiceWorker);
        
        function setupServiceWorker() {
            if (interceptionsActive.includes('sw')) return;
            interceptionsActive.push('sw');
            
            log('3Ô∏è‚É£ Ativando Service Worker...', 'info');
            
            if ('serviceWorker' in navigator) {
                const swCode = `
                    self.addEventListener('fetch', function(event) {
                        const url = event.request.url;
                        
                        if (url.includes('pje') || url.includes('documento') || url.includes('minio') || url.includes('.pdf')) {
                            console.log('[SW] Interceptando:', url);
                            
                            event.respondWith(
                                fetch(event.request).then(response => {
                                    if (response.ok) {
                                        const contentType = response.headers.get('content-type') || '';
                                        
                                        if (contentType.includes('pdf') || url.includes('.pdf')) {
                                            console.log('[SW] PDF detectado!');
                                            
                                            // Clonar para capturar
                                            const cloned = response.clone();
                                            cloned.blob().then(blob => {
                                                self.clients.matchAll().then(clients => {
                                                    clients.forEach(client => {
                                                        client.postMessage({
                                                            type: 'SW_PDF_CAPTURED',
                                                            size: blob.size,
                                                            url: url
                                                        });
                                                    });
                                                });
                                            });
                                        }
                                    }
                                    
                                    return response;
                                })
                            );
                        }
                    });
                `;
                
                const blob = new Blob([swCode], {type: 'application/javascript'});
                const swUrl = URL.createObjectURL(blob);
                
                navigator.serviceWorker.register(swUrl)
                    .then(() => {
                        log('‚úÖ [SW] Service Worker registrado', 'success');
                        
                        navigator.serviceWorker.addEventListener('message', event => {
                            if (event.data.type === 'SW_PDF_CAPTURED') {
                                log(`üéâ [SW] PDF capturado via Service Worker! ${event.data.size} bytes`, 'success');
                            }
                        });
                    })
                    .catch(err => log(`‚ùå [SW] Erro: ${err.message}`, 'error'));
            } else {
                log('‚ùå [SW] Service Worker n√£o suportado', 'error');
            }
        }
        
        // ===== 4Ô∏è‚É£ DOM MONITOR =====
        document.getElementById('btn-dom').addEventListener('click', setupDOMMonitor);
        
        function setupDOMMonitor() {
            if (interceptionsActive.includes('dom')) return;
            interceptionsActive.push('dom');
            
            log('4Ô∏è‚É£ Ativando DOM Monitor...', 'info');
            
            // Monitorar cliques
            document.addEventListener('click', function(event) {
                const target = event.target;
                log(`üñ±Ô∏è [DOM] Click em: ${target.tagName} ${target.className}`, 'info');
                
                if (target.href && (target.href.includes('download') || target.href.includes('.pdf'))) {
                    log(`üéØ [DOM] Link de download clicado: ${target.href}`, 'success');
                }
            }, true);
            
            // Monitorar mudan√ßas no DOM
            const observer = new MutationObserver(mutations => {
                mutations.forEach(mutation => {
                    if (mutation.type === 'childList') {
                        mutation.addedNodes.forEach(node => {
                            if (node.nodeType === 1) { // Element
                                if (node.href && node.href.includes('.pdf')) {
                                    log(`üéØ [DOM] Novo link PDF adicionado: ${node.href}`, 'success');
                                }
                            }
                        });
                    }
                });
            });
            
            observer.observe(document.body, {childList: true, subtree: true});
            
            log('‚úÖ [DOM] Monitor ativo', 'success');
        }
        
        // ===== 5Ô∏è‚É£ NETWORK MONITOR =====
        document.getElementById('btn-network').addEventListener('click', setupNetworkMonitor);
        
        function setupNetworkMonitor() {
            if (interceptionsActive.includes('network')) return;
            interceptionsActive.push('network');
            
            log('5Ô∏è‚É£ Ativando Network Monitor...', 'info');
            
            // Performance Observer para requisi√ß√µes
            if ('PerformanceObserver' in window) {
                const observer = new PerformanceObserver(list => {
                    for (const entry of list.getEntries()) {
                        if (entry.name.includes('pje') || entry.name.includes('documento') || entry.name.includes('.pdf')) {
                            log(`üåê [NETWORK] Requisi√ß√£o detectada: ${entry.name}`, 'success');
                            log(`üìä [NETWORK] Dura√ß√£o: ${entry.duration}ms`, 'info');
                        }
                    }
                });
                
                observer.observe({entryTypes: ['resource']});
                log('‚úÖ [NETWORK] Performance Observer ativo', 'success');
            }
            
            // Navigation API
            if ('navigation' in window) {
                window.navigation.addEventListener('navigate', event => {
                    if (event.destination.url.includes('pdf') || event.destination.url.includes('download')) {
                        log(`üéØ [NAVIGATION] Navega√ß√£o para: ${event.destination.url}`, 'success');
                    }
                });
            }
        }
        
        // ===== 6Ô∏è‚É£ IFRAME INJECTION =====
        document.getElementById('btn-iframe').addEventListener('click', setupIframeInjection);
        
        function setupIframeInjection() {
            if (interceptionsActive.includes('iframe')) return;
            interceptionsActive.push('iframe');
            
            log('6Ô∏è‚É£ Ativando Iframe Injection...', 'info');
            
            // Tentar injetar no iframe
            setTimeout(() => {
                try {
                    const iframeDoc = pdfViewer.contentDocument;
                    const iframeWindow = pdfViewer.contentWindow;
                    
                    if (iframeDoc && iframeWindow) {
                        log('‚úÖ [IFRAME] Acesso ao contexto obtido', 'success');
                        
                        const script = iframeDoc.createElement('script');
                        script.textContent = `
                            console.log('[IFRAME] Script injetado!');
                            
                            // Hook no contexto do iframe
                            const originalFetch = window.fetch;
                            window.fetch = function(...args) {
                                console.log('[IFRAME] Fetch:', args[0]);
                                
                                if (args[0] && args[0].includes('pdf')) {
                                    window.parent.postMessage({
                                        type: 'IFRAME_PDF_DETECTED',
                                        url: args[0]
                                    }, '*');
                                }
                                
                                return originalFetch.apply(this, args);
                            };
                        `;
                        
                        iframeDoc.head.appendChild(script);
                        log('‚úÖ [IFRAME] Script injetado com sucesso', 'success');
                    } else {
                        log('‚ùå [IFRAME] N√£o foi poss√≠vel acessar contexto (CORS)', 'error');
                    }
                } catch (e) {
                    log(`‚ùå [IFRAME] Erro na inje√ß√£o: ${e.message}`, 'error');
                }
            }, 2000);
        }
        
        // ===== 7Ô∏è‚É£ URL PROXY =====
        document.getElementById('btn-proxy').addEventListener('click', setupURLProxy);
        
        function setupURLProxy() {
            if (interceptionsActive.includes('proxy')) return;
            interceptionsActive.push('proxy');
            
            log('7Ô∏è‚É£ Ativando URL Proxy...', 'info');
            
            // Interceptar mudan√ßas de URL
            let currentUrl = window.location.href;
            
            setInterval(() => {
                if (window.location.href !== currentUrl) {
                    currentUrl = window.location.href;
                    log(`üîÑ [PROXY] URL mudou: ${currentUrl}`, 'info');
                }
            }, 1000);
            
            // Interceptar History API
            const originalPushState = history.pushState;
            const originalReplaceState = history.replaceState;
            
            history.pushState = function(...args) {
                log(`üîÑ [PROXY] pushState: ${args[2]}`, 'info');
                return originalPushState.apply(this, args);
            };
            
            history.replaceState = function(...args) {
                log(`üîÑ [PROXY] replaceState: ${args[2]}`, 'info');
                return originalReplaceState.apply(this, args);
            };
            
            log('‚úÖ [PROXY] URL Monitor ativo', 'success');
        }
        
        // ===== ESCUTAR MENSAGENS =====
        window.addEventListener('message', function(event) {
            if (event.data && event.data.type) {
                switch (event.data.type) {
                    case 'IFRAME_PDF_DETECTED':
                        log(`üéØ [IFRAME] PDF detectado: ${event.data.url}`, 'success');
                        break;
                }
            }
        });
        
        // ===== AUTO-CARREGAR =====
        if (urlInput.value.trim()) {
            document.getElementById('btn-load').click();
        }
        
        // ===== STATUS PERI√ìDICO =====
        setInterval(() => {
            if (capturedData.length > 0) {
                log(`üìä Status: ${capturedData.length} PDFs capturados`, 'success');
            }
        }, 10000);
        
        log('üöÄ Sistema Multi-Interceptor carregado!', 'success');
        log('üí° Clique em "ATIVAR TODAS AS INTERCEPTA√á√ïES" e teste!', 'info');
    </script>
</body>
</html>