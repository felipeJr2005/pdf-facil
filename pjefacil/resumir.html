<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resumidor Jurídico Avançado</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
            color: #333;
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
        }
        .input-group {
            margin-bottom: 20px;
        }
        .input-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        label {
            display: block;
            font-weight: bold;
            color: #2c3e50;
        }
        textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: inherit;
            resize: vertical;
        }
        #prompt {
            height: 150px;
            background-color: #f8f9fa;
        }
        #sentenca {
            height: 250px;
        }
        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            align-items: center;
        }
        select {
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #ddd;
            background-color: white;
        }
        button {
            background-color: #2c3e50;
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            cursor: pointer;
            border-radius: 4px;
            transition: background 0.3s;
        }
        button:hover {
            background-color: #1a2530;
        }
        .btn-clean {
            background-color: #27ae60;
            padding: 6px 12px;
            font-size: 14px;
        }
        .btn-clean:hover {
            background-color: #219653;
        }
        #resultado {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-left: 4px solid #2c3e50;
            white-space: pre-wrap;
            font-family: monospace;
            min-height: 100px;
        }
        .status {
            margin-top: 15px;
            padding: 10px;
            border-radius: 4px;
        }
        .loading { 
            color: #7f8c8d;
            background-color: #f5f5f5;
        }
        .error { 
            color: #e74c3c;
            background-color: #fdecea;
        }
        .success { 
            color: #27ae60;
            background-color: #e8f5e9;
        }
        .cache-info {
            margin-top: 15px;
            font-size: 14px;
        }
        .cache-hit { color: #27ae60; }
        .cache-miss { color: #e67e22; }
        .stats-container {
            margin-top: 10px;
            font-size: 14px;
            color: #666;
        }
    </style>
</head>
<body>
    <h1>Resumidor Jurídico Avançado</h1>
    
    <div class="input-group">
        <label for="prompt">Prompt de Extração:</label>
        <textarea id="prompt">Extraia os seguintes campos da informação processual abaixo (se não encontrar preencha com "----------------------"):        
            **Sistema de Extração de Dados Jurídicos Automatizado**
            Você é um assistente jurídico especializado em análise de sentenças criminais. Sua tarefa é extrair informações estruturadas de documentos judiciais com precisão absoluta, seguindo rigorosamente as especificações abaixo:
            **Instruções Gerais:**
            1. Analise minuciosamente o texto da sentença fornecido
            2. Extraia apenas as informações solicitadas, sem interpretações ou comentários
            3. Mantenha o formato exato de saída especificado
            4. Para campos não encontrados, utilize: "----------------------"
            **Regras de Extração:**
            1. **Nomes**:
               - Identifique todos os réus (procure por: "Réu", "Sentenciado", "Autor do Fato", "Acusado")
               - Para cada réu, crie uma seção separada com todos os campos
            2. **Formatação de Dados**:
               - Datas: sempre no formato dd/mm/aaaa
               - Naturalidade: "Cidade - UF" (ex: "São Paulo - SP")
               - "Conhecido Como": sempre entre aspas (ex: Conhecido Como: "Xuxa")
               - Nomes de pais/mãe: minúsculas com iniciais maiúsculas
            3. **Identificação Processual**:
               - Número dos Autos: formato NN.NNNN.8.17.NNNN
               - Inquérito: apenas números, sem prefixos
               - Infração Imputada: somente artigos que definam crimes (ignorar artigos processuais)
            4. **Análise de Resultado**:
               - Classifique a sentença como: "Absolvição", "Condenação" ou "Extinção da Punibilidade"
               - Para penas: especificar "Anos/Meses/Dias" ou "Não há Pena"
            **Campos de Extração (SIGA ESTA ORDEM):**
            Órgão Judiciário: [preencher]
            Número dos Autos: [preencher]
            Inquérito: [preencher]
            Nome: [preencher]
            CPF: [preencher]
            Conhecido Como: [preencher]
            Nome da Mãe: [preencher]
            Nome do Pai: [preencher]
            Data de Nascimento: [preencher]
            Naturalidade: [preencher]
            Escolaridade: [preencher]
            RG: [preencher]
            Estado Civil: [preencher]
            Profissão: [preencher]
            Infração Imputada: [preencher]
            Data da Infração: [preencher]
            Data da Denúncia: [preencher]
            Data do Recebimento da Denúncia: [preencher]
            Data da Sentença: [preencher]
            Data do Transito MP: [preencher]
            Data do Transito Defesa: [preencher]
            Data do Transito Réu: [preencher]
            Data da Trânsito em Julgado do Processo: [preencher]
            Pena: [preencher]
            Regime: [preencher]
            Endereço: [preencher]
            Nacionalidade: [preencher]
            Sexo: [preencher]
            Título Eleitoral: [preencher]
            Sentença: [Absolvição/Condenação/Extinção da Punibilidade]
            Ofício a Expedir: [preencher]
            Data da Prisão: [preencher]
            Data da Soltura: [preencher]
            Tipo de Guia: [preencher]
            Data da Decisão do Recurso: [preencher]
            Câmara Julgadora do Recurso: [preencher]
            Data do Transito do Recurso: [preencher]
            Tipo de Processo Criminal: [Ordinário/Sumário/Sumaríssimo]
            **Processamento:**
            1. Identifique primeiro todos os réus mencionados
            2. Para cada réu, preencha todas as informações disponíveis
            3. Verifique consistência entre os dados
            4. Mantenha formatação idêntica para todos os casos
            5. Não adicione nenhum texto além do solicitado
            **Exemplo de Saída (para 1 réu):**
            Órgão Judiciário: 2ª Vara Criminal de São Paulo
            Número dos Autos: 001234-26.2025.8.17.1130
            Inquérito: 987654
            Nome: João da Silva
            CPF: 123.456.789-00
            Conhecido Como: "João do Pulo"
            [... todos os campos ...]
            Tipo de Processo Criminal: Ordinário</textarea>
    </div>
    
    <div class="input-group">
        <div class="input-header">
            <label for="sentenca">Sentença Judicial:</label>
            <button onclick="limparTextoSentenca()" class="btn btn-clean">Limpar Texto</button>
        </div>
        <textarea id="sentenca" placeholder="Cole aqui o texto completo da sentença judicial..."></textarea>
        <div id="texto-stats" class="stats-container">Caracteres: 0 | Palavras: 0</div>
    </div>
    
    <div class="controls">
        <div>
            <label for="temperatura">Temperatura:</label>
            <select id="temperatura">
                <option value="0.0">0.0 (Determinístico)</option>
                <option value="0.5">0.5 (Moderado)</option>
                <option value="1.0">1.0 (Criativo)</option>
                <option value="1.5">1.5 (Muito criativo)</option>
            </select>
        </div>
        
        <button onclick="processarSentenca()">Extrair Dados</button>
    </div>
    
    <div id="resultado">Os dados extraídos aparecerão aqui...</div>
    
    <div id="status" class="status"></div>
    <div id="cache-stats" class="cache-info"></div>

    <script>
        // Cache simples em memória
        const cache = new Map();
        
        // Função para limpar e otimizar texto
        function limparTextoSentenca() {
            const sentencaTextarea = document.getElementById('sentenca');
            const texto = sentencaTextarea.value;
            
            if (!texto.trim()) {
                alert("Não há texto para limpar!");
                return;
            }
            
            // Obter estatísticas antes da limpeza
            const caracteresAntes = texto.length;
            const palavrasAntes = texto.split(/\s+/).filter(word => word.length > 0).length;
            
            // Realizar limpezas mais agressivas no texto:
            let textoLimpo = texto
                // Converter quebras de linha para espaços
                .replace(/[\r\n]+/g, ' ')
                // Remover múltiplos espaços em branco
                .replace(/\s+/g, ' ')
                // Remover espaços no início e fim
                .trim();
            
            // Tratamento especial para preservar estrutura básica do documento
            // Adicionar quebra de linha apenas após pontuação final de frases
            textoLimpo = textoLimpo
                .replace(/\.\s+([A-Z])/g, '.\n$1')
                .replace(/\?\s+([A-Z])/g, '?\n$1')
                .replace(/\!\s+([A-Z])/g, '!\n$1');
            
            // Atualizar o texto no textarea
            sentencaTextarea.value = textoLimpo;
            
            // Obter estatísticas após a limpeza
            const caracteresDepois = textoLimpo.length;
            const palavrasDepois = textoLimpo.split(/\s+/).filter(word => word.length > 0).length;
            
            // Calcular redução
            const reducaoCaracteres = caracteresAntes - caracteresDepois;
            const percentualReducao = ((reducaoCaracteres / caracteresAntes) * 100).toFixed(1);
            
            // Atualizar estatísticas de texto
            atualizarEstatisticasTexto(textoLimpo);
            
            // Mostrar resumo da limpeza
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = `<span class="success">✅ Texto otimizado! Redução de ${reducaoCaracteres} caracteres (${percentualReducao}%)</span>`;
        }
        
        // Função para atualizar estatísticas do texto
        function atualizarEstatisticasTexto(texto = null) {
            const statsDiv = document.getElementById('texto-stats');
            if (!texto) {
                texto = document.getElementById('sentenca').value;
            }
            
            const caracteres = texto.length;
            const palavras = texto.split(/\s+/).filter(word => word.length > 0).length;
            
            statsDiv.textContent = `Caracteres: ${caracteres} | Palavras: ${palavras}`;
        }
        
        // Monitorar mudanças no textarea de sentença
        document.getElementById('sentenca').addEventListener('input', function() {
            atualizarEstatisticasTexto();
        });
        
        async function processarSentenca() {
            const prompt = document.getElementById('prompt').value.trim();
            const sentenca = document.getElementById('sentenca').value.trim();
            const temperatura = parseFloat(document.getElementById('temperatura').value);
            
            const resultadoDiv = document.getElementById('resultado');
            const statusDiv = document.getElementById('status');
            const cacheStatsDiv = document.getElementById('cache-stats');
            
            if (!sentenca) {
                statusDiv.innerHTML = '<span class="error">⚠️ Por favor, insira a sentença judicial</span>';
                return;
            }

            // Verifica cache
            const cacheKey = `${hashTexto(prompt)}-${hashTexto(sentenca)}-${temperatura}`;
            if (cache.has(cacheKey)) {
                resultadoDiv.innerHTML = cache.get(cacheKey).resposta;
                statusDiv.innerHTML = '<span class="success">✔ Resposta recuperada do cache local</span>';
                return;
            }

            statusDiv.innerHTML = '<span class="loading">⌛ Processando documento...</span>';
            resultadoDiv.innerHTML = '';
            cacheStatsDiv.innerHTML = '';
            
            try {
                // 🔥 Substitua pela sua chave API
                const apiKey = "sk-0a164d068ee643099f9d3fc508e4e612";
                
                const response = await fetch('https://api.deepseek.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: "deepseek-chat",
                        messages: [
                            {
                                role: "system",
                                content: "Você é um assistente jurídico especializado em extrair dados de sentenças judiciais."
                            },
                            {
                                role: "user",
                                content: `${prompt}\n\nTEXTO DA SENTENÇA:\n${sentenca}`
                            }
                        ],
                        temperature: temperatura,
                        max_tokens: 2000
                    })
                });

                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error?.message || `Erro ${response.status}`);
                }

                const resposta = data.choices[0].message.content;
                
                // Armazena no cache
                cache.set(cacheKey, {
                    resposta: resposta,
                    timestamp: Date.now()
                });

                resultadoDiv.innerHTML = resposta;
                statusDiv.innerHTML = '<span class="success">✅ Dados extraídos com sucesso</span>';
                
                // Mostra estatísticas de cache da API
                if (data.usage?.prompt_cache_hit_tokens > 0) {
                    const percentual = (data.usage.prompt_cache_hit_tokens / 
                                     (data.usage.prompt_cache_hit_tokens + data.usage.prompt_cache_miss_tokens) * 100).toFixed(1);
                    cacheStatsDiv.innerHTML = `<span class="cache-hit">✔ ${percentual}% dos tokens vieram do cache da DeepSeek (economia de custos)</span>`;
                } else {
                    cacheStatsDiv.innerHTML = '<span class="cache-miss">✖ Nenhum cache hit na DeepSeek API</span>';
                }
                
            } catch (error) {
                console.error("Erro:", error);
                statusDiv.innerHTML = `<span class="error">❌ Erro: ${error.message}</span>`;
            }
        }

        function hashTexto(texto) {
            // Hash simples para identificar textos similares
            let hash = 0;
            for (let i = 0; i < texto.length; i++) {
                const char = texto.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash |= 0;
            }
            return hash;
        }
        
        // Inicializar estatísticas
        atualizarEstatisticasTexto();
    </script>
</body>
</html>
