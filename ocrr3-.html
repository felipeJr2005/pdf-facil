<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OCR Modular - Tesseract</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.1.1/dist/tesseract.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.7.107/pdf.min.js"></script>
    
    <!-- Biblioteca CSS Unificada -->
    <style>
        /* Estilo unificado para ferramentas de PDF - v1.3 */
        :root {
            /* Sistema de cores */
            --color-primary: #4361ee;          /* Azul principal */
            --color-primary-light: #eef2ff;    /* Fundo azul claro */
            --color-primary-dark: #3a56d4;     /* Azul escuro para hover */
            
            /* Cores variantes para diferentes ferramentas */
            --color-docx: #2b5797;             /* Azul para conversor DOCX */
            --color-docx-light: #e6f0ff;
            --color-docx-dark: #1e3e70;
            
            --color-txt: #4361ee;              /* Azul médio para conversor TXT */
            --color-txt-light: #eef2ff;
            --color-txt-dark: #3a56d4;
            
            --color-image: #7048e8;            /* Roxo para conversor de imagem */
            --color-image-light: #f1ebff;
            --color-image-dark: #5f3dc4;
            
            --color-compress: #4361ee;         /* Azul para compressão */
            --color-compress-light: #eef2ff;
            --color-compress-dark: #3a56d4;
            
            --color-extract: #4361ee;          /* Azul para extração de páginas */
            --color-extract-light: #eef2ff;
            --color-extract-dark: #3647c9;
            
            /* Cores de estado e feedback */
            --color-success: #10b981;          /* Verde para sucesso */
            --color-success-light: #dcfce7;
            
            --color-error: #ef4444;            /* Vermelho para erro */
            --color-error-light: #fee2e2;
            
            --color-warning: #f59e0b;          /* Laranja para avisos */
            --color-warning-light: #fffbeb;
            
            /* Tons neutros */
            --color-gray-50: #f8fafc;
            --color-gray-100: #f1f5f9;
            --color-gray-200: #e2e8f0;
            --color-gray-300: #cbd5e1;
            --color-gray-400: #94a3b8;
            --color-gray-500: #64748b;
            --color-gray-600: #475569;
            --color-gray-700: #334155;
            --color-gray-800: #1e293b;
            --color-gray-900: #0f172a;
            
            /* Efeitos e espaçamentos */
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            
            --radius-sm: 0.375rem;     /* 6px */
            --radius-md: 0.5rem;       /* 8px */
            --radius-lg: 0.75rem;      /* 12px */
            --radius-xl: 1rem;         /* 16px */
            
            --transition-normal: all 0.2s ease;
            --transition-slow: all 0.3s ease;
            
            /* Layout */
            --container-padding: 1rem;
            --card-padding: 1rem;
            --spacing-xs: 0.25rem;     /* 4px */
            --spacing-sm: 0.5rem;      /* 8px */
            --spacing-md: 0.75rem;     /* 12px */
            --spacing-lg: 1rem;        /* 16px */
            --spacing-xl: 1.5rem;      /* 24px */
            --spacing-2xl: 2rem;       /* 32px */
        }

        /* Reset e estilos base */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            line-height: 1.6;
            color: var(--color-gray-800);
            background-color: var(--color-gray-50);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Container principal */
        .function-container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: var(--container-padding);
        }

        .container {
            width: 100%;
            padding: 0;
        }

        /* Componentes de card */
        .card {
            background-color: white;
            border-radius: var(--radius-lg);
            border: 1px solid var(--color-gray-200);
            box-shadow: var(--shadow-md);
            margin-bottom: var(--spacing-xl);
            overflow: hidden;
        }

        .card-header {
            padding: var(--spacing-md) var(--spacing-lg);
            border-bottom: 1px solid var(--color-gray-200);
            background-color: var(--color-primary-light);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .card-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--color-primary);
            margin: 0;
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .card-body {
            padding: var(--card-padding);
        }

        /* Área de upload - Componente comum para todas as ferramentas */
        .upload-area .card-body {
            padding: var(--card-padding);
        }

        .drop-zone {
            background: linear-gradient(145deg, var(--color-gray-50), var(--color-primary-light)); 
            border: 1.5px dashed var(--color-primary);
            border-radius: var(--radius-md);
            padding: var(--spacing-xl);
            transition: var(--transition-normal);
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            min-height: 100px;
            cursor: pointer;
        }

        .drop-zone-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            text-align: center;
        }

        .drop-zone:hover {
            border-color: var(--color-primary-dark);
            transform: translateY(-2px);
            box-shadow: var(--shadow-sm);
        }

        .drop-zone.drag-over {
            background: rgba(var(--color-primary-light), 0.5);
            border-color: var(--color-primary-dark);
            border-style: solid;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(67, 97, 238, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(67, 97, 238, 0); }
            100% { box-shadow: 0 0 0 0 rgba(67, 97, 238, 0); }
        }

        .upload-icon {
            font-size: 1.75rem;
            color: var(--color-primary);
            background: white;
            width: 3rem;
            height: 3rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.08);
            margin: 0 auto;
        }

        .upload-text {
            font-weight: 600;
            margin-bottom: var(--spacing-xs);
        }

        .upload-subtext {
            font-size: 0.875rem;
            color: var(--color-gray-500);
        }

        /* Estilo para exibir informações em três linhas separadas */
        .info-block {
            background-color: var(--color-success-light);
            border-radius: var(--radius-sm);
            padding: var(--spacing-md);
            margin-top: var(--spacing-md);
        }

        .info-line {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 5px 0;
        }

        .info-line:not(:last-child) {
            border-bottom: 1px solid rgba(16, 185, 129, 0.1);
            margin-bottom: 5px;
            padding-bottom: 8px;
        }

        .info-line i {
            color: var(--color-success);
            font-size: 16px;
            min-width: 20px;
        }

        /* Mensagens de status */
        .status-message {
            padding: var(--spacing-md);
            border-radius: var(--radius-sm);
            margin-top: var(--spacing-md);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .status-message.success {
            background-color: var(--color-success-light);
            color: var(--color-success);
            border-left: 4px solid var(--color-success);
        }

        .status-message.error {
            background-color: var(--color-error-light);
            color: var(--color-error);
            border-left: 4px solid var(--color-error);
        }

        .status-message.warning {
            background-color: var(--color-warning-light);
            color: var(--color-warning);
            border-left: 4px solid var(--color-warning);
        }

        /* Botões e controles */
        .btn, 
        button.compress-button,
        .divider-button,
        button#divideButton,
        .extract-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-sm);
            padding: 0.75rem 1.25rem;
            border-radius: var(--radius-md);
            font-weight: 600;
            font-size: 0.9375rem;
            cursor: pointer;
            transition: var(--transition-normal);
            border: none;
            text-decoration: none;
            line-height: 1.4;
            margin: 0;
        }

        .btn:hover:not(:disabled),
        button.compress-button:hover:not(:disabled),
        .divider-button:hover:not(:disabled),
        button#divideButton:hover:not(:disabled),
        .extract-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .btn:disabled,
        button.compress-button:disabled,
        .divider-button:disabled,
        button#divideButton:disabled,
        .extract-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }

        .btn:active:not(:disabled),
        button.compress-button:active:not(:disabled),
        .divider-button:active:not(:disabled),
        button#divideButton:active:not(:disabled),
        .extract-btn:active:not(:disabled) {
            transform: translateY(0);
        }

        /* Variações de botões */
        .btn-primary {
            background: linear-gradient(to right, var(--color-primary), var(--color-primary-dark));
            color: white;
        }

        .btn-success {
            background: var(--color-success);
            color: white;
        }

        .btn-warning {
            background: var(--color-warning);
            color: white;
        }

        /* Formulários e controles */
        .form-group {
            margin-bottom: var(--spacing-lg);
        }

        .form-label {
            font-weight: 500;
            color: var(--color-gray-700);
            margin-bottom: var(--spacing-sm);
            display: block;
        }

        .form-control,
        input[type="text"],
        input[type="number"],
        input[type="email"],
        select,
        textarea {
            width: 100%;
            padding: var(--spacing-sm);
            border: 1px solid var(--color-gray-200);
            border-radius: var(--radius-sm);
            font-size: 0.9375rem;
            background-color: white;
            transition: var(--transition-normal);
        }

        .form-control:focus,
        input[type="text"]:focus,
        input[type="number"]:focus,
        input[type="email"]:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            margin: var(--spacing-sm) 0;
        }

        /* Barra de progresso */
        .progress-container {
            margin: var(--spacing-lg) 0;
        }

        progress,
        .progress-bar {
            width: 100%;
            height: 4px;
            border-radius: 2px;
            background-color: var(--color-gray-200);
            overflow: hidden;
        }

        progress::-webkit-progress-bar,
        .progress-bar {
            background-color: var(--color-gray-200);
            border-radius: 2px;
        }

        progress::-webkit-progress-value,
        .progress-bar-fill {
            background-color: var(--color-primary);
            border-radius: 2px;
        }

        .progress-text {
            font-size: 0.875rem;
            color: var(--color-gray-500);
            text-align: center;
            margin-top: var(--spacing-xs);
        }

        /* Editor de texto */
        .editor-content {
            min-height: 300px;
            max-height: 500px;
            overflow-y: auto;
            padding: var(--spacing-lg);
            border: 2px solid var(--color-gray-200);
            border-radius: var(--radius-md);
            background: white;
            font-family: 'Courier New', monospace;
            line-height: 1.8;
            white-space: pre-wrap;
        }

        .editor-content:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
        }

        /* Estatísticas */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: var(--spacing-lg);
            margin: var(--spacing-lg) 0;
        }

        .stat-item {
            text-align: center;
            padding: var(--spacing-lg);
            background: var(--color-gray-50);
            border-radius: var(--radius-md);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--color-primary);
            display: block;
        }

        .stat-label {
            font-size: 0.9rem;
            color: var(--color-gray-500);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Utilitários */
        .hidden {
            display: none !important;
        }

        .text-center { text-align: center; }
        .w-full { width: 100%; }
        .flex { display: flex; }
        .items-center { align-items: center; }
        .gap-2 { gap: var(--spacing-sm); }

        /* Responsividade */
        @media (max-width: 768px) {
            .function-container {
                padding: var(--spacing-sm);
            }
            
            .card-body {
                padding: var(--spacing-md);
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Upload Card -->
        <div class="card">
            <div class="card-header">
                <h1 class="card-title">
                    <i class="fas fa-eye"></i>
                    OCR Modular - Tesseract
                </h1>
            </div>
            <div class="card-body">
                <div class="drop-zone" id="dropZone">
                    <div class="upload-icon">
                        <i class="fas fa-cloud-upload-alt"></i>
                    </div>
                    <div class="upload-text">Arraste arquivos ou clique para selecionar</div>
                    <div class="upload-subtext">Suporte para JPG, PNG e PDF (máx. 10MB)</div>
                    <input type="file" id="fileInput" accept=".jpg,.jpeg,.png,.pdf" style="display: none;" multiple>
                </div>
                <div id="fileInfo"></div>
            </div>
        </div>

        <!-- Settings Card -->
        <div class="card hidden" id="settingsCard">
            <div class="card-header">
                <h2 class="card-title">
                    <i class="fas fa-cogs"></i>
                    Configurações
                </h2>
            </div>
            <div class="card-body">
                <div class="form-group">
                    <label class="form-label">Idioma:</label>
                    <select class="form-control" id="languageSelect">
                        <option value="por">Português</option>
                        <option value="eng">Inglês</option>
                        <option value="spa">Espanhol</option>
                        <option value="fra">Francês</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Qualidade:</label>
                    <select class="form-control" id="qualitySelect">
                        <option value="fast">Rápido</option>
                        <option value="balanced" selected>Balanceado</option>
                        <option value="best">Melhor Precisão</option>
                    </select>
                </div>

                <div class="checkbox-group">
                    <input type="checkbox" id="enhanceImage" checked>
                    <label for="enhanceImage">Melhorar qualidade da imagem</label>
                </div>

                <button class="btn btn-primary" id="startOCR" style="width: 100%; margin-top: 20px;">
                    <i class="fas fa-magic"></i>
                    Iniciar Reconhecimento
                </button>
            </div>
        </div>

        <!-- Progress Card -->
        <div class="card hidden" id="progressCard">
            <div class="card-header">
                <h2 class="card-title">
                    <i class="fas fa-spinner fa-spin"></i>
                    Processando
                </h2>
            </div>
            <div class="card-body">
                <div class="progress-container">
                    <progress class="progress-bar" id="progressBar" value="0" max="100"></progress>
                    <div class="progress-text" id="progressText">Iniciando...</div>
                </div>
            </div>
        </div>

        <!-- Results Card -->
        <div class="card hidden" id="resultsCard">
            <div class="card-header">
                <h2 class="card-title">
                    <i class="fas fa-file-alt"></i>
                    Texto Reconhecido
                </h2>
            </div>
            <div class="card-body">
                <div class="stats-grid" id="statsGrid">
                    <div class="stat-item">
                        <span class="stat-value" id="wordCount">0</span>
                        <span class="stat-label">Palavras</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value" id="charCount">0</span>
                        <span class="stat-label">Caracteres</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value" id="confidenceValue">0%</span>
                        <span class="stat-label">Confiança</span>
                    </div>
                </div>

                <div id="editorContent" class="editor-content" contenteditable="true" 
                     placeholder="O texto reconhecido aparecerá aqui..."></div>
                
                <div style="margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="btn btn-success" id="copyBtn">
                        <i class="fas fa-copy"></i>
                        Copiar
                    </button>
                    <button class="btn btn-primary" id="downloadBtn">
                        <i class="fas fa-download"></i>
                        Baixar TXT
                    </button>
                    <button class="btn btn-warning" id="cleanBtn">
                        <i class="fas fa-broom"></i>
                        Limpar Texto
                    </button>
                </div>
            </div>
        </div>

        <!-- Status Messages -->
        <div id="statusContainer"></div>
    </div>

    <script>
        /* ===== MÓDULO 1: CONFIGURAÇÃO E ESTADO ===== */
        const OCRConfig = {
            // Configurações do PDF.js
            init() {
                pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.7.107/pdf.worker.min.js';
            },
            
            // Configurações do Tesseract
            getTesseractOptions(quality, language) {
                const baseOptions = {
                    logger: (m) => {
                        if (m.status === 'recognizing text') {
                            OCRProgress.updateProgress(50 + (m.progress * 40), 'Reconhecendo texto...', `${Math.round(m.progress * 100)}%`);
                        }
                    }
                };

                switch (quality) {
                    case 'fast':
                        return {
                            ...baseOptions,
                            tessedit_pageseg_mode: '1',
                            tessedit_ocr_engine_mode: '1'
                        };
                    case 'best':
                        return {
                            ...baseOptions,
                            tessedit_pageseg_mode: '6',
                            tessedit_ocr_engine_mode: '1',
                            preserve_interword_spaces: '1'
                        };
                    default: // balanced
                        return {
                            ...baseOptions,
                            tessedit_pageseg_mode: '6'
                        };
                }
            }
        };

        // Estado global da aplicação
        const OCRState = {
            currentFiles: null,
            isProcessing: false,
            results: [],
            
            reset() {
                this.currentFiles = null;
                this.isProcessing = false;
                this.results = [];
            },
            
            setFiles(files) {
                this.currentFiles = files;
            },
            
            addResult(result) {
                this.results.push(result);
            }
        };

        /* ===== MÓDULO 2: ELEMENTOS DOM ===== */
        const OCRElements = {
            // Cache de elementos
            dropZone: null,
            fileInput: null,
            fileInfo: null,
            settingsCard: null,
            progressCard: null,
            resultsCard: null,
            statusContainer: null,
            
            init() {
                this.dropZone = document.getElementById('dropZone');
                this.fileInput = document.getElementById('fileInput');
                this.fileInfo = document.getElementById('fileInfo');
                this.settingsCard = document.getElementById('settingsCard');
                this.progressCard = document.getElementById('progressCard');
                this.resultsCard = document.getElementById('resultsCard');
                this.statusContainer = document.getElementById('statusContainer');
                this.progressBar = document.getElementById('progressBar');
                this.progressText = document.getElementById('progressText');
                this.editorContent = document.getElementById('editorContent');
                this.languageSelect = document.getElementById('languageSelect');
                this.qualitySelect = document.getElementById('qualitySelect');
                this.enhanceImage = document.getElementById('enhanceImage');
                this.startOCR = document.getElementById('startOCR');
                this.copyBtn = document.getElementById('copyBtn');
                this.downloadBtn = document.getElementById('downloadBtn');
                this.cleanBtn = document.getElementById('cleanBtn');
                this.wordCount = document.getElementById('wordCount');
                this.charCount = document.getElementById('charCount');
                this.confidenceValue = document.getElementById('confidenceValue');
            },
            
            show(element) {
                if (typeof element === 'string') {
                    element = document.getElementById(element);
                }
                if (element) element.classList.remove('hidden');
            },
            
            hide(element) {
                if (typeof element === 'string') {
                    element = document.getElementById(element);
                }
                if (element) element.classList.add('hidden');
            }
        };

        /* ===== MÓDULO 3: GERENCIAMENTO DE MENSAGENS ===== */
        const OCRMessages = {
            show(message, type = 'info', duration = 5000) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `status-message ${type}`;
                
                const icon = type === 'success' ? 'check-circle' : 
                           type === 'error' ? 'exclamation-circle' : 
                           type === 'warning' ? 'exclamation-triangle' : 'info-circle';
                
                messageDiv.innerHTML = `
                    <i class="fas fa-${icon}"></i>
                    ${message}
                `;
                
                OCRElements.statusContainer.appendChild(messageDiv);
                
                if (duration > 0) {
                    setTimeout(() => {
                        if (messageDiv.parentNode) {
                            messageDiv.parentNode.removeChild(messageDiv);
                        }
                    }, duration);
                }
            },
            
            clear() {
                OCRElements.statusContainer.innerHTML = '';
            }
        };

        /* ===== MÓDULO 4: CONTROLE DE PROGRESSO ===== */
        const OCRProgress = {
            show() {
                OCRElements.show(OCRElements.progressCard);
            },
            
            hide() {
                OCRElements.hide(OCRElements.progressCard);
            },
            
            updateProgress(value, text, subtext = '') {
                if (OCRElements.progressBar) {
                    OCRElements.progressBar.value = value;
                }
                if (OCRElements.progressText) {
                    OCRElements.progressText.textContent = text + (subtext ? ` - ${subtext}` : '');
                }
            }
        };

        /* ===== MÓDULO 5: VALIDAÇÃO DE ARQUIVOS ===== */
        const OCRValidator = {
            validateFile(file) {
                const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'application/pdf'];
                const maxSize = 10 * 1024 * 1024; // 10MB

                if (!validTypes.includes(file.type)) {
                    throw new Error(`Tipo de arquivo não suportado: ${file.type}. Use JPG, PNG ou PDF.`);
                }

                if (file.size > maxSize) {
                    throw new Error(`Arquivo muito grande: ${(file.size / 1024 / 1024).toFixed(1)}MB. Máximo 10MB.`);
                }

                return true;
            },
            
            validateFiles(files) {
                const validFiles = [];
                const errors = [];
                
                for (const file of files) {
                    try {
                        this.validateFile(file);
                        validFiles.push(file);
                    } catch (error) {
                        errors.push(`${file.name}: ${error.message}`);
                    }
                }
                
                return { validFiles, errors };
            }
        };

        /* ===== MÓDULO 6: PROCESSAMENTO DE IMAGEM ===== */
        const OCRImageProcessor = {
            async enhanceImage(imageData) {
                return new Promise((resolve) => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const img = new Image();

                    img.onload = function() {
                        canvas.width = img.width;
                        canvas.height = img.height;
                        ctx.drawImage(img, 0, 0);

                        const imageDataObj = ctx.getImageData(0, 0, canvas.width, canvas.height);
                        const data = imageDataObj.data;

                        // Converter para escala de cinza e melhorar contraste
                        for (let i = 0; i < data.length; i += 4) {
                            const gray = data[i] * 0.299 + data[i + 1] * 0.587 + data[i + 2] * 0.114;
                            const enhanced = Math.min(255, Math.max(0, (gray - 128) * 1.5 + 128));
                            data[i] = data[i + 1] = data[i + 2] = enhanced;
                        }

                        ctx.putImageData(imageDataObj, 0, 0);
                        resolve(canvas.toDataURL('image/png'));
                    };

                    img.src = imageData;
                });
            },
            
            async processImage(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
            }
        };

        /* ===== MÓDULO 7: PROCESSAMENTO DE PDF ===== */
        const OCRPDFProcessor = {
            async processPDF(file) {
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                const numPages = pdf.numPages;
                
                const images = [];
                
                for (let pageNum = 1; pageNum <= numPages; pageNum++) {
                    OCRProgress.updateProgress(
                        (pageNum / numPages) * 30,
                        `Extraindo página ${pageNum} de ${numPages}`,
                        'Convertendo PDF para imagens'
                    );
                    
                    const page = await pdf.getPage(pageNum);
                    const scale = 2.0;
                    const viewport = page.getViewport({ scale });
                    
                    const canvas = document.createElement('canvas');
                    const context = canvas.getContext('2d');
                    canvas.height = viewport.height;
                    canvas.width = viewport.width;
                    
                    await page.render({
                        canvasContext: context,
                        viewport: viewport
                    }).promise;
                    
                    images.push({
                        pageNum: pageNum,
                        imageData: canvas.toDataURL('image/png')
                    });
                }
                
                return images;
            }
        };

        /* ===== MÓDULO 8: PROCESSAMENTO OCR ===== */
        const OCRProcessor = {
            async processText(imageData, language, quality) {
                const options = OCRConfig.getTesseractOptions(quality, language);
                
                // Melhorar imagem se ativado
                let processedImage = imageData;
                if (OCRElements.enhanceImage.checked) {
                    OCRProgress.updateProgress(10, 'Melhorando qualidade da imagem...', 'Aplicando filtros');
                    processedImage = await OCRImageProcessor.enhanceImage(imageData);
                }
                
                OCRProgress.updateProgress(30, 'Iniciando reconhecimento...', 'Carregando Tesseract');
                
                const result = await Tesseract.recognize(processedImage, language, options);
                
                return {
                    text: result.data.text,
                    confidence: result.data.confidence
                };
            },
            
            async processFiles() {
                if (!OCRState.currentFiles || OCRState.isProcessing) return;
                
                OCRState.isProcessing = true;
                OCRState.results = [];
                
                try {
                    OCRProgress.show();
                    OCRElements.hide(OCRElements.resultsCard);
                    
                    const language = OCRElements.languageSelect.value;
                    const quality = OCRElements.qualitySelect.value;
                    const files = Array.from(OCRState.currentFiles);
                    
                    let allText = '';
                    let totalConfidence = 0;
                    let validResults = 0;
                    
                    for (let i = 0; i < files.length; i++) {
                        const file = files[i];
                        
                        OCRProgress.updateProgress(
                            (i / files.length) * 90,
                            `Processando arquivo ${i + 1} de ${files.length}`,
                            file.name
                        );
                        
                        try {
                            if (file.type === 'application/pdf') {
                                const pages = await OCRPDFProcessor.processPDF(file);
                                
                                for (const page of pages) {
                                    const result = await this.processText(page.imageData, language, quality);
                                    if (result.text.trim()) {
                                        allText += `\n\n--- ${file.name} - Página ${page.pageNum} ---\n\n${result.text}`;
                                        totalConfidence += result.confidence;
                                        validResults++;
                                    }
                                }
                            } else {
                                const imageData = await OCRImageProcessor.processImage(file);
                                const result = await this.processText(imageData, language, quality);
                                
                                if (result.text.trim()) {
                                    allText += `\n\n--- ${file.name} ---\n\n${result.text}`;
                                    totalConfidence += result.confidence;
                                    validResults++;
                                }
                            }
                        } catch (error) {
                            console.error(`Erro ao processar ${file.name}:`, error);
                            allText += `\n\n--- ${file.name} (ERRO) ---\n\nErro: ${error.message}\n\n`;
                        }
                    }
                    
                    OCRProgress.updateProgress(100, 'Finalizando...', 'Preparando resultado');
                    
                    const averageConfidence = validResults > 0 ? totalConfidence / validResults : 0;
                    
                    // Mostrar resultado
                    OCRDisplay.showResults(allText.trim(), averageConfidence);
                    
                    OCRMessages.show(`Processamento concluído! ${validResults} resultado(s) obtido(s).`, 'success');
                    
                } catch (error) {
                    console.error('Erro no processamento:', error);
                    OCRMessages.show(`Erro durante o processamento: ${error.message}`, 'error');
                } finally {
                    OCRState.isProcessing = false;
                    OCRProgress.hide();
                }
            }
        };

        /* ===== MÓDULO 9: EXIBIÇÃO DE RESULTADOS ===== */
        const OCRDisplay = {
            showResults(text, confidence) {
                if (!text) {
                    OCRMessages.show('Nenhum texto foi reconhecido.', 'warning');
                    return;
                }
                
                // Atualizar editor
                OCRElements.editorContent.textContent = text;
                
                // Atualizar estatísticas
                this.updateStats(text, confidence);
                
                // Mostrar card de resultados
                OCRElements.show(OCRElements.resultsCard);
            },
            
            updateStats(text, confidence) {
                const words = text.trim().split(/\s+/).length;
                const chars = text.length;
                
                OCRElements.wordCount.textContent = words.toLocaleString();
                OCRElements.charCount.textContent = chars.toLocaleString();
                OCRElements.confidenceValue.textContent = Math.round(confidence) + '%';
            }
        };

        /* ===== MÓDULO 10: GERENCIAMENTO DE ARQUIVOS ===== */
        const OCRFileHandler = {
            handleFiles(files) {
                const { validFiles, errors } = OCRValidator.validateFiles(files);
                
                if (errors.length > 0) {
                    OCRMessages.show(`Arquivos inválidos: ${errors.join(', ')}`, 'error');
                }
                
                if (validFiles.length === 0) {
                    return;
                }
                
                OCRState.setFiles(validFiles);
                this.showFileInfo(validFiles);
                OCRElements.show(OCRElements.settingsCard);
                
                OCRMessages.show(`${validFiles.length} arquivo(s) carregado(s) com sucesso!`, 'success');
            },
            
            showFileInfo(files) {
                const totalSize = files.reduce((sum, file) => sum + file.size, 0);
                const fileNames = files.map(file => file.name);
                
                OCRElements.fileInfo.innerHTML = `
                    <div class="info-block">
                        <div class="info-line">
                            <i class="fas fa-file"></i>
                            <strong>Arquivo(s):</strong> ${files.length} selecionado(s)
                        </div>
                        <div class="info-line">
                            <i class="fas fa-weight-hanging"></i>
                            <strong>Tamanho Total:</strong> ${(totalSize / 1024 / 1024).toFixed(2)} MB
                        </div>
                        <div class="info-line">
                            <i class="fas fa-list"></i>
                            <strong>Lista:</strong> ${fileNames.join(', ')}
                        </div>
                    </div>
                `;
            }
        };

        /* ===== MÓDULO 11: LIMPEZA E CORREÇÃO DE TEXTO ===== */
        const OCRTextCleaner = {
            cleanText(text) {
                if (!text) return text;
                
                // Limpeza básica
                text = text.replace(/\r\n/g, '\n');
                text = text.replace(/\t/g, ' ');
                text = text.replace(/ {2,}/g, ' ');
                
                // Correções comuns de OCR
                const corrections = {
                    // Números confundidos com letras
                    '0': 'O', // Em contextos específicos
                    'l': '1', // Em contextos numéricos
                    '5': 'S', // Em contextos específicos
                    
                    // Palavras portuguesas comuns
                    'açã0': 'ação',
                    'ment0': 'mento',
                    'çã0': 'ção',
                    'nã0': 'não',
                    'sã0': 'são',
                    'visã0': 'visão',
                    'decisã0': 'decisão',
                    'informaçã0': 'informação',
                    
                    // Palavras jurídicas
                    'Justiça': 'Justiça',
                    'Tribunal': 'Tribunal',
                    'processo': 'processo',
                    'sentença': 'sentença',
                    'decisão': 'decisão',
                    'recurso': 'recurso',
                    'apelação': 'apelação'
                };
                
                // Aplicar correções contextuais
                for (const [wrong, correct] of Object.entries(corrections)) {
                    // Correção de "0" para "O" apenas no início de palavras
                    if (wrong === '0') {
                        text = text.replace(/\b0\s+([a-záàâãéèêíïóôõöúçñ])/gi, 'O $1');
                        text = text.replace(/(^|\s)0(\s)/g, '$1O$2');
                    } else {
                        const regex = new RegExp(`\\b${wrong}\\b`, 'gi');
                        text = text.replace(regex, correct);
                    }
                }
                
                // Melhorar formatação
                text = text.replace(/([.!?])\s*\n\s*([A-ZÁÀÂÃÉÈÊ])/g, '$1\n\n$2');
                text = text.replace(/\n{3,}/g, '\n\n');
                
                return text.trim();
            }
        };

        /* ===== MÓDULO 12: EXPORTAÇÃO DE DADOS ===== */
        const OCRExporter = {
            copyToClipboard() {
                const text = OCRElements.editorContent.textContent;
                if (!text.trim()) {
                    OCRMessages.show('Nenhum texto para copiar!', 'warning');
                    return;
                }
                
                navigator.clipboard.writeText(text).then(() => {
                    OCRMessages.show('Texto copiado para a área de transferência!', 'success');
                }).catch(() => {
                    // Fallback para navegadores sem clipboard API
                    const textArea = document.createElement('textarea');
                    textArea.value = text;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    OCRMessages.show('Texto copiado!', 'success');
                });
            },
            
            downloadAsText() {
                const text = OCRElements.editorContent.textContent;
                if (!text.trim()) {
                    OCRMessages.show('Nenhum texto para baixar!', 'warning');
                    return;
                }
                
                const timestamp = new Date().toLocaleString();
                const metadata = `OCR realizado em: ${timestamp}\nIdioma: ${OCRElements.languageSelect.value}\nQualidade: ${OCRElements.qualitySelect.value}\n\n${'='.repeat(50)}\n\n${text}`;
                
                const blob = new Blob([metadata], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `ocr_${new Date().toISOString().split('T')[0]}.txt`;
                a.click();
                
                URL.revokeObjectURL(url);
                OCRMessages.show('Arquivo baixado com sucesso!', 'success');
            },
            
            cleanAndFormat() {
                const text = OCRElements.editorContent.textContent;
                if (!text.trim()) {
                    OCRMessages.show('Nenhum texto para limpar!', 'warning');
                    return;
                }
                
                const cleanedText = OCRTextCleaner.cleanText(text);
                OCRElements.editorContent.textContent = cleanedText;
                
                // Atualizar estatísticas
                OCRDisplay.updateStats(cleanedText, 0);
                
                OCRMessages.show('Texto limpo e formatado!', 'success');
            }
        };

        /* ===== MÓDULO 13: EVENTOS E INTERAÇÕES ===== */
        const OCREvents = {
            init() {
                this.setupDragAndDrop();
                this.setupFileInput();
                this.setupButtons();
                this.setupKeyboardShortcuts();
            },
            
            setupDragAndDrop() {
                const events = ['dragenter', 'dragover', 'dragleave', 'drop'];
                
                events.forEach(eventName => {
                    OCRElements.dropZone.addEventListener(eventName, (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                    });
                });
                
                ['dragenter', 'dragover'].forEach(eventName => {
                    OCRElements.dropZone.addEventListener(eventName, () => {
                        OCRElements.dropZone.classList.add('drag-over');
                    });
                });
                
                ['dragleave', 'drop'].forEach(eventName => {
                    OCRElements.dropZone.addEventListener(eventName, () => {
                        OCRElements.dropZone.classList.remove('drag-over');
                    });
                });
                
                OCRElements.dropZone.addEventListener('drop', (e) => {
                    const files = Array.from(e.dataTransfer.files);
                    OCRFileHandler.handleFiles(files);
                });
                
                OCRElements.dropZone.addEventListener('click', () => {
                    OCRElements.fileInput.click();
                });
            },
            
            setupFileInput() {
                OCRElements.fileInput.addEventListener('change', (e) => {
                    const files = Array.from(e.target.files);
                    if (files.length > 0) {
                        OCRFileHandler.handleFiles(files);
                    }
                });
            },
            
            setupButtons() {
                // Botão iniciar OCR
                OCRElements.startOCR.addEventListener('click', () => {
                    if (OCRState.currentFiles && !OCRState.isProcessing) {
                        OCRProcessor.processFiles();
                    }
                });
                
                // Botões de ação
                OCRElements.copyBtn.addEventListener('click', () => {
                    OCRExporter.copyToClipboard();
                });
                
                OCRElements.downloadBtn.addEventListener('click', () => {
                    OCRExporter.downloadAsText();
                });
                
                OCRElements.cleanBtn.addEventListener('click', () => {
                    OCRExporter.cleanAndFormat();
                });
            },
            
            setupKeyboardShortcuts() {
                document.addEventListener('keydown', (e) => {
                    if (e.ctrlKey || e.metaKey) {
                        switch (e.key.toLowerCase()) {
                            case 's':
                                e.preventDefault();
                                OCRExporter.downloadAsText();
                                break;
                            case 'c':
                                if (e.target === OCRElements.editorContent) {
                                    // Permitir Ctrl+C normal no editor
                                    return;
                                }
                                e.preventDefault();
                                OCRExporter.copyToClipboard();
                                break;
                            case 'l':
                                e.preventDefault();
                                OCRExporter.cleanAndFormat();
                                break;
                        }
                    }
                });
            }
        };

        /* ===== MÓDULO 14: INICIALIZAÇÃO PRINCIPAL ===== */
        const OCRApp = {
            async init() {
                try {
                    // Configurar PDF.js
                    OCRConfig.init();
                    
                    // Inicializar elementos DOM
                    OCRElements.init();
                    
                    // Configurar eventos
                    OCREvents.init();
                    
                    // Resetar estado
                    OCRState.reset();
                    
                    // Verificar compatibilidade
                    this.checkCompatibility();
                    
                    // Mensagem de boas-vindas
                    OCRMessages.show('Sistema OCR carregado e pronto para uso!', 'success', 3000);
                    
                } catch (error) {
                    console.error('Erro na inicialização:', error);
                    OCRMessages.show('Erro ao inicializar o sistema. Recarregue a página.', 'error');
                }
            },
            
            checkCompatibility() {
                const features = {
                    FileReader: typeof FileReader !== 'undefined',
                    Canvas: !!document.createElement('canvas').getContext,
                    WebWorkers: typeof Worker !== 'undefined',
                    Clipboard: !!navigator.clipboard
                };
                
                const missing = Object.entries(features)
                    .filter(([, supported]) => !supported)
                    .map(([feature]) => feature);
                
                if (missing.length > 0) {
                    OCRMessages.show(
                        `Recursos não suportados: ${missing.join(', ')}. Algumas funcionalidades podem não funcionar.`,
                        'warning'
                    );
                }
                
                // Verificar protocolo HTTPS para recursos avançados
                if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
                    OCRMessages.show(
                        'Para melhor funcionamento, use HTTPS.',
                        'warning',
                        3000
                    );
                }
            }
        };

        /* ===== MÓDULO 15: TRATAMENTO DE ERROS ===== */
        const OCRErrorHandler = {
            init() {
                // Capturar erros globais
                window.addEventListener('error', (event) => {
                    this.handleError(event.error, 'Erro JavaScript');
                });
                
                // Capturar promises rejeitadas
                window.addEventListener('unhandledrejection', (event) => {
                    this.handleError(event.reason, 'Promise rejeitada');
                    event.preventDefault();
                });
            },
            
            handleError(error, context = 'Erro') {
                console.error(`${context}:`, error);
                
                // Resetar estado de processamento se necessário
                if (OCRState.isProcessing) {
                    OCRState.isProcessing = false;
                    OCRProgress.hide();
                }
                
                // Mostrar mensagem ao usuário
                let message = 'Ocorreu um erro inesperado.';
                
                if (error.message) {
                    if (error.message.includes('Tesseract')) {
                        message = 'Erro no sistema de OCR. Tente novamente.';
                    } else if (error.message.includes('network') || error.message.includes('fetch')) {
                        message = 'Erro de conexão. Verifique sua internet.';
                    } else if (error.message.includes('memory')) {
                        message = 'Erro de memória. Tente com arquivos menores.';
                    } else {
                        message = `Erro: ${error.message}`;
                    }
                }
                
                OCRMessages.show(message, 'error');
            }
        };

        /* ===== INICIALIZAÇÃO DA APLICAÇÃO ===== */
        document.addEventListener('DOMContentLoaded', async () => {
            // Inicializar tratamento de erros primeiro
            OCRErrorHandler.init();
            
            // Inicializar aplicação principal
            await OCRApp.init();
            
            console.log('🚀 Sistema OCR Modular inicializado com sucesso!');
        });

        // Expor módulos principais para debug (opcional)
        window.OCR = {
            State: OCRState,
            Elements: OCRElements,
            Messages: OCRMessages,
            Processor: OCRProcessor,
            FileHandler: OCRFileHandler,
            Exporter: OCRExporter
        };
    </script>
</body>
</html>