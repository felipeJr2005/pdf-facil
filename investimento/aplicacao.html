<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Controlador de Aplica√ß√µes Financeiras</title>
    
    <!-- Bootstrap 5.3.7 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-LN+7fdVzj6u52u30Kp6M/trliBMCMKTyK833zpbD+pXdCLuTusPj697FH4R/5mcr" crossorigin="anonymous">
    
    <!-- Custom CSS para aplica√ß√£o financeira -->
    <style>
        :root {
            --primary-color: #1e3a8a;
            --secondary-color: #64748b;
            --success-color: #059669;
            --danger-color: #dc2626;
            --warning-color: #d97706;
            --info-color: #0284c7;
            --light-color: #f8fafc;
            --dark-color: #1e293b;
        }

        body {
            background-color: #f8fafc;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .financial-header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            padding: 2rem 0;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .financial-card {
            border: none;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 1.5rem;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .financial-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .rates-section {
            background: linear-gradient(135deg, var(--info-color) 0%, #0ea5e9 100%);
            color: white;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .rate-input-group {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            padding: 1rem;
            backdrop-filter: blur(10px);
        }

        .portfolio-summary {
            background: linear-gradient(135deg, var(--success-color) 0%, #10b981 100%);
            color: white;
            border-radius: 8px;
            padding: 1.5rem;
        }

        .summary-metric {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            padding: 1.5rem;
            text-align: center;
            backdrop-filter: blur(10px);
        }

        .summary-value {
            font-size: 1.8rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .application-item {
            border-left: 4px solid var(--primary-color);
            transition: all 0.2s ease;
        }

        .application-item:hover {
            border-left-color: var(--success-color);
        }

        .btn-financial {
            background: linear-gradient(135deg, var(--primary-color) 0%, #3b82f6 100%);
            border: none;
            border-radius: 6px;
            color: white;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .btn-financial:hover {
            background: linear-gradient(135deg, #1e40af 0%, var(--primary-color) 100%);
            color: white;
            transform: translateY(-1px);
        }

        .btn-rate-update {
            background: var(--success-color);
            border: none;
            border-radius: 4px;
            color: white;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .btn-rate-update:hover {
            background: #047857;
            color: white;
        }

        .btn-edit {
            background: var(--warning-color);
            border: none;
            color: white;
        }

        .btn-edit:hover {
            background: #b45309;
            color: white;
        }

        .btn-delete {
            background: var(--danger-color);
            border: none;
            color: white;
        }

        .btn-delete:hover {
            background: #b91c1c;
            color: white;
        }

        .metric-today {
            background: rgba(14, 165, 233, 0.1);
            border: 1px solid rgba(14, 165, 233, 0.3);
            border-radius: 6px;
            padding: 1rem;
        }

        .metric-maturity {
            background: rgba(5, 150, 105, 0.1);
            border: 1px solid rgba(5, 150, 105, 0.3);
            border-radius: 6px;
            padding: 1rem;
        }

        .form-control:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(30, 58, 138, 0.25);
        }

        .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(30, 58, 138, 0.25);
        }

        .table-financial {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .table-financial th {
            background: var(--primary-color);
            color: white;
            border: none;
            font-weight: 500;
        }

        .table-financial td {
            border-color: #e2e8f0;
            vertical-align: middle;
        }

        .positive {
            color: var(--success-color);
            font-weight: 600;
        }

        .negative {
            color: var(--danger-color);
            font-weight: 600;
        }

        .badge-investment {
            background: var(--primary-color);
            font-size: 0.75rem;
            padding: 0.5rem 0.75rem;
        }

        .patrimonio-consolidado {
            background: linear-gradient(135deg, #1e3a8a 0%, #64748b 100%);
            border-radius: 12px;
            color: white;
            padding: 1.5rem;
        }

        .patrimonio-metric {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
            backdrop-filter: blur(10px);
            transition: transform 0.2s ease;
        }

        .patrimonio-metric:hover {
            transform: translateY(-2px);
        }

        @media (max-width: 768px) {
            .financial-header {
                padding: 1rem 0;
            }
            
            .summary-value {
                font-size: 1.4rem;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="financial-header">
        <div class="container">
            <div class="text-center">
                <h1 class="display-5 fw-bold mb-2">üè¶ Controlador de Aplica√ß√µes Financeiras</h1>
                <p class="lead mb-0">Gerencie seu portf√≥lio com c√°lculos precisos de tributa√ß√£o e rentabilidade</p>
            </div>
        </div>
    </header>

    <div class="container my-4">
        
        <!-- Painel de Taxas de Refer√™ncia -->
        <div class="rates-section">
            <h2 class="h4 fw-bold mb-4">üìä Taxas de Refer√™ncia</h2>
            <div class="row g-3">
                <div class="col-md-4">
                    <div class="rate-input-group">
                        <label class="form-label fw-bold">Taxa CDI (%)</label>
                        <div class="input-group">
                            <input type="number" id="taxaCDI" class="form-control text-center" value="14.90" step="0.01">
                            <button class="btn btn-rate-update" type="button" onclick="atualizarCDI()">Atualizar</button>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="rate-input-group">
                        <label class="form-label fw-bold">Taxa SELIC (%)</label>
                        <div class="input-group">
                            <input type="number" id="taxaSELIC" class="form-control text-center" value="15.00" step="0.01">
                            <button class="btn btn-rate-update" type="button" onclick="atualizarSELIC()">Atualizar</button>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="rate-input-group">
                        <label class="form-label fw-bold">Taxa Poupan√ßa (% ao m√™s)</label>
                        <div class="input-group">
                            <input type="number" id="taxaPoupanca" class="form-control text-center" value="0.6721" step="0.0001">
                            <button class="btn btn-rate-update" type="button" onclick="atualizarPoupanca()">Atualizar</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Formul√°rio de Nova Aplica√ß√£o -->
            <div class="col-lg-6">
                <div class="card financial-card">
                    <div class="card-header bg-white">
                        <h3 class="h5 mb-0 fw-bold text-primary">‚ûï Nova Aplica√ß√£o</h3>
                    </div>
                    <div class="card-body">
                        <form id="formAplicacao">
                            <div class="mb-3">
                                <label for="tipoAplicacao" class="form-label fw-semibold">Tipo de Aplica√ß√£o</label>
                                <select id="tipoAplicacao" class="form-select" required onchange="ajustarFormulario()">
                                    <option value="">Selecione...</option>
                                    <option value="CDB">CDB - Certificado de Dep√≥sito Banc√°rio</option>
                                    <option value="CCI">CCI - Certificado de Cr√©dito Imobili√°rio</option>
                                    <option value="LCA">LCA - Letra de Cr√©dito do Agroneg√≥cio</option>
                                    <option value="Poupan√ßa">Poupan√ßa</option>
                                    <option value="Fundo DI">Fundo DI</option>
                                </select>
                            </div>

                            <div class="mb-3">
                                <label for="tipoTaxa" class="form-label fw-semibold">Tipo de Taxa</label>
                                <select id="tipoTaxa" class="form-select" required onchange="ajustarFormulario()">
                                    <option value="">Selecione...</option>
                                    <option value="CDI">CDI - Baseada no √≠ndice CDI</option>
                                    <option value="PRE">Pr√©-fixada - Taxa fixa contratada</option>
                                </select>
                            </div>

                            <div class="mb-3">
                                <label for="valorAplicado" class="form-label fw-semibold">Valor Aplicado (R$)</label>
                                <input type="number" id="valorAplicado" class="form-control" step="0.01" min="0" required>
                            </div>

                            <div class="row g-2 mb-3">
                                <div class="col-6">
                                    <label for="dataAplicacao" class="form-label fw-semibold">Data da Aplica√ß√£o</label>
                                    <input type="date" id="dataAplicacao" class="form-control" required>
                                </div>
                                <div class="col-6">
                                    <label for="dataResgate" class="form-label fw-semibold">Data de Resgate (Opcional)</label>
                                    <input type="date" id="dataResgate" class="form-control" placeholder="Deixe vazio se liquidez di√°ria">
                                    <small class="text-muted">Deixe vazio para aplica√ß√µes com liquidez di√°ria</small>
                                </div>
                            </div>

                            <div class="mb-3" id="grupoPorcentagemCDI">
                                <label for="porcentagemCDI" class="form-label fw-semibold">Porcentagem do CDI (%)</label>
                                <input type="number" id="porcentagemCDI" class="form-control" step="0.01" min="0" placeholder="Ex: 130">
                            </div>

                            <div class="mb-3" id="grupoTaxaPreFixada" style="display: none;">
                                <label for="taxaPreFixada" class="form-label fw-semibold">Taxa Pr√©-fixada (% ao ano)</label>
                                <input type="number" id="taxaPreFixada" class="form-control" step="0.01" min="0" placeholder="Ex: 16.00">
                            </div>

                            <div class="mb-3">
                                <label for="banco" class="form-label fw-semibold">üè¶ Banco/Institui√ß√£o (Opcional)</label>
                                <input type="text" id="banco" class="form-control" placeholder="Ex: XP Investimentos, Nubank, BTG...">
                            </div>

                            <div class="mb-3" id="grupoTaxaAdmin" style="display: none;">
                                <label for="taxaAdmin" class="form-label fw-semibold">Taxa de Administra√ß√£o (% ao ano)</label>
                                <input type="number" id="taxaAdmin" class="form-control" step="0.01" min="0" placeholder="Ex: 1.5">
                            </div>

                            <button type="submit" class="btn btn-financial w-100 py-2">Adicionar Aplica√ß√£o</button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Resumo do Portf√≥lio -->
            <div class="col-lg-6">
                <div class="portfolio-summary">
                    <h3 class="h5 fw-bold mb-4">üí∞ Resumo do Portf√≥lio</h3>
                    <div class="row g-3">
                        <div class="col-6">
                            <div class="summary-metric">
                                <div class="summary-value" id="totalAplicado">R$ 0,00</div>
                                <div class="small">Total Aplicado</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="summary-metric">
                                <div class="summary-value" id="valorHoje">R$ 0,00</div>
                                <div class="small">üí∞ Valor Hoje</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="summary-metric">
                                <div class="summary-value" id="valorVencimento">R$ 0,00</div>
                                <div class="small">üéØ No Vencimento</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="summary-metric">
                                <div class="summary-value" id="rentabilidadeHoje">0,00%</div>
                                <div class="small">Rentab. Atual</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sistema de Backup -->
        <div class="card financial-card mt-4">
            <div class="card-header" style="background: linear-gradient(135deg, #059669 0%, #10b981 100%); color: white;">
                <h3 class="h5 mb-0 fw-bold">üíæ Sistema de Backup</h3>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <h6 class="fw-bold text-success mb-2">üì§ Exportar Dados</h6>
                        <p class="small text-muted mb-3">Fa√ßa backup de todas suas aplica√ß√µes e configura√ß√µes</p>
                        <button class="btn btn-success w-100" onclick="exportarBackup()">
                            üì§ Baixar Backup JSON
                        </button>
                    </div>
                    <div class="col-md-6">
                        <h6 class="fw-bold text-info mb-2">üì• Importar Dados</h6>
                        <p class="small text-muted mb-3">Restaure seus dados de um arquivo de backup</p>
                        <label for="inputBackup" class="btn btn-info w-100" style="cursor: pointer; margin-bottom: 0;">
                            üì• Carregar Backup JSON
                            <input type="file" id="inputBackup" class="d-none" accept=".json" onchange="importarBackup(event)">
                        </label>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <div class="alert alert-warning small mb-0">
                            <strong>‚ö†Ô∏è Importante:</strong> O backup inclui todas aplica√ß√µes, taxas de refer√™ncia e configura√ß√µes. 
                            Ao importar, todos os dados atuais ser√£o substitu√≠dos pelos dados do arquivo.
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Lista de Aplica√ß√µes -->
        <div class="card financial-card mt-4">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h3 class="h5 mb-0 fw-bold text-primary">üìã Minhas Aplica√ß√µes</h3>
                <span class="badge bg-primary" id="contadorAplicacoes">0 aplica√ß√µes</span>
            </div>
            <div class="card-body">
                <div id="listaAplicacoes">
                    <div class="text-center text-muted py-5">
                        <i class="fas fa-chart-line fa-3x mb-3"></i>
                        <p class="lead">Nenhuma aplica√ß√£o cadastrada ainda.</p>
                        <p>Adicione sua primeira aplica√ß√£o usando o formul√°rio acima!</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Patrim√¥nio Consolidado -->
        <div class="card financial-card mt-4" id="patrimonioConsolidado" style="display: none;">
            <div class="card-header" style="background: linear-gradient(135deg, #1e3a8a 0%, #64748b 100%); color: white;">
                <h3 class="h5 mb-0 fw-bold">üíº Patrim√¥nio Consolidado</h3>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-3">
                        <div class="text-center p-3" style="background: rgba(30, 58, 138, 0.1); border-radius: 8px;">
                            <div class="h5 mb-1 text-primary fw-bold" id="patrimonioTotalAplicado">R$ 0,00</div>
                            <small class="text-muted">Total Aplicado</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center p-3" style="background: rgba(2, 132, 199, 0.1); border-radius: 8px;">
                            <div class="h5 mb-1 fw-bold" style="color: #0284c7;" id="patrimonioValorHoje">R$ 0,00</div>
                            <small class="text-muted">üí∞ Valor Hoje</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center p-3" style="background: rgba(5, 150, 105, 0.1); border-radius: 8px;">
                            <div class="h5 mb-1 fw-bold" style="color: #059669;" id="patrimonioValorVencimento">R$ 0,00</div>
                            <small class="text-muted">üéØ No Vencimento</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center p-3" style="background: rgba(5, 150, 105, 0.1); border-radius: 8px;">
                            <div class="h5 mb-1 fw-bold" style="color: #059669;" id="patrimonioGanhoTotal">R$ 0,00</div>
                            <small class="text-muted">üìà Ganho Total</small>
                        </div>
                    </div>
                </div>
                <hr>
                <div class="row g-2">
                    <div class="col-md-4">
                        <small class="text-muted">Rendimento Atual:</small>
                        <strong class="text-info d-block" id="patrimonioRendimentoHoje">R$ 0,00 (0,00%)</strong>
                    </div>
                    <div class="col-md-4">
                        <small class="text-muted">Rendimento Projetado:</small>
                        <strong class="text-success d-block" id="patrimonioRendimentoVencimento">R$ 0,00 (0,00%)</strong>
                    </div>
                    <div class="col-md-4">
                        <small class="text-muted">Ganho Adicional:</small>
                        <strong class="text-warning d-block" id="patrimonioGanhoAdicional">R$ 0,00 (0,00%)</strong>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabela de Compara√ß√£o -->
        <div class="card financial-card mt-4" id="secaoComparacao" style="display: none;">
            <div class="card-header bg-white">
                <h3 class="h5 mb-0 fw-bold text-primary">üìà Compara√ß√£o de Aplica√ß√µes</h3>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-financial table-hover">
                        <thead>
                            <tr>
                                <th>Aplica√ß√£o</th>
                                <th>Taxa</th>
                                <th>Valor Aplicado</th>
                                <th>Per√≠odo (dias)</th>
                                <th>Valor Hoje</th>
                                <th>Valor Vencimento</th>
                                <th>Rentab. Hoje</th>
                                <th>Impostos Hoje</th>
                            </tr>
                        </thead>
                        <tbody id="tabelaComparacao">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap 5.3.7 JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js" integrity="sha384-ndDqU0Gzau9qJ1lfW4pNLlhNTkCfHzAVBReH9diLvGRem5+R9g2FzA8ZGN954O5Q" crossorigin="anonymous"></script>

    <script>
        // ========================================
        // üè¶ CONTROLADOR FINANCEIRO BOOTSTRAP 5.3.7
        // ========================================
        // ‚úÖ Dois cen√°rios de c√°lculo: HOJE vs VENCIMENTO
        // ‚úÖ Impostos corretos por per√≠odo espec√≠fico  
        // ‚úÖ Patrim√¥nio consolidado com proje√ß√µes
        // ‚úÖ Taxas de refer√™ncia atualiz√°veis via CDN oficial
        // ‚úÖ Campos opcionais (banco, data resgate)
        // ‚úÖ Interface responsiva e profissional
        // ========================================
        
        // Dados globais
        let aplicacoes = [];
        let contadorId = 1;
        let editandoId = null;

        // Configura√ß√£o inicial - data de hoje no formato correto
        const hoje = new Date();
        const dataHojeFormatada = `${hoje.getFullYear()}-${String(hoje.getMonth() + 1).padStart(2, '0')}-${String(hoje.getDate()).padStart(2, '0')}`;
        document.getElementById('dataAplicacao').value = dataHojeFormatada;
        
        // Ajustar formul√°rio baseado no tipo de aplica√ß√£o
        function ajustarFormulario() {
            const tipo = document.getElementById('tipoAplicacao').value;
            const tipoTaxa = document.getElementById('tipoTaxa').value;
            const grupoPorcentagemCDI = document.getElementById('grupoPorcentagemCDI');
            const grupoTaxaPreFixada = document.getElementById('grupoTaxaPreFixada');
            const grupoTaxaAdmin = document.getElementById('grupoTaxaAdmin');
            
            // Reset all fields
            grupoPorcentagemCDI.style.display = 'none';
            grupoTaxaPreFixada.style.display = 'none';
            grupoTaxaAdmin.style.display = 'none';
            
            // Show admin fee for Fundo DI
            if (tipo === 'Fundo DI') {
                grupoTaxaAdmin.style.display = 'block';
            }
            
            // Configure based on rate type
            if (tipoTaxa === 'CDI') {
                if (tipo !== 'Poupan√ßa') {
                    grupoPorcentagemCDI.style.display = 'block';
                    if (tipo === 'Fundo DI') {
                        document.getElementById('porcentagemCDI').placeholder = "Ex: 100 (para fundos DI)";
                    } else {
                        document.getElementById('porcentagemCDI').placeholder = "Ex: 130";
                    }
                }
            } else if (tipoTaxa === 'PRE') {
                if (tipo !== 'Poupan√ßa') {
                    grupoTaxaPreFixada.style.display = 'block';
                }
            }
            
            // Poupan√ßa doesn't use CDI or Pre-fixed rates
            if (tipo === 'Poupan√ßa') {
                document.getElementById('tipoTaxa').value = '';
                document.getElementById('tipoTaxa').disabled = true;
            } else {
                document.getElementById('tipoTaxa').disabled = false;
            }
        }

        // Fun√ß√£o para converter data string para data local (sem problemas de fuso hor√°rio)
        function formatarDataLocal(dataString) {
            if (!dataString) return '';
            const [ano, mes, dia] = dataString.split('-');
            const data = new Date(parseInt(ano), parseInt(mes) - 1, parseInt(dia));
            return data.toLocaleDateString('pt-BR');
        }

        // Calcular dias √∫teis (aproxima√ß√£o - corrigido para fuso hor√°rio local)
        function calcularDiasUteis(dataInicio, dataFim) {
            if (!dataInicio || !dataFim) return 0;
            
            const diasCorridos = calcularDiasCorridos(dataInicio, dataFim);
            
            // Aproxima√ß√£o: 70% dos dias s√£o √∫teis
            return Math.round(diasCorridos * 0.7);
        }

        // Calcular dias corridos (corrigido para fuso hor√°rio local)
        function calcularDiasCorridos(dataInicio, dataFim) {
            if (!dataInicio || !dataFim) return 0;
            
            // Criar datas no fuso hor√°rio local
            const [anoInicio, mesInicio, diaInicio] = dataInicio.split('-');
            const [anoFim, mesFim, diaFim] = dataFim.split('-');
            
            const inicio = new Date(parseInt(anoInicio), parseInt(mesInicio) - 1, parseInt(diaInicio));
            const fim = new Date(parseInt(anoFim), parseInt(mesFim) - 1, parseInt(diaFim));
            
            const diffTime = Math.abs(fim - inicio);
            return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        }

        // Calcular IR baseado no prazo
        function calcularIR(dias) {
            if (dias <= 180) return 0.225; // 22,5%
            if (dias <= 360) return 0.20;  // 20%
            if (dias <= 720) return 0.175; // 17,5%
            return 0.15; // 15%
        }

        // Calcular IOF baseado no prazo
        function calcularIOF(dias) {
            if (dias >= 30) return 0;
            
            // Tabela regressiva do IOF
            const tabelaIOF = [
                96, 93, 90, 86, 83, 80, 76, 73, 70, 66, 63, 60, 56, 53, 50,
                46, 43, 40, 36, 33, 30, 26, 23, 20, 16, 13, 10, 6, 3, 0
            ];
            
            return (tabelaIOF[dias] || 0) / 100;
        }

        // Calcular rentabilidade CORRIGIDO - Dois cen√°rios independentes
        function calcularRentabilidade(aplicacao) {
            const taxaCDI = parseFloat(document.getElementById('taxaCDI').value) / 100;
            
            // Data de hoje no formato correto (YYYY-MM-DD) no fuso hor√°rio local
            const hoje = new Date();
            const dataHoje = `${hoje.getFullYear()}-${String(hoje.getMonth() + 1).padStart(2, '0')}-${String(hoje.getDate()).padStart(2, '0')}`;
            
            // CEN√ÅRIO 1: C√°lculos para HOJE (per√≠odo desde aplica√ß√£o at√© hoje)
            const diasCorridosHoje = calcularDiasCorridos(aplicacao.dataAplicacao, dataHoje);
            const diasUteisHoje = calcularDiasUteis(aplicacao.dataAplicacao, dataHoje);
            
            // Verificar se tem data de resgate
            const temDataResgate = aplicacao.dataResgate && aplicacao.dataResgate.trim() !== '';
            
            // CEN√ÅRIO 2: C√°lculos para VENCIMENTO (per√≠odo total at√© vencimento)
            let diasCorridosVencimento = diasCorridosHoje;
            let diasUteisVencimento = diasUteisHoje;
            
            if (temDataResgate) {
                diasCorridosVencimento = calcularDiasCorridos(aplicacao.dataAplicacao, aplicacao.dataResgate);
                diasUteisVencimento = calcularDiasUteis(aplicacao.dataAplicacao, aplicacao.dataResgate);
            }
            
            // Fun√ß√£o auxiliar para calcular rentabilidade por per√≠odo espec√≠fico
            function calcularPorPeriodo(diasCorr, diasUt, cenario = 'hoje') {
                let rentabilidadeBruta = 0;
                
                if (aplicacao.tipo === 'Poupan√ßa') {
                    // Poupan√ßa: usar taxa mensal direta (0,6721% ao m√™s)
                    const taxaPoupancaMensal = parseFloat(document.getElementById('taxaPoupanca').value) / 100;
                    const meses = diasCorr / 30; // Aproxima√ß√£o para meses
                    rentabilidadeBruta = Math.pow(1 + taxaPoupancaMensal, meses) - 1;
                } else if (aplicacao.tipoTaxa === 'PRE') {
                    // Taxa Pr√©-fixada
                    const taxaPreFixada = aplicacao.taxaPreFixada / 100;
                    rentabilidadeBruta = Math.pow(1 + taxaPreFixada, diasCorr / 365) - 1;
                } else {
                    // Taxa baseada no CDI
                    const taxaEfetiva = taxaCDI * (aplicacao.porcentagemCDI / 100);
                    rentabilidadeBruta = Math.pow(1 + taxaEfetiva, diasUt / 252) - 1;
                }
                
                // Deduzir taxa de administra√ß√£o para Fundo DI
                if (aplicacao.tipo === 'Fundo DI' && aplicacao.taxaAdmin) {
                    const taxaAdminDiaria = aplicacao.taxaAdmin / 100 / 365;
                    rentabilidadeBruta -= (taxaAdminDiaria * diasCorr);
                }
                
                const valorBruto = aplicacao.valorAplicado * (1 + rentabilidadeBruta);
                const rendimentoBruto = valorBruto - aplicacao.valorAplicado;
                
                // Calcular impostos (IR baseado no per√≠odo espec√≠fico)
                let ir = 0;
                let iof = 0;
                
                if (aplicacao.tipo !== 'LCA' && aplicacao.tipo !== 'Poupan√ßa') {
                    ir = rendimentoBruto * calcularIR(diasCorr); // IR baseado no per√≠odo correto
                }
                
                if (aplicacao.tipo !== 'Poupan√ßa') {
                    iof = rendimentoBruto * calcularIOF(diasCorr); // IOF baseado no per√≠odo correto
                }
                
                const impostoTotal = ir + iof;
                const rendimentoLiquido = rendimentoBruto - impostoTotal;
                const valorLiquido = aplicacao.valorAplicado + rendimentoLiquido;
                const rentabilidadeLiquida = rendimentoLiquido / aplicacao.valorAplicado;
                
                return {
                    diasCorridos: diasCorr,
                    diasUteis: diasUt,
                    rentabilidadeBruta,
                    rentabilidadeLiquida,
                    valorBruto,
                    valorLiquido,
                    rendimentoBruto,
                    rendimentoLiquido,
                    ir,
                    iof,
                    impostoTotal
                };
            }
            
            // Calcular os dois cen√°rios independentemente
            const resultadoHoje = calcularPorPeriodo(diasCorridosHoje, diasUteisHoje, 'hoje');
            const resultadoVencimento = temDataResgate ? 
                calcularPorPeriodo(diasCorridosVencimento, diasUteisVencimento, 'vencimento') : 
                resultadoHoje;
            
            return {
                // Para compatibilidade com c√≥digo existente (valores do vencimento)
                diasCorridos: diasCorridosVencimento,
                diasUteis: diasUteisVencimento,
                rentabilidadeBruta: resultadoVencimento.rentabilidadeBruta,
                rentabilidadeLiquida: resultadoVencimento.rentabilidadeLiquida,
                valorBruto: resultadoVencimento.valorBruto,
                valorLiquido: resultadoVencimento.valorLiquido,
                rendimentoBruto: resultadoVencimento.rendimentoBruto,
                rendimentoLiquido: resultadoVencimento.rendimentoLiquido,
                ir: resultadoVencimento.ir,
                iof: resultadoVencimento.iof,
                impostoTotal: resultadoVencimento.impostoTotal,
                
                // Novos dados separados por cen√°rio
                hoje: resultadoHoje,
                vencimento: resultadoVencimento,
                temDataResgate: temDataResgate,
                
                // Dados adicionais para controle
                diasCorridosHoje: diasCorridosHoje,
                diasCorridosVencimento: diasCorridosVencimento
            };
        }

        // Editar aplica√ß√£o existente
        function editarAplicacao(id) {
            const aplicacao = aplicacoes.find(app => app.id === id);
            if (!aplicacao) return;
            
            // Preencher formul√°rio com dados existentes
            document.getElementById('tipoAplicacao').value = aplicacao.tipo;
            document.getElementById('tipoTaxa').value = aplicacao.tipoTaxa || '';
            document.getElementById('valorAplicado').value = aplicacao.valorAplicado;
            document.getElementById('dataAplicacao').value = aplicacao.dataAplicacao;
            document.getElementById('dataResgate').value = aplicacao.dataResgate || '';
            document.getElementById('porcentagemCDI').value = aplicacao.porcentagemCDI || '';
            document.getElementById('taxaPreFixada').value = aplicacao.taxaPreFixada || '';
            document.getElementById('taxaAdmin').value = aplicacao.taxaAdmin || '';
            document.getElementById('banco').value = aplicacao.banco || '';
            
            // Ajustar formul√°rio baseado no tipo
            ajustarFormulario();
            
            // Marcar como editando
            editandoId = id;
            
            // Atualizar interface do formul√°rio
            atualizarInterfaceEdicao(true);
            
            // Scroll para o formul√°rio
            document.querySelector('.card').scrollIntoView({ behavior: 'smooth' });
        }

        // Cancelar edi√ß√£o
        function cancelarEdicao() {
            editandoId = null;
            document.getElementById('formAplicacao').reset();
            const hoje = new Date();
            const dataHojeFormatada = `${hoje.getFullYear()}-${String(hoje.getMonth() + 1).padStart(2, '0')}-${String(hoje.getDate()).padStart(2, '0')}`;
            document.getElementById('dataAplicacao').value = dataHojeFormatada;
            document.getElementById('tipoTaxa').disabled = false; // Reabilitar campo
            ajustarFormulario();
            atualizarInterfaceEdicao(false);
        }

        // Atualizar interface do formul√°rio para edi√ß√£o
        function atualizarInterfaceEdicao(editando) {
            const cardHeader = document.querySelector('.card-header h3');
            const botaoSubmit = document.querySelector('button[type="submit"]');
            
            if (editando) {
                cardHeader.innerHTML = '‚úèÔ∏è Editando Aplica√ß√£o';
                cardHeader.className = 'h5 mb-0 fw-bold text-warning';
                botaoSubmit.innerHTML = 'Atualizar Aplica√ß√£o';
                botaoSubmit.className = 'btn btn-warning w-100 py-2';
                
                // Adicionar bot√£o cancelar se n√£o existir
                if (!document.getElementById('btnCancelar')) {
                    const btnCancelar = document.createElement('button');
                    btnCancelar.id = 'btnCancelar';
                    btnCancelar.type = 'button';
                    btnCancelar.className = 'btn btn-secondary w-100 py-2 mt-2';
                    btnCancelar.innerHTML = 'Cancelar Edi√ß√£o';
                    btnCancelar.onclick = cancelarEdicao;
                    botaoSubmit.parentNode.appendChild(btnCancelar);
                }
            } else {
                cardHeader.innerHTML = '‚ûï Nova Aplica√ß√£o';
                cardHeader.className = 'h5 mb-0 fw-bold text-primary';
                botaoSubmit.innerHTML = 'Adicionar Aplica√ß√£o';
                botaoSubmit.className = 'btn btn-financial w-100 py-2';
                
                // Remover bot√£o cancelar se existir
                const btnCancelar = document.getElementById('btnCancelar');
                if (btnCancelar) {
                    btnCancelar.remove();
                }
            }
        }

        // Adicionar nova aplica√ß√£o ou atualizar existente
        document.getElementById('formAplicacao').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const dadosAplicacao = {
                tipo: document.getElementById('tipoAplicacao').value,
                tipoTaxa: document.getElementById('tipoTaxa').value,
                valorAplicado: parseFloat(document.getElementById('valorAplicado').value),
                dataAplicacao: document.getElementById('dataAplicacao').value,
                dataResgate: document.getElementById('dataResgate').value || null,
                porcentagemCDI: parseFloat(document.getElementById('porcentagemCDI').value) || null,
                taxaPreFixada: parseFloat(document.getElementById('taxaPreFixada').value) || null,
                taxaAdmin: parseFloat(document.getElementById('taxaAdmin').value) || null,
                banco: document.getElementById('banco').value || null
            };
            
            // Valida√ß√£o b√°sica
            if (!dadosAplicacao.tipo || !dadosAplicacao.valorAplicado || !dadosAplicacao.dataAplicacao || !dadosAplicacao.tipoTaxa) {
                alert('‚ùå Por favor, preencha todos os campos obrigat√≥rios!');
                return;
            }
            
            // Validar data de resgate se informada
            if (dadosAplicacao.dataResgate) {
                const [anoAplicacao, mesAplicacao, diaAplicacao] = dadosAplicacao.dataAplicacao.split('-');
                const [anoResgate, mesResgate, diaResgate] = dadosAplicacao.dataResgate.split('-');
                
                const dataAplicacao = new Date(parseInt(anoAplicacao), parseInt(mesAplicacao) - 1, parseInt(diaAplicacao));
                const dataResgate = new Date(parseInt(anoResgate), parseInt(mesResgate) - 1, parseInt(diaResgate));
                
                if (dataResgate <= dataAplicacao) {
                    alert('‚ùå A data de resgate deve ser posterior √† data de aplica√ß√£o!');
                    return;
                }
            }
            
            if (editandoId) {
                // Atualizar aplica√ß√£o existente
                const index = aplicacoes.findIndex(app => app.id === editandoId);
                if (index !== -1) {
                    aplicacoes[index] = { ...aplicacoes[index], ...dadosAplicacao };
                }
                
                // Sair do modo edi√ß√£o
                cancelarEdicao();
            } else {
                // Adicionar nova aplica√ß√£o
                const novaAplicacao = {
                    id: contadorId++,
                    ...dadosAplicacao
                };
                
                aplicacoes.push(novaAplicacao);
                
                // Limpar formul√°rio
                document.getElementById('formAplicacao').reset();
                const hoje = new Date();
                const dataHojeFormatada = `${hoje.getFullYear()}-${String(hoje.getMonth() + 1).padStart(2, '0')}-${String(hoje.getDate()).padStart(2, '0')}`;
                document.getElementById('dataAplicacao').value = dataHojeFormatada;
                document.getElementById('tipoTaxa').disabled = false; // Reabilitar campo
                ajustarFormulario();
            }
            
            // Atualizar interface
            renderizarAplicacoes();
            atualizarResumo();
            atualizarComparacao();
            atualizarContadorAplicacoes();
        });

        // Renderizar lista de aplica√ß√µes
        function renderizarAplicacoes() {
            const container = document.getElementById('listaAplicacoes');
            
            if (aplicacoes.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted py-5">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">üìä</div>
                        <p class="lead">Nenhuma aplica√ß√£o cadastrada ainda.</p>
                        <p>Adicione sua primeira aplica√ß√£o usando o formul√°rio acima!</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = aplicacoes.map(aplicacao => {
                const calc = calcularRentabilidade(aplicacao);
                const tipoTaxaLabel = aplicacao.tipoTaxa === 'PRE' ? 'Pr√©-fixada' : aplicacao.tipoTaxa === 'CDI' ? 'CDI' : 'Poupan√ßa';
                
                return `
                    <div class="card application-item mb-3">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <div>
                                    <span class="badge badge-investment">${aplicacao.tipo}</span>
                                    ${aplicacao.banco ? `<div class="text-muted small mt-1">üè¶ ${aplicacao.banco}</div>` : ''}
                                    <h6 class="card-title mt-2 mb-1">${tipoTaxaLabel}</h6>
                                </div>
                                <div class="text-end">
                                    <h5 class="text-primary mb-0">R$ ${aplicacao.valorAplicado.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</h5>
                                    <small class="text-muted">${calc.temDataResgate ? `${calc.diasCorridosHoje} dias (hoje) / ${calc.diasCorridosVencimento} dias (total)` : 'Liquidez di√°ria'}</small>
                                </div>
                            </div>
                            
                            <div class="row g-2 mb-3">
                                ${calc.temDataResgate ? `
                                <div class="col-md-6">
                                    <div class="metric-today text-center">
                                        <div class="fw-bold text-info">üí∞ Valor Hoje</div>
                                        <div class="h6 mb-1">R$ ${calc.hoje.valorLiquido.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</div>
                                        <small class="text-muted">
                                            +R$ ${calc.hoje.rendimentoLiquido.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}
                                            (${(calc.hoje.rentabilidadeLiquida * 100).toFixed(2)}%)
                                        </small>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="metric-maturity text-center">
                                        <div class="fw-bold text-success">üéØ No Vencimento</div>
                                        <div class="h6 mb-1">R$ ${calc.vencimento.valorLiquido.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</div>
                                        <small class="text-muted">
                                            +R$ ${calc.vencimento.rendimentoLiquido.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}
                                            (${(calc.vencimento.rentabilidadeLiquida * 100).toFixed(2)}%)
                                        </small>
                                    </div>
                                </div>
                                ` : `
                                <div class="col-12">
                                    <div class="metric-today text-center">
                                        <div class="fw-bold text-info">üí∞ Valor Atual (Liquidez Di√°ria)</div>
                                        <div class="h6 mb-1">R$ ${calc.hoje.valorLiquido.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</div>
                                        <small class="text-muted">
                                            +R$ ${calc.hoje.rendimentoLiquido.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}
                                            (${(calc.hoje.rentabilidadeLiquida * 100).toFixed(2)}%)
                                        </small>
                                    </div>
                                </div>
                                `}
                            </div>
                            
                            <div class="row g-2 mb-3">
                                <div class="col-6 col-md-3">
                                    <small class="text-muted d-block">Data Aplica√ß√£o</small>
                                    <strong>${formatarDataLocal(aplicacao.dataAplicacao)}</strong>
                                </div>
                                ${calc.temDataResgate ? `
                                <div class="col-6 col-md-3">
                                    <small class="text-muted d-block">Data Resgate</small>
                                    <strong>${formatarDataLocal(aplicacao.dataResgate)}</strong>
                                </div>
                                ` : `
                                <div class="col-6 col-md-3">
                                    <small class="text-muted d-block">Liquidez</small>
                                    <strong class="text-success">Di√°ria</strong>
                                </div>
                                `}
                                <div class="col-6 col-md-3">
                                    <small class="text-muted d-block">IR Hoje</small>
                                    <strong class="negative">R$ ${calc.hoje.ir.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</strong>
                                </div>
                                <div class="col-6 col-md-3">
                                    <small class="text-muted d-block">IOF</small>
                                    <strong class="negative">R$ ${calc.hoje.iof.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</strong>
                                </div>
                            </div>
                            
                            ${aplicacao.porcentagemCDI ? `
                                <div class="mb-2">
                                    <small class="text-muted">Porcentagem do CDI:</small>
                                    <strong> ${aplicacao.porcentagemCDI}%</strong>
                                </div>
                            ` : ''}
                            
                            ${aplicacao.taxaPreFixada ? `
                                <div class="mb-2">
                                    <small class="text-muted">Taxa Pr√©-fixada:</small>
                                    <strong> ${aplicacao.taxaPreFixada}% a.a.</strong>
                                </div>
                            ` : ''}
                            
                            ${aplicacao.taxaAdmin ? `
                                <div class="mb-2">
                                    <small class="text-muted">Taxa de Administra√ß√£o:</small>
                                    <strong> ${aplicacao.taxaAdmin}% a.a.</strong>
                                </div>
                            ` : ''}
                            
                            ${calc.temDataResgate ? `
                                <div class="row g-2 mt-2 pt-2" style="border-top: 1px solid #dee2e6;">
                                    <div class="col-12">
                                        <small class="text-muted fw-bold">üí° Impostos no Vencimento:</small>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-muted">IR Final:</small>
                                        <strong class="text-warning"> R$ ${calc.vencimento.ir.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</strong>
                                        <small class="text-muted"> (${(calcularIR(calc.diasCorridosVencimento) * 100).toFixed(1)}%)</small>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-muted">IOF Final:</small>
                                        <strong class="text-warning"> R$ ${calc.vencimento.iof.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</strong>
                                    </div>
                                </div>
                            ` : ''}
                            
                            <div class="d-flex gap-2 justify-content-end">
                                <button class="btn btn-edit btn-sm" onclick="editarAplicacao(${aplicacao.id})">
                                    Editar
                                </button>
                                <button class="btn btn-delete btn-sm" onclick="removerAplicacao(${aplicacao.id})">
                                    Remover
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Remover aplica√ß√£o
        function removerAplicacao(id) {
            if (confirm('Tem certeza que deseja remover esta aplica√ß√£o?')) {
                // Se estava editando a aplica√ß√£o que ser√° removida, cancelar edi√ß√£o
                if (editandoId === id) {
                    cancelarEdicao();
                }
                
                aplicacoes = aplicacoes.filter(app => app.id !== id);
                renderizarAplicacoes();
                atualizarResumo();
                atualizarComparacao();
                atualizarContadorAplicacoes();
            }
        }

        // Atualizar resumo do portf√≥lio CORRIGIDO
        function atualizarResumo() {
            let totalAplicado = 0;
            let totalHoje = 0;
            let totalVencimento = 0;
            
            aplicacoes.forEach(aplicacao => {
                const calc = calcularRentabilidade(aplicacao);
                totalAplicado += aplicacao.valorAplicado;
                totalHoje += calc.hoje.valorLiquido;
                totalVencimento += calc.vencimento.valorLiquido;
            });
            
            const rendimentoHoje = totalHoje - totalAplicado;
            const rendimentoVencimento = totalVencimento - totalAplicado;
            const rentabilidadeHoje = totalAplicado > 0 ? (rendimentoHoje / totalAplicado) * 100 : 0;
            const rentabilidadeVencimento = totalAplicado > 0 ? (rendimentoVencimento / totalAplicado) * 100 : 0;
            
            // Atualizar resumo principal
            document.getElementById('totalAplicado').textContent = 
                `R$ ${totalAplicado.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`;
            document.getElementById('valorHoje').textContent = 
                `R$ ${totalHoje.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`;
            document.getElementById('valorVencimento').textContent = 
                `R$ ${totalVencimento.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`;
            document.getElementById('rentabilidadeHoje').textContent = 
                `${rentabilidadeHoje.toFixed(2)}%`;
            
            // Atualizar patrim√¥nio consolidado
            atualizarPatrimonioConsolidado(totalAplicado, totalHoje, totalVencimento, rendimentoHoje, rendimentoVencimento, rentabilidadeHoje, rentabilidadeVencimento);
        }

        // Nova fun√ß√£o para atualizar patrim√¥nio consolidado
        function atualizarPatrimonioConsolidado(totalAplicado, totalHoje, totalVencimento, rendimentoHoje, rendimentoVencimento, rentabilidadeHoje, rentabilidadeVencimento) {
            const ganhoTotal = totalVencimento - totalHoje;
            const ganhoAdicionalPerc = totalHoje > 0 ? ((totalVencimento - totalHoje) / totalHoje) * 100 : 0;
            
            if (aplicacoes.length > 0) {
                document.getElementById('patrimonioConsolidado').style.display = 'block';
                
                document.getElementById('patrimonioTotalAplicado').textContent = 
                    `R$ ${totalAplicado.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`;
                document.getElementById('patrimonioValorHoje').textContent = 
                    `R$ ${totalHoje.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`;
                document.getElementById('patrimonioValorVencimento').textContent = 
                    `R$ ${totalVencimento.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`;
                document.getElementById('patrimonioGanhoTotal').textContent = 
                    `R$ ${ganhoTotal.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`;
                
                document.getElementById('patrimonioRendimentoHoje').textContent = 
                    `R$ ${rendimentoHoje.toLocaleString('pt-BR', { minimumFractionDigits: 2 })} (${rentabilidadeHoje.toFixed(2)}%)`;
                document.getElementById('patrimonioRendimentoVencimento').textContent = 
                    `R$ ${rendimentoVencimento.toLocaleString('pt-BR', { minimumFractionDigits: 2 })} (${rentabilidadeVencimento.toFixed(2)}%)`;
                document.getElementById('patrimonioGanhoAdicional').textContent = 
                    `R$ ${ganhoTotal.toLocaleString('pt-BR', { minimumFractionDigits: 2 })} (${ganhoAdicionalPerc.toFixed(2)}%)`;
            } else {
                document.getElementById('patrimonioConsolidado').style.display = 'none';
            }
        }

        // Atualizar tabela de compara√ß√£o
        function atualizarComparacao() {
            const secao = document.getElementById('secaoComparacao');
            const tabela = document.getElementById('tabelaComparacao');
            
            if (aplicacoes.length < 2) {
                secao.style.display = 'none';
                return;
            }
            
            secao.style.display = 'block';
            
            tabela.innerHTML = aplicacoes.map(aplicacao => {
                const calc = calcularRentabilidade(aplicacao);
                const tipoTaxaLabel = aplicacao.tipoTaxa === 'PRE' ? 'Pr√©-fixada' : aplicacao.tipoTaxa === 'CDI' ? 'CDI' : 'Poupan√ßa';
                const taxaInfo = aplicacao.taxaPreFixada ? `${aplicacao.taxaPreFixada}%` : 
                                aplicacao.porcentagemCDI ? `${aplicacao.porcentagemCDI}% CDI` : 'N/A';
                
                return `
                    <tr>
                        <td>
                            <strong>${aplicacao.tipo}</strong>
                            ${aplicacao.banco ? `<br><small class="text-primary">üè¶ ${aplicacao.banco}</small>` : ''}
                        </td>
                        <td>
                            ${tipoTaxaLabel}<br>
                            <small class="text-muted">${taxaInfo}</small>
                        </td>
                        <td>R$ ${aplicacao.valorAplicado.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</td>
                        <td>${calc.temDataResgate ? `${calc.diasCorridosHoje} / ${calc.diasCorridosVencimento}` : '<span class="text-success">Liquidez di√°ria</span>'}</td>
                        <td class="positive">R$ ${calc.hoje.valorLiquido.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</td>
                        <td class="positive">${calc.temDataResgate ? `R$ ${calc.vencimento.valorLiquido.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}` : '<span class="text-muted">N/A</span>'}</td>
                        <td class="positive">${(calc.hoje.rentabilidadeLiquida * 100).toFixed(2)}%</td>
                        <td class="negative">R$ ${(calc.hoje.ir + calc.hoje.iof).toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</td>
                    </tr>
                `;
            }).join('');
        }

        // ========================================
        // üíæ SISTEMA DE BACKUP JSON
        // ========================================
        
        // Exportar backup completo
        function exportarBackup() {
            const backup = {
                versao: "2.0",
                dataExportacao: new Date().toISOString(),
                totalAplicacoes: aplicacoes.length,
                aplicacoes: aplicacoes.map(app => ({
                    id: app.id,
                    tipo: app.tipo,
                    tipoTaxa: app.tipoTaxa,
                    valorAplicado: app.valorAplicado,
                    dataAplicacao: app.dataAplicacao,
                    dataResgate: app.dataResgate,
                    porcentagemCDI: app.porcentagemCDI,
                    taxaPreFixada: app.taxaPreFixada,
                    taxaAdmin: app.taxaAdmin,
                    banco: app.banco
                })),
                taxasReferencia: {
                    cdi: document.getElementById('taxaCDI').value,
                    selic: document.getElementById('taxaSELIC').value,
                    poupanca: document.getElementById('taxaPoupanca').value
                }
            };
            
            const jsonString = JSON.stringify(backup, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const agora = new Date();
            const dataFormatada = `${agora.getFullYear()}-${String(agora.getMonth() + 1).padStart(2, '0')}-${String(agora.getDate()).padStart(2, '0')}_${String(agora.getHours()).padStart(2, '0')}-${String(agora.getMinutes()).padStart(2, '0')}`;
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `backup_aplicacoes_financeiras_${dataFormatada}.json`;
            link.click();
            
            URL.revokeObjectURL(url);
            
            alert(`‚úÖ Backup exportado com sucesso!\n\nüìä Resumo:\n‚Ä¢ ${backup.totalAplicacoes} aplica√ß√µes\n‚Ä¢ Data: ${new Date(backup.dataExportacao).toLocaleString('pt-BR')}\n‚Ä¢ Vers√£o: ${backup.versao}\n\nüíæ Arquivo salvo como: backup_aplicacoes_financeiras_${dataFormatada}.json`);
        }
        
        // Importar backup
        function importarBackup(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const backup = JSON.parse(e.target.result);
                    
                    // Validar estrutura do backup
                    if (!backup.aplicacoes || !backup.taxasReferencia) {
                        throw new Error('Formato de backup inv√°lido');
                    }
                    
                    // Confirma√ß√£o antes de importar
                    const confirmar = confirm(`üîÑ IMPORTAR BACKUP\n\nüìä Dados do arquivo:\n‚Ä¢ Vers√£o: ${backup.versao || 'N/A'}\n‚Ä¢ Data: ${backup.dataExportacao ? new Date(backup.dataExportacao).toLocaleString('pt-BR') : 'N/A'}\n‚Ä¢ Aplica√ß√µes: ${backup.totalAplicacoes || backup.aplicacoes.length}\n\n‚ö†Ô∏è ATEN√á√ÉO: Todos os dados atuais ser√£o substitu√≠dos!\n\nDeseja continuar?`);
                    
                    if (!confirmar) {
                        // Limpar input
                        event.target.value = '';
                        return;
                    }
                    
                    // Restaurar aplica√ß√µes
                    aplicacoes = backup.aplicacoes.map(app => ({
                        id: app.id,
                        tipo: app.tipo,
                        tipoTaxa: app.tipoTaxa || 'CDI', // Compatibilidade
                        valorAplicado: app.valorAplicado,
                        dataAplicacao: app.dataAplicacao,
                        dataResgate: app.dataResgate || null,
                        porcentagemCDI: app.porcentagemCDI || null,
                        taxaPreFixada: app.taxaPreFixada || null,
                        taxaAdmin: app.taxaAdmin || null,
                        banco: app.banco || null
                    }));
                    
                    // Restaurar taxas de refer√™ncia
                    if (backup.taxasReferencia) {
                        document.getElementById('taxaCDI').value = backup.taxasReferencia.cdi || '14.90';
                        document.getElementById('taxaSELIC').value = backup.taxasReferencia.selic || '15.00';
                        document.getElementById('taxaPoupanca').value = backup.taxasReferencia.poupanca || '0.6721';
                    }
                    
                    // Ajustar contador de IDs
                    contadorId = aplicacoes.length > 0 ? Math.max(...aplicacoes.map(app => app.id)) + 1 : 1;
                    
                    // Atualizar interface
                    renderizarAplicacoes();
                    atualizarResumo();
                    atualizarComparacao();
                    atualizarContadorAplicacoes();
                    
                    // Limpar input
                    event.target.value = '';
                    
                    alert(`‚úÖ Backup importado com sucesso!\n\nüìä Dados restaurados:\n‚Ä¢ ${aplicacoes.length} aplica√ß√µes\n‚Ä¢ Taxas de refer√™ncia atualizadas\n‚Ä¢ Interface atualizada\n\nüéâ Seus investimentos foram restaurados!`);
                    
                } catch (error) {
                    alert(`‚ùå Erro ao importar backup!\n\nDetalhes: ${error.message}\n\nVerifique se o arquivo √© um backup v√°lido do Controlador Financeiro.`);
                    // Limpar input
                    event.target.value = '';
                }
            };
            
            reader.readAsText(file);
        }
        
        // Atualizar contador de aplica√ß√µes
        function atualizarContadorAplicacoes() {
            const contador = document.getElementById('contadorAplicacoes');
            const total = aplicacoes.length;
            contador.textContent = `${total} ${total === 1 ? 'aplica√ß√£o' : 'aplica√ß√µes'}`;
        }

        // Fun√ß√µes de atualiza√ß√£o das taxas
        async function atualizarCDI() {
            // Abrir site oficial em nova aba para confer√™ncia manual
            window.open('https://www.bcb.gov.br/htms/selic/selicdiarios.asp?frame=1', '_blank');
            
            // Atualizar com valor atual conforme refer√™ncia
            const novoValor = '14.90';
            document.getElementById('taxaCDI').value = novoValor;
            
            alert('‚úÖ Taxa CDI atualizada: 14,90% ao ano\n\nüîó Site oficial aberto para confer√™ncia!\n\nFonte: Banco Central do Brasil\n\nüí° Procure por "Taxa CDI" na p√°gina oficial para confirmar o valor atual.');
            
            // Recalcular todas as aplica√ß√µes
            renderizarAplicacoes();
            atualizarResumo();
            atualizarComparacao();
        }

        async function atualizarSELIC() {
            // Abrir site oficial em nova aba
            window.open('https://www.bcb.gov.br/controleinflacao/historicotaxasjuros', '_blank');
            
            // Atualizar com valor atual padr√£o
            const novoValor = '15.00';
            document.getElementById('taxaSELIC').value = novoValor;
            
            alert('‚úÖ Taxa SELIC atualizada: 15,00% ao ano\n\nüîó Site oficial aberto para confer√™ncia!\n\nFonte: Banco Central do Brasil\n\nüí° Procure por "Taxa b√°sica de juros" na p√°gina oficial para confirmar.');
            
            // Recalcular todas as aplica√ß√µes
            renderizarAplicacoes();
            atualizarResumo();
            atualizarComparacao();
        }

        async function atualizarPoupanca() {
            // Abrir site oficial em nova aba
            window.open('https://www.bcb.gov.br/estatisticas/remuneradepositospoupanca', '_blank');
            
            // Atualizar com valor atual mensal
            const taxaMensal = 0.6721;
            document.getElementById('taxaPoupanca').value = taxaMensal.toFixed(4);
            
            alert(`‚úÖ Taxa Poupan√ßa atualizada: ${taxaMensal}% ao m√™s\n\nüîó Site oficial aberto para confer√™ncia!\n\nFonte: Banco Central do Brasil\n\nüí° Valor mensal conforme tabela oficial do Banco Central.`);
            
            // Recalcular todas as aplica√ß√µes
            renderizarAplicacoes();
            atualizarResumo();
            atualizarComparacao();
        }

        // Inicializa√ß√£o
        renderizarAplicacoes();
        atualizarResumo();
        atualizarComparacao();
        atualizarContadorAplicacoes();
        
        console.log('üè¶ Controlador Financeiro Bootstrap 5.3.7 Iniciado!');
        console.log('‚úÖ Funcionalidades ativas:');
        console.log('  - C√°lculo separado: Valor Hoje vs Vencimento');
        console.log('  - Impostos corretos por per√≠odo');
        console.log('  - Patrim√¥nio consolidado');
        console.log('  - Taxas de refer√™ncia atualiz√°veis');
        console.log('  - üíæ Sistema de Backup JSON v2.0');
    </script>
</body>
</html>