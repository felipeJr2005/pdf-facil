<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OCR Tesseract.js v6</title>
    <style>
        body { font-family: sans-serif; max-width: 600px; margin: 0 auto; padding: 15px; }
        select, button { padding: 5px; margin: 5px 0; width: 100%; }
        .upload { border: 1px dashed #999; padding: 10px; text-align: center; cursor: pointer; margin: 10px 0; }
        img { max-width: 100%; max-height: 200px; margin: 10px 0; }
        #result { border: 1px solid #ddd; padding: 10px; min-height: 100px; margin-top: 10px; white-space: pre-wrap; }
        .hidden { display: none; }
        #log { font-family: monospace; font-size: 12px; margin-top: 10px; color: #666; }
        .warning { color: #d97706; font-size: 12px; margin-top: 5px; }
        .options { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin: 10px 0; }
        .options label { display: block; margin-bottom: 5px; }
        @media (max-width: 600px) { .options { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <h2>OCR com Tesseract.js v6</h2>
    
    <div class="upload" id="uploadArea">
        Selecione ou arraste uma imagem
        <input type="file" id="fileInput" accept="image/*" style="display:none">
    </div>
    
    <img id="preview" class="hidden">
    
    <div class="options">
        <div>
            <label>Idioma:</label>
            <select id="language">
                <option value="por">Português</option>
                <option value="eng">Inglês</option>
                <option value="spa">Espanhol</option>
                <option value="fra">Francês</option>
            </select>
        </div>
        
        <div>
            <label>Modo OCR:</label>
            <select id="ocrMode">
                <option value="1">LSTM (Recomendado)</option>
                <option value="0">Legado</option>
                <option value="2">Combinado</option>
            </select>
        </div>
        
        <div>
            <label>Segmentação:</label>
            <select id="segMode">
                <option value="1">Automática com OSD</option>
                <option value="3">Página completa</option>
                <option value="6">Bloco uniforme</option>
                <option value="7">Linha única</option>
            </select>
            <div class="warning" id="lineWarning" style="display:none">
                Nota: "Linha única" pode causar erros
            </div>
        </div>
    </div>
    
    <button id="processBtn" disabled>Processar</button>
    
    <div id="result"></div>
    <div id="log"></div>
    
    <script>
        // Elementos
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const preview = document.getElementById('preview');
        const language = document.getElementById('language');
        const ocrMode = document.getElementById('ocrMode');
        const segMode = document.getElementById('segMode');
        const lineWarning = document.getElementById('lineWarning');
        const processBtn = document.getElementById('processBtn');
        const result = document.getElementById('result');
        const log = document.getElementById('log');
        
        // Variáveis
        let selectedFile = null;
        
        // Eventos
        uploadArea.onclick = () => fileInput.click();
        fileInput.onchange = handleFile;
        processBtn.onclick = processImage;
        
        // Aviso para linha única
        segMode.onchange = () => {
            lineWarning.style.display = segMode.value === '7' ? 'block' : 'none';
        };
        
        // Upload (drag & drop)
        uploadArea.addEventListener('dragover', e => { e.preventDefault(); });
        uploadArea.addEventListener('drop', e => {
            e.preventDefault();
            if (e.dataTransfer.files.length) handleFile({ target: { files: e.dataTransfer.files } });
        });
        
        // Inicializar
        function init() {
            loadScript('https://cdn.jsdelivr.net/npm/tesseract.js@6/dist/tesseract.min.js')
                .then(() => logMsg('✓ Tesseract.js carregado'))
                .catch(err => logMsg('✗ Erro: ' + err.message));
        }
        
        // Carregar script
        function loadScript(src) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = src;
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }
        
        // Manipular arquivo
        function handleFile(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            selectedFile = file;
            processBtn.disabled = false;
            
            // Preview
            const reader = new FileReader();
            reader.onload = e => {
                preview.src = e.target.result;
                preview.classList.remove('hidden');
            };
            reader.readAsDataURL(file);
            
            logMsg(`Arquivo: ${file.name}`);
        }
        
        // Processar imagem
        async function processImage() {
            if (!selectedFile) return;
            
            const langValue = language.value;
            const ocrValue = ocrMode.value;
            const segValue = segMode.value;
            
            processBtn.disabled = true;
            result.textContent = 'Processando...';
            logMsg(`Iniciando OCR (Idioma: ${langValue}, Modo: ${ocrValue}, Segmentação: ${segValue})`);
            
            try {
                // Carregar imagem
                const reader = new FileReader();
                const imageData = await new Promise((resolve, reject) => {
                    reader.onload = e => resolve(e.target.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(selectedFile);
                });
                
                // Processar com Tesseract
                logMsg('Criando worker...');
                const worker = await Tesseract.createWorker(langValue);
                
                try {
                    logMsg('Configurando parâmetros...');
                    await worker.setParameters({
                        tessedit_ocr_engine_mode: ocrValue,
                        tessedit_pageseg_mode: segValue
                    });
                } catch (paramError) {
                    logMsg(`Aviso: erro nos parâmetros, usando modo padrão - ${paramError.message}`);
                    
                    // Se erro for com linha única, tente com página completa
                    if (segValue === '7') {
                        logMsg('Tentando com "Página completa" (3)');
                        try {
                            await worker.setParameters({
                                tessedit_ocr_engine_mode: ocrValue,
                                tessedit_pageseg_mode: '3'
                            });
                        } catch (e) {
                            logMsg('Usando configurações padrão');
                        }
                    }
                }
                
                logMsg('Reconhecendo texto...');
                const { data } = await worker.recognize(imageData);
                await worker.terminate();
                
                // Mostrar resultado
                result.textContent = data.text;
                logMsg('✓ OCR concluído!');
                
            } catch (error) {
                result.textContent = 'Erro: ' + error.message;
                logMsg('✗ Erro: ' + error.message);
            } finally {
                processBtn.disabled = false;
            }
        }
        
        // Adicionar log
        function logMsg(msg) {
            const now = new Date().toLocaleTimeString();
            log.innerHTML += `[${now}] ${msg}<br>`;
            console.log(`[${now}] ${msg}`);
        }
        
        // Inicializar
        init();
    </script>
</body>
</html>