<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reordenador de PDF</title>
    <link rel="stylesheet" href="unified-pdf-tools.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.14.305/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
</head>

<body class="converter-pdf">
    <div class="function-container">
        <div class="card upload-area">
            <div class="card-header">
                <h2 class="card-title">
                    <i class="fas fa-object-group"></i> Reordenador de PDF
                </h2>
            </div>
            <div class="card-body">
                <div class="drop-zone" id="dropZone">
                    <div class="drop-zone-content">
                        <div class="upload-icon">
                            <i class="fas fa-file-upload"></i>
                        </div>
                        <div class="upload-text">Selecione ou Arraste o arquivo PDF</div>
                        <p class="upload-subtext">Arraste seu PDF ou clique para selecionar</p>
                        <input type="file" id="fileInput" accept=".pdf" class="hidden">
                    </div>
                </div>
                <div id="fileInfo" class="mt-3"></div>
            </div>
        </div>

        <div class="card configuration-panel" id="configPanel" style="display: none;">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-cog"></i> Ações
                </h3>
            </div>
            <div class="card-body">
                <p class="mb-4">Após reordenar as páginas, clique no botão abaixo para salvar o novo arquivo.</p>
                <button id="downloadBtn" class="pdf-action-button" style="width: 100%; background: linear-gradient(to right, #4361ee, #3647c9); color: white;">
                    <i class="fas fa-download"></i> Baixar PDF Reordenado
                </button>
                 <div id="statusArea" class="mt-3"></div>
            </div>
        </div>
        
        <div class="card preview-container" id="previewContainer" style="display: none;">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-eye"></i> Arraste as páginas para reordenar
                </h3>
            </div>
            <div class="card-body">
                <div id="pdfPreviewGrid" class="pdf-preview-grid"></div>
            </div>
        </div>
    </div>

    <div class="processing-overlay" id="processingOverlay" style="display: none;">
        <div class="processing-message">
            <i class="fas fa-spinner fa-spin fa-2x"></i>
            <p class="mt-3">Processando PDF...</p>
        </div>
    </div>

    <script>
        // Configuração inicial do PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.14.305/pdf.worker.min.js';
        
        document.addEventListener('DOMContentLoaded', function() {
            // Elementos do DOM
            const dropZone = document.getElementById('dropZone');
            const fileInput = document.getElementById('fileInput');
            const fileInfo = document.getElementById('fileInfo');
            const configPanel = document.getElementById('configPanel');
            const previewContainer = document.getElementById('previewContainer');
            const pdfPreviewGrid = document.getElementById('pdfPreviewGrid');
            const downloadBtn = document.getElementById('downloadBtn');
            const statusArea = document.getElementById('statusArea');
            const processingOverlay = document.getElementById('processingOverlay');
            
            // Variáveis globais focadas em reordenar
            let selectedFile = null;
            let currentPdfDocument = null;
            let pageOrder = []; // Array para armazenar a ordem das páginas
            let sortableInstance = null;
            
            // Event Listeners para a área de upload
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, e => { e.preventDefault(); e.stopPropagation(); }, false);
            });
            ['dragenter', 'dragover'].forEach(eventName => dropZone.addEventListener(eventName, () => dropZone.classList.add('drag-over')));
            ['dragleave', 'drop'].forEach(eventName => dropZone.addEventListener(eventName, () => dropZone.classList.remove('drag-over')));
            
            dropZone.addEventListener('drop', (e) => {
                if (e.dataTransfer.files.length > 0) handleFile(e.dataTransfer.files[0]);
            });
            
            dropZone.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) handleFile(e.target.files[0]);
            });
            
            downloadBtn.addEventListener('click', saveReorderedPdf);
            
            // Função para lidar com o arquivo selecionado
            async function handleFile(file) {
                if (!file || file.type !== 'application/pdf') {
                    alert("Por favor, selecione um arquivo PDF válido.");
                    return;
                }
                
                processingOverlay.style.display = 'flex';
                selectedFile = file;
                
                try {
                    const fileURL = URL.createObjectURL(file);
                    const pdf = await pdfjsLib.getDocument({ url: fileURL }).promise;
                    currentPdfDocument = await file.arrayBuffer();
                    
                    // Limpar estado anterior
                    pageOrder = [];
                    if (sortableInstance) sortableInstance.destroy();
                    
                    showFileInfo(file, pdf.numPages);
                    configPanel.style.display = 'block';
                    previewContainer.style.display = 'block';
                    
                    await renderPdfPages(pdf);
                    
                    // Inicializar Sortable.js para arrastar e soltar
                    sortableInstance = new Sortable(pdfPreviewGrid, {
                        animation: 150,
                        ghostClass: 'sortable-ghost',
                        dragClass: 'sortable-drag',
                        handle: '.drag-handle', // Define o ícone como a "alça" para arrastar
                        onSort: updatePageOrder // Função chamada após a reordenação
                    });
                    
                    URL.revokeObjectURL(fileURL);
                } catch (error) {
                    console.error('Erro ao processar o PDF:', error);
                    alert("Ocorreu um erro ao processar o PDF. Pode estar corrompido.");
                } finally {
                    processingOverlay.style.display = 'none';
                }
            }
            
            // Mostrar informações do arquivo
            function showFileInfo(file, pages) {
                fileInfo.innerHTML = `
                    <div class="info-block">
                        <div class="info-line"><i class="fas fa-check-circle"></i> Arquivo: ${file.name}</div>
                        <div class="info-line"><i class="fas fa-check-circle"></i> Tamanho: ${(file.size / 1024 / 1024).toFixed(2)} MB</div>
                        <div class="info-line"><i class="fas fa-check-circle"></i> Páginas: ${pages}</div>
                    </div>`;
            }
            
            // Renderizar páginas do PDF
            async function renderPdfPages(pdf) {
                pdfPreviewGrid.innerHTML = '';
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const viewport = page.getViewport({ scale: 1.5 });
                    
                    const pagePreview = document.createElement('div');
                    pagePreview.className = 'pdf-page-preview';
                    pagePreview.dataset.page = i;
                    
                    // Adicionar APENAS a alça de arraste
                    const dragHandle = document.createElement('div');
                    dragHandle.className = 'drag-handle';
                    dragHandle.innerHTML = '<i class="fas fa-grip-vertical"></i>';
                    pagePreview.appendChild(dragHandle);
                    
                    const canvas = document.createElement('canvas');
                    const context = canvas.getContext('2d');
                    canvas.width = viewport.width;
                    canvas.height = viewport.height;
                    
                    await page.render({ canvasContext: context, viewport: viewport }).promise;
                    
                    const pageNumber = document.createElement('div');
                    pageNumber.className = 'pdf-page-number';
                    pageNumber.textContent = `Página ${i}`;
                    
                    pagePreview.appendChild(canvas);
                    pagePreview.appendChild(pageNumber);
                    pdfPreviewGrid.appendChild(pagePreview);
                    
                    pageOrder.push(i); // Adicionar à ordem inicial de páginas
                }
            }
            
            // Atualizar a ordem das páginas após reordenação
            function updatePageOrder() {
                const containers = pdfPreviewGrid.querySelectorAll('.pdf-page-preview');
                pageOrder = Array.from(containers).map(container => parseInt(container.dataset.page));
                console.log("Nova ordem: ", pageOrder);
            }
            
            // Função para salvar o PDF com as reordenações
            async function saveReorderedPdf() {
                if (!currentPdfDocument) {
                    alert('Nenhum arquivo PDF foi selecionado.');
                    return;
                }
                
                processingOverlay.style.display = 'flex';
                statusArea.innerHTML = '';
                
                try {
                    const pdfDoc = await PDFLib.PDFDocument.load(currentPdfDocument);
                    const newPdf = await PDFLib.PDFDocument.create();
                    
                    // Mapeia a nova ordem de páginas para os índices corretos (base 0)
                    const pageIndicesToCopy = pageOrder.map(pageNum => pageNum - 1);
                    const copiedPages = await newPdf.copyPages(pdfDoc, pageIndicesToCopy);
                    copiedPages.forEach(page => newPdf.addPage(page));
                    
                    const modifiedPdfBytes = await newPdf.save();
                    
                    const blob = new Blob([modifiedPdfBytes], { type: 'application/pdf' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${selectedFile.name.replace('.pdf', '')}_reordenado.pdf`;
                    a.click();
                    
                    setTimeout(() => URL.revokeObjectURL(url), 100);
                    statusArea.innerHTML = `<div class="status-message success"><i class="fas fa-check-circle"></i> PDF reordenado com sucesso!</div>`;
                } catch (error) {
                    console.error('Erro ao salvar PDF modificado:', error);
                     statusArea.innerHTML = `<div class="status-message error"><i class="fas fa-exclamation-circle"></i> Erro ao salvar o PDF.</div>`;
                } finally {
                    processingOverlay.style.display = 'none';
                }
            }
            
            // Adiciona apenas os estilos necessários para o arraste
            (function addGlobalStyles() {
                const styleElement = document.createElement('style');
                styleElement.textContent = `
                    /* Estilos para elementos arrastáveis */
                    .sortable-ghost {
                        opacity: 0.4;
                        background: var(--color-gray-50);
                        border: 2px dashed var(--color-primary);
                    }
                    .sortable-drag {
                        opacity: 0.8;
                        transform: scale(1.05);
                    }
                    .drag-handle {
                        position: absolute; top: 0.5rem; left: 0.5rem;
                        width: 24px; height: 24px; display: flex;
                        align-items: center; justify-content: center;
                        background: rgba(67, 97, 238, 0.1); border-radius: 4px;
                        cursor: grab; opacity: 0; transition: all 0.2s ease;
                        color: var(--color-primary);
                    }
                    .pdf-page-preview:hover .drag-handle { opacity: 1; }
                `;
                document.head.appendChild(styleElement);
            })();
        });
    </script>
</body>
</html>