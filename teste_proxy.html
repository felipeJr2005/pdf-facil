<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste PDF Proxy</title>
    <style>
        body { font-family: sans-serif; max-width: 900px; margin: 0 auto; padding: 20px; }
        .container { background: white; padding: 20px; border: 1px solid #ddd; margin-bottom: 20px; }
        input[type="url"], select { width: 100%; padding: 8px; margin: 5px 0; }
        button { padding: 8px 15px; margin: 5px; cursor: pointer; }
        .example-url { background: #f0f0f0; padding: 8px; margin: 5px 0; cursor: pointer; border: 1px solid #ddd; }
        #log { background: #f8f8f8; padding: 10px; height: 300px; overflow-y: auto; font-family: monospace; font-size: 12px; }
        .pdf-viewer { width: 100%; height: 500px; border: 1px solid #ddd; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Teste PDF Proxy v2.3</h1>
        
        <label>URL do PDF:</label>
        <input type="url" id="pdfUrl" placeholder="Cole aqui a URL do PDF">
        
        <label><input type="checkbox" id="debugMode"> Modo Debug</label>
        
        <div>
            <button onclick="testarPing()">Testar Conex√£o</button>
            <button onclick="testarProxy()">Testar Proxy</button>
            <button onclick="testarIframe()">Testar Iframe</button>
            <button onclick="simularCliqueBaixar()">ü§ñ Simular Clique Baixar</button>
            <button onclick="limparLog()">Limpar</button>
        </div>
        
        <h3>URLs de Exemplo:</h3>
        <div class="example-url" onclick="usarUrl('https://www.w3.org/WAI/ER/tests/xhtml/testfiles/resources/pdf/dummy.pdf')">
            https://www.w3.org/WAI/ER/tests/xhtml/testfiles/resources/pdf/dummy.pdf
        </div>
        <div class="example-url" onclick="usarUrl('https://www.adobe.com/support/products/enterprise/knowledgecenter/media/c4611_sample_explain.pdf')">
            https://www.adobe.com/support/products/enterprise/knowledgecenter/media/c4611_sample_explain.pdf
        </div>
        <div class="example-url" onclick="usarUrl('https://pje.cloud.tjpe.jus.br/1g/seam/resource/rest/pje-legacy/documento/download/147308979')">
            https://pje.cloud.tjpe.jus.br/1g/seam/resource/rest/pje-legacy/documento/download/147308979
        </div>
    </div>
    
    <div class="container" id="resultContainer" style="display: none;">
        <h3>Resultado</h3>
        <iframe id="pdfViewer" class="pdf-viewer"></iframe>
        <div>
            <button onclick="baixarPDF()">Baixar PDF</button>
            <button onclick="tentarCapturar()">Tentar Capturar</button>
            <button onclick="procurarBotaoBaixar()">üîç Procurar Bot√£o Baixar</button>
            <button onclick="monitorarIframe()">üëÅÔ∏è Monitorar Iframe</button>
        </div>
    </div>
    
    <div class="container">
        <h3>Log</h3>
        <div id="log"></div>
    </div>

    <script>
        function log(message, type = 'info') {
            const now = new Date().toLocaleTimeString();
            const logEl = document.getElementById('log');
            const colors = { info: '#000', success: '#0a0', error: '#a00', warning: '#fa0' };
            logEl.innerHTML += `<div style="color: ${colors[type] || '#000'}">[${now}] ${message}</div>`;
            logEl.scrollTop = logEl.scrollHeight;
        }
        
        function usarUrl(url) {
            document.getElementById('pdfUrl').value = url;
            log('URL selecionada: ' + url);
        }
        
        function limparLog() {
            document.getElementById('log').innerHTML = '';
            document.getElementById('resultContainer').style.display = 'none';
            log('Log limpo');
        }
        
        async function testarPing() {
            log('Testando conex√£o...');
            try {
                const response = await fetch('pdf_proxy.php?test=ping');
                if (response.ok) {
                    const data = await response.json();
                    log('‚úÖ Conex√£o OK: ' + data.message, 'success');
                } else {
                    log('‚ùå Erro HTTP: ' + response.status, 'error');
                }
            } catch (error) {
                log('‚ùå Erro: ' + error.message, 'error');
            }
        }
        
        async function testarProxy() {
            const url = document.getElementById('pdfUrl').value.trim();
            if (!url) {
                log('‚ùå URL vazia', 'error');
                return;
            }
            
            const debug = document.getElementById('debugMode').checked;
            let proxyUrl = `pdf_proxy.php?url=${encodeURIComponent(url)}`;
            if (debug) proxyUrl += '&debug=1';
            
            log('Testando via proxy...');
            try {
                const response = await fetch(proxyUrl);
                log(`Proxy resposta: ${response.status}`);
                
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/pdf')) {
                    log('‚úÖ PDF via proxy OK', 'success');
                    mostrarPDF(proxyUrl);
                } else if (contentType && contentType.includes('application/json')) {
                    const data = await response.json();
                    log('‚ùå Erro proxy: ' + data.message, 'error');
                } else {
                    log('‚ö†Ô∏è Proxy retornou HTML', 'warning');
                }
            } catch (error) {
                log('‚ùå Erro proxy: ' + error.message, 'error');
            }
        }
        
        function testarIframe() {
            const url = document.getElementById('pdfUrl').value.trim();
            if (!url) {
                log('‚ùå URL vazia', 'error');
                return;
            }
            
            log('Carregando no iframe...');
            mostrarPDF(url);
            log('‚úÖ Iframe carregado. Fa√ßa login se necess√°rio.', 'success');
        }
        
        function mostrarPDF(url) {
            document.getElementById('pdfViewer').src = url;
            document.getElementById('resultContainer').style.display = 'block';
            window.currentPdfUrl = url;
            log('PDF carregado na visualiza√ß√£o');
        }
        
        async function baixarPDF() {
            const url = window.currentPdfUrl || document.getElementById('pdfUrl').value;
            if (!url) {
                log('‚ùå Nenhuma URL para download', 'error');
                return;
            }
            
            log('Iniciando download via servidor...');
            
            try {
                const downloadUrl = `pdf_proxy.php?url=${encodeURIComponent(url)}&action=download`;
                log('URL de download: ' + downloadUrl);
                
                const response = await fetch(downloadUrl);
                log(`Resposta do servidor: ${response.status}`);
                
                const contentType = response.headers.get('content-type');
                log(`Content-Type: ${contentType}`);
                
                if (response.ok && contentType && contentType.includes('application/pdf')) {
                    log('Convertendo resposta para blob...');
                    const blob = await response.blob();
                    log(`Blob criado: ${blob.size} bytes`);
                    
                    const downloadUrl2 = URL.createObjectURL(blob);
                    
                    const a = document.createElement('a');
                    a.href = downloadUrl2;
                    a.download = 'documento_' + Date.now() + '.pdf';
                    a.style.display = 'none';
                    document.body.appendChild(a);
                    
                    log('Iniciando download do blob...');
                    a.click();
                    
                    document.body.removeChild(a);
                    URL.revokeObjectURL(downloadUrl2);
                    
                    log('‚úÖ PDF baixado via blob!', 'success');
                } else if (contentType && contentType.includes('application/json')) {
                    const errorData = await response.json();
                    log('‚ùå Servidor retornou erro: ' + errorData.message, 'error');
                    
                    // Fallback: download direto
                    log('Tentando download direto...');
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'documento_direto_' + Date.now() + '.pdf';
                    a.target = '_blank';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    log('‚ö†Ô∏è Download direto tentado', 'warning');
                } else {
                    log('‚ùå Resposta inv√°lida do servidor', 'error');
                    log('Content-Type recebido: ' + contentType);
                    
                    // Fallback: download direto
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'documento_direto_' + Date.now() + '.pdf';
                    a.target = '_blank';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    log('‚ö†Ô∏è Fallback para download direto', 'warning');
                }
            } catch (error) {
                log('‚ùå Erro no download: ' + error.message, 'error');
            }
        }
        
        async function tentarCapturar() {
            const url = window.currentPdfUrl || document.getElementById('pdfUrl').value;
            if (!url) {
                log('‚ùå Nenhuma URL para capturar', 'error');
                return;
            }
            
            log('Tentando capturar...');
            
            // Tentar acessar URL atual do iframe
            try {
                const iframe = document.getElementById('pdfViewer');
                const iframeUrl = iframe.contentWindow.location.href;
                
                if (iframeUrl && iframeUrl !== url) {
                    log('URL iframe: ' + iframeUrl);
                    
                    const response = await fetch(`pdf_proxy.php?url=${encodeURIComponent(iframeUrl)}&action=download`);
                    
                    if (response.ok && response.headers.get('content-type').includes('application/pdf')) {
                        const blob = await response.blob();
                        const downloadUrl = URL.createObjectURL(blob);
                        
                        const a = document.createElement('a');
                        a.href = downloadUrl;
                        a.download = 'capturado_' + Date.now() + '.pdf';
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        
                        URL.revokeObjectURL(downloadUrl);
                        log('‚úÖ PDF capturado do iframe!', 'success');
                    } else {
                        log('‚ùå Falha na captura', 'error');
                    }
                } else {
                    log('‚ö†Ô∏è URL do iframe n√£o mudou', 'warning');
                }
        function simularCliqueBaixar() {
            log('ü§ñ Iniciando simula√ß√£o de clique no bot√£o baixar...');
            
            const iframe = document.getElementById('pdfViewer');
            if (!iframe || !iframe.src) {
                log('‚ùå Iframe n√£o carregado', 'error');
                return;
            }
            
            try {
                const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                
                if (iframeDoc) {
                    log('‚úÖ Acesso ao documento do iframe obtido!');
                    
                    // Procurar diferentes tipos de bot√µes de download
                    const seletores = [
                        'button[title*="ownload"]',
                        'button[title*="Baixar"]',
                        'a[download]',
                        'button[data-download]',
                        '[aria-label*="download"]',
                        '[aria-label*="baixar"]',
                        'button:contains("Baixar")',
                        '.download-button',
                        '#download',
                        '[role="button"][title*="download"]'
                    ];
                    
                    let botaoEncontrado = false;
                    
                    for (const seletor of seletores) {
                        const botoes = iframeDoc.querySelectorAll(seletor);
                        if (botoes.length > 0) {
                            log(`üéØ Bot√£o encontrado com seletor: ${seletor}`);
                            
                            botoes.forEach((botao, index) => {
                                log(`Bot√£o ${index + 1}: ${botao.outerHTML.substring(0, 100)}...`);
                                
                                // Simular clique
                                botao.click();
                                log(`‚úÖ Clique simulado no bot√£o ${index + 1}!`, 'success');
                                botaoEncontrado = true;
                            });
                            
                            if (botaoEncontrado) break;
                        }
                    }
                    
                    if (!botaoEncontrado) {
                        log('‚ùå Nenhum bot√£o de download encontrado');
                        log('üìã Listando todos os bot√µes dispon√≠veis...');
                        
                        const todosBotoes = iframeDoc.querySelectorAll('button, a[href]');
                        todosBotoes.forEach((botao, index) => {
                            const texto = botao.textContent || botao.title || botao.getAttribute('aria-label') || '';
                            log(`Bot√£o ${index + 1}: ${texto} - ${botao.tagName}`);
                        });
                    }
                    
                } else {
                    log('‚ùå CORS bloqueou acesso ao documento do iframe', 'error');
                    log('üí° Tentando estrat√©gia alternativa...');
                    
                    // Estrat√©gia alternativa: simular eventos de teclado
                    iframe.contentWindow.postMessage({
                        action: 'simulateDownload',
                        method: 'keyboard'
                    }, '*');
                    
                    // Simular Ctrl+S
                    const event = new KeyboardEvent('keydown', {
                        key: 's',
                        ctrlKey: true,
                        bubbles: true
                    });
                    iframe.contentWindow.dispatchEvent(event);
                    
                    log('‚ö° Eventos de teclado Ctrl+S enviados');
                }
                
            } catch (error) {
                log('‚ùå Erro na simula√ß√£o: ' + error.message, 'error');
            }
        }
        
        function procurarBotaoBaixar() {
            log('üîç Procurando bot√µes de download no iframe...');
            
            const iframe = document.getElementById('pdfViewer');
            if (!iframe) {
                log('‚ùå Iframe n√£o encontrado', 'error');
                return;
            }
            
            try {
                const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                
                if (iframeDoc) {
                    log('‚úÖ Analisando conte√∫do do iframe...');
                    
                    // Procurar elementos com texto relacionado a download
                    const elementos = iframeDoc.querySelectorAll('*');
                    let encontrados = 0;
                    
                    elementos.forEach((el, index) => {
                        const texto = el.textContent || el.title || el.getAttribute('aria-label') || '';
                        const attrs = el.getAttributeNames().join(', ');
                        
                        if (texto.toLowerCase().includes('download') || 
                            texto.toLowerCase().includes('baixar') ||
                            attrs.toLowerCase().includes('download')) {
                            
                            log(`üéØ Elemento ${index}: ${el.tagName} - "${texto}" - [${attrs}]`);
                            encontrados++;
                        }
                    });
                    
                    if (encontrados === 0) {
                        log('‚ùå Nenhum elemento relacionado a download encontrado');
                        
                        // Listar todos os bot√µes
                        const botoes = iframeDoc.querySelectorAll('button, input[type="button"], a');
                        log(`üìä Total de bot√µes/links encontrados: ${botoes.length}`);
                        
                        botoes.forEach((botao, index) => {
                            if (index < 10) { // Mostrar apenas os primeiros 10
                                const texto = botao.textContent || botao.value || botao.href || '';
                                log(`Bot√£o ${index + 1}: "${texto.substring(0, 50)}" - ${botao.tagName}`);
                            }
                        });
                    } else {
                        log(`‚úÖ ${encontrados} elementos de download encontrados!`, 'success');
                    }
                    
                } else {
                    log('‚ùå CORS bloqueou an√°lise do iframe', 'error');
                }
                
            } catch (error) {
                log('‚ùå Erro na an√°lise: ' + error.message, 'error');
            }
        }
        
        function monitorarIframe() {
            log('üëÅÔ∏è Iniciando monitoramento do iframe...');
            
            const iframe = document.getElementById('pdfViewer');
            if (!iframe) {
                log('‚ùå Iframe n√£o encontrado', 'error');
                return;
            }
            
            // Monitorar mudan√ßas na URL
            let urlAnterior = iframe.src;
            
            const intervalo = setInterval(() => {
                try {
                    const urlAtual = iframe.contentWindow.location.href;
                    
                    if (urlAtual !== urlAnterior) {
                        log(`üîÑ URL mudou: ${urlAtual}`);
                        urlAnterior = urlAtual;
                        
                        // Se mudou para uma URL de download, tentar capturar
                        if (urlAtual.includes('download') || urlAtual.includes('.pdf')) {
                            log('üéØ URL de download detectada!', 'success');
                            // Tentar baixar via fetch
                            fetch(urlAtual)
                                .then(response => response.blob())
                                .then(blob => {
                                    const url = URL.createObjectURL(blob);
                                    const a = document.createElement('a');
                                    a.href = url;
                                    a.download = 'monitorado_' + Date.now() + '.pdf';
                                    a.click();
                                    URL.revokeObjectURL(url);
                                    log('‚úÖ Download autom√°tico realizado!', 'success');
                                })
                                .catch(err => log('‚ùå Falha no download autom√°tico: ' + err.message, 'error'));
                        }
                    }
                    
                } catch (corsError) {
                    // CORS normal, continua monitorando
                }
            }, 2000);
            
            // Parar monitoramento ap√≥s 2 minutos
            setTimeout(() => {
                clearInterval(intervalo);
                log('‚èπÔ∏è Monitoramento interrompido ap√≥s 2 minutos');
            }, 120000);
            
            log('‚úÖ Monitoramento ativo por 2 minutos...', 'success');
        }
    </script>
</body>
</html>