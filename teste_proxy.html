<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste PDF Proxy</title>
    <style>
        body { font-family: sans-serif; max-width: 900px; margin: 0 auto; padding: 20px; }
        .container { background: white; padding: 20px; border: 1px solid #ddd; margin-bottom: 20px; }
        input[type="url"], select { width: 100%; padding: 8px; margin: 5px 0; }
        button { padding: 8px 15px; margin: 5px; cursor: pointer; }
        .example-url { background: #f0f0f0; padding: 8px; margin: 5px 0; cursor: pointer; border: 1px solid #ddd; }
        #log { background: #f8f8f8; padding: 10px; height: 300px; overflow-y: auto; font-family: monospace; font-size: 12px; }
        .pdf-viewer { width: 100%; height: 500px; border: 1px solid #ddd; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Teste PDF Proxy v2.3</h1>
        
        <label>URL do PDF:</label>
        <input type="url" id="pdfUrl" placeholder="Cole aqui a URL do PDF">
        
        <label><input type="checkbox" id="debugMode"> Modo Debug</label>
        
        <div>
            <button onclick="testarPing()">Testar Conexão</button>
            <button onclick="testarProxy()">Testar Proxy</button>
            <button onclick="testarIframe()">Testar Iframe</button>
            <button onclick="limparLog()">Limpar</button>
        </div>
        
        <h3>URLs de Exemplo:</h3>
        <div class="example-url" onclick="usarUrl('https://www.w3.org/WAI/ER/tests/xhtml/testfiles/resources/pdf/dummy.pdf')">
            https://www.w3.org/WAI/ER/tests/xhtml/testfiles/resources/pdf/dummy.pdf
        </div>
        <div class="example-url" onclick="usarUrl('https://www.adobe.com/support/products/enterprise/knowledgecenter/media/c4611_sample_explain.pdf')">
            https://www.adobe.com/support/products/enterprise/knowledgecenter/media/c4611_sample_explain.pdf
        </div>
        <div class="example-url" onclick="usarUrl('https://pje.cloud.tjpe.jus.br/1g/seam/resource/rest/pje-legacy/documento/download/147308979')">
            https://pje.cloud.tjpe.jus.br/1g/seam/resource/rest/pje-legacy/documento/download/147308979
        </div>
    </div>
    
    <div class="container" id="resultContainer" style="display: none;">
        <h3>Resultado</h3>
        <iframe id="pdfViewer" class="pdf-viewer"></iframe>
        <div>
            <button onclick="baixarPDF()">Baixar PDF</button>
            <button onclick="tentarCapturar()">Tentar Capturar</button>
        </div>
    </div>
    
    <div class="container">
        <h3>Log</h3>
        <div id="log"></div>
    </div>

    <script>
        function log(message, type = 'info') {
            const now = new Date().toLocaleTimeString();
            const logEl = document.getElementById('log');
            const colors = { info: '#000', success: '#0a0', error: '#a00', warning: '#fa0' };
            logEl.innerHTML += `<div style="color: ${colors[type] || '#000'}">[${now}] ${message}</div>`;
            logEl.scrollTop = logEl.scrollHeight;
        }
        
        function usarUrl(url) {
            document.getElementById('pdfUrl').value = url;
            log('URL selecionada: ' + url);
        }
        
        function limparLog() {
            document.getElementById('log').innerHTML = '';
            document.getElementById('resultContainer').style.display = 'none';
            log('Log limpo');
        }
        
        async function testarPing() {
            log('Testando conexão...');
            try {
                const response = await fetch('pdf_proxy.php?test=ping');
                if (response.ok) {
                    const data = await response.json();
                    log('✅ Conexão OK: ' + data.message, 'success');
                } else {
                    log('❌ Erro HTTP: ' + response.status, 'error');
                }
            } catch (error) {
                log('❌ Erro: ' + error.message, 'error');
            }
        }
        
        async function testarProxy() {
            const url = document.getElementById('pdfUrl').value.trim();
            if (!url) {
                log('❌ URL vazia', 'error');
                return;
            }
            
            const debug = document.getElementById('debugMode').checked;
            let proxyUrl = `pdf_proxy.php?url=${encodeURIComponent(url)}`;
            if (debug) proxyUrl += '&debug=1';
            
            log('Testando via proxy...');
            try {
                const response = await fetch(proxyUrl);
                log(`Proxy resposta: ${response.status}`);
                
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/pdf')) {
                    log('✅ PDF via proxy OK', 'success');
                    mostrarPDF(proxyUrl);
                } else if (contentType && contentType.includes('application/json')) {
                    const data = await response.json();
                    log('❌ Erro proxy: ' + data.message, 'error');
                } else {
                    log('⚠️ Proxy retornou HTML', 'warning');
                }
            } catch (error) {
                log('❌ Erro proxy: ' + error.message, 'error');
            }
        }
        
        function testarIframe() {
            const url = document.getElementById('pdfUrl').value.trim();
            if (!url) {
                log('❌ URL vazia', 'error');
                return;
            }
            
            log('Carregando no iframe...');
            mostrarPDF(url);
            log('✅ Iframe carregado. Faça login se necessário.', 'success');
        }
        
        function mostrarPDF(url) {
            document.getElementById('pdfViewer').src = url;
            document.getElementById('resultContainer').style.display = 'block';
            window.currentPdfUrl = url;
            log('PDF carregado na visualização');
        }
        
        async function baixarPDF() {
            const url = window.currentPdfUrl || document.getElementById('pdfUrl').value;
            if (!url) {
                log('❌ Nenhuma URL para download', 'error');
                return;
            }
            
            log('Iniciando download via servidor...');
            
            try {
                const downloadUrl = `pdf_proxy.php?url=${encodeURIComponent(url)}&action=download`;
                log('URL de download: ' + downloadUrl);
                
                const response = await fetch(downloadUrl);
                log(`Resposta do servidor: ${response.status}`);
                
                const contentType = response.headers.get('content-type');
                log(`Content-Type: ${contentType}`);
                
                if (response.ok && contentType && contentType.includes('application/pdf')) {
                    log('Convertendo resposta para blob...');
                    const blob = await response.blob();
                    log(`Blob criado: ${blob.size} bytes`);
                    
                    const downloadUrl2 = URL.createObjectURL(blob);
                    
                    const a = document.createElement('a');
                    a.href = downloadUrl2;
                    a.download = 'documento_' + Date.now() + '.pdf';
                    a.style.display = 'none';
                    document.body.appendChild(a);
                    
                    log('Iniciando download do blob...');
                    a.click();
                    
                    document.body.removeChild(a);
                    URL.revokeObjectURL(downloadUrl2);
                    
                    log('✅ PDF baixado via blob!', 'success');
                } else if (contentType && contentType.includes('application/json')) {
                    const errorData = await response.json();
                    log('❌ Servidor retornou erro: ' + errorData.message, 'error');
                    
                    // Fallback: download direto
                    log('Tentando download direto...');
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'documento_direto_' + Date.now() + '.pdf';
                    a.target = '_blank';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    log('⚠️ Download direto tentado', 'warning');
                } else {
                    log('❌ Resposta inválida do servidor', 'error');
                    log('Content-Type recebido: ' + contentType);
                    
                    // Fallback: download direto
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'documento_direto_' + Date.now() + '.pdf';
                    a.target = '_blank';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    log('⚠️ Fallback para download direto', 'warning');
                }
            } catch (error) {
                log('❌ Erro no download: ' + error.message, 'error');
            }
        }
        
        async function tentarCapturar() {
            const url = window.currentPdfUrl || document.getElementById('pdfUrl').value;
            if (!url) {
                log('❌ Nenhuma URL para capturar', 'error');
                return;
            }
            
            log('Tentando capturar...');
            
            // Tentar acessar URL atual do iframe
            try {
                const iframe = document.getElementById('pdfViewer');
                const iframeUrl = iframe.contentWindow.location.href;
                
                if (iframeUrl && iframeUrl !== url) {
                    log('URL iframe: ' + iframeUrl);
                    
                    const response = await fetch(`pdf_proxy.php?url=${encodeURIComponent(iframeUrl)}&action=download`);
                    
                    if (response.ok && response.headers.get('content-type').includes('application/pdf')) {
                        const blob = await response.blob();
                        const downloadUrl = URL.createObjectURL(blob);
                        
                        const a = document.createElement('a');
                        a.href = downloadUrl;
                        a.download = 'capturado_' + Date.now() + '.pdf';
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        
                        URL.revokeObjectURL(downloadUrl);
                        log('✅ PDF capturado do iframe!', 'success');
                    } else {
                        log('❌ Falha na captura', 'error');
                    }
                } else {
                    log('⚠️ URL do iframe não mudou', 'warning');
                }
            } catch (error) {
                log('❌ CORS bloqueou acesso ao iframe', 'error');
            }
        }
        
        // Inicialização
        log('🚀 Sistema carregado');
        log('📝 Cole uma URL e teste as funcionalidades');
    </script>
</body>
</html>