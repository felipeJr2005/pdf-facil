<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste PDF Proxy</title>
    <style>
        body { font-family: sans-serif; max-width: 900px; margin: 0 auto; padding: 20px; }
        .container { background: white; padding: 20px; border: 1px solid #ddd; margin-bottom: 20px; }
        input[type="url"], select { width: 100%; padding: 8px; margin: 5px 0; }
        button { padding: 8px 15px; margin: 5px; cursor: pointer; }
        .example-url { background: #f0f0f0; padding: 8px; margin: 5px 0; cursor: pointer; border: 1px solid #ddd; }
        #log { background: #f8f8f8; padding: 10px; height: 300px; overflow-y: auto; font-family: monospace; font-size: 12px; }
        .pdf-viewer { width: 100%; height: 500px; border: 1px solid #ddd; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Teste PDF Proxy v2.2</h1>
        
        <label>URL do PDF:</label>
        <input type="url" id="pdfUrl" placeholder="Cole aqui a URL do PDF">
        
        <label><input type="checkbox" id="debugMode"> Modo Debug</label>
        
        <label>Estratégia:</label>
        <select id="strategy">
            <option value="auto">Automática</option>
            <option value="direct">Direta</option>
            <option value="pje">PJe</option>
        </select>
        
        <div>
            <button onclick="testarPing()">Testar Conexão</button>
            <button onclick="testarProxy()">Testar Proxy</button>
            <button onclick="testarDireto()">Testar Direto</button>
            <button onclick="testarIframe()">Testar Iframe</button>
            <button onclick="extrairDoIframe()">Extrair do Iframe</button>
            <button onclick="limparLog()">Limpar Log</button>
        </div>
        
        <h3>URLs de Exemplo:</h3>
        <div class="example-url" onclick="usarUrl(this)">
            https://www.w3.org/WAI/ER/tests/xhtml/testfiles/resources/pdf/dummy.pdf
        </div>
        <div class="example-url" onclick="usarUrl(this)">
            https://www.adobe.com/support/products/enterprise/knowledgecenter/media/c4611_sample_explain.pdf
        </div>
        <div class="example-url" onclick="usarUrl(this)">
            https://pje.cloud.tjpe.jus.br/1g/seam/resource/rest/pje-legacy/documento/download/147308979
        </div>
    </div>
    
    <div class="container" id="resultContainer" style="display: none;">
        <h3>Resultado</h3>
        <iframe id="pdfViewer" class="pdf-viewer"></iframe>
        <div>
            <button onclick="forcarDownload()">Forçar Download</button>
            <button onclick="capturarServidor()">Capturar Servidor</button>
        </div>
    </div>
    
    <div class="container">
        <h3>Log</h3>
        <div id="log"></div>
    </div>

    <script>
        function log(message, type = 'info') {
            const now = new Date().toLocaleTimeString();
            const logEl = document.getElementById('log');
            const colors = { info: '#000', success: '#0a0', error: '#a00', warning: '#fa0' };
            logEl.innerHTML += `<div style="color: ${colors[type] || '#000'}">[${now}] ${message}</div>`;
            logEl.scrollTop = logEl.scrollHeight;
        }
        
        function usarUrl(element) {
            const text = element.textContent.trim();
            document.getElementById('pdfUrl').value = text;
            log('URL selecionada: ' + text);
        }
        
        function limparLog() {
            document.getElementById('log').innerHTML = '';
            document.getElementById('resultContainer').style.display = 'none';
        }
        
        async function testarPing() {
            log('Testando conexão...');
            try {
                const response = await fetch('pdf_proxy.php?test=ping');
                if (response.ok) {
                    const data = await response.json();
                    log('✅ Conexão OK: ' + data.message, 'success');
                } else {
                    log('❌ Erro HTTP: ' + response.status, 'error');
                }
            } catch (error) {
                log('❌ Erro: ' + error.message, 'error');
            }
        }
        
        async function testarDireto() {
            const url = document.getElementById('pdfUrl').value.trim();
            if (!url) return log('❌ URL vazia', 'error');
            
            log('Testando acesso direto...');
            try {
                const response = await fetch(url);
                log(`Resposta: ${response.status} ${response.statusText}`);
                if (response.ok) {
                    const contentType = response.headers.get('content-type');
                    if (contentType && contentType.includes('application/pdf')) {
                        log('✅ PDF acessível diretamente', 'success');
                        mostrarPDF(url);
                    } else {
                        log('⚠️ Não é PDF: ' + contentType, 'warning');
                    }
                } else {
                    log('❌ Falha no acesso direto', 'error');
                }
            } catch (error) {
                log('❌ Erro direto: ' + error.message, 'error');
            }
        }
        
        async function testarProxy() {
            const url = document.getElementById('pdfUrl').value.trim();
            if (!url) return log('❌ URL vazia', 'error');
            
            const debug = document.getElementById('debugMode').checked;
            const strategy = document.getElementById('strategy').value;
            
            let proxyUrl = `pdf_proxy.php?url=${encodeURIComponent(url)}`;
            if (debug) proxyUrl += '&debug=1';
            if (strategy !== 'auto') proxyUrl += `&strategy=${strategy}`;
            
            log('Testando via proxy...');
            try {
                const response = await fetch(proxyUrl);
                log(`Proxy resposta: ${response.status}`);
                
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/pdf')) {
                    log('✅ PDF via proxy OK', 'success');
                    mostrarPDF(proxyUrl);
                } else if (contentType && contentType.includes('application/json')) {
                    const data = await response.json();
                    log('❌ Erro proxy: ' + data.message, 'error');
                } else {
                    log('⚠️ Proxy retornou HTML', 'warning');
                }
            } catch (error) {
                log('❌ Erro proxy: ' + error.message, 'error');
            }
        }
        
        function testarIframe() {
            const url = document.getElementById('pdfUrl').value.trim();
            if (!url) return log('❌ URL vazia', 'error');
            
            log('Carregando no iframe...');
            mostrarPDF(url);
            log('✅ Iframe carregado. Faça login se necessário.', 'success');
        }
        
        function mostrarPDF(url) {
            document.getElementById('pdfViewer').src = url;
            document.getElementById('resultContainer').style.display = 'block';
            window.currentPdfUrl = url;
        }
        
        function forcarDownload() {
            const url = window.currentPdfUrl || document.getElementById('pdfUrl').value;
            if (!url) return log('❌ Nenhuma URL para download', 'error');
            
            log('Iniciando download real...');
            
            try {
                // Tentar acessar o iframe autenticado
                const iframe = document.getElementById('pdfViewer');
                let pdfUrl = url;
                
                // Verificar se consegue acessar a URL atual do iframe (após login)
                try {
                    const iframeUrl = iframe.contentWindow.location.href;
                    if (iframeUrl && iframeUrl !== 'about:blank' && iframeUrl.includes('download')) {
                        pdfUrl = iframeUrl;
                        log('Usando URL autenticada do iframe: ' + pdfUrl);
                    }
                } catch (corsError) {
                    log('CORS bloqueou acesso ao iframe, usando URL original');
                }
                
                // Estratégia 1: Tentar via proxy com captura de sessão
                fetch(`pdf_proxy.php?url=${encodeURIComponent(pdfUrl)}&action=download&force=1`)
                    .then(response => {
                        if (response.ok && response.headers.get('content-type').includes('application/pdf')) {
                            return response.blob();
                        } else {
                            throw new Error('Proxy não conseguiu capturar PDF autenticado');
                        }
                    })
                    .then(blob => {
                        // Download real do blob
                        const downloadUrl = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = downloadUrl;
                        a.download = 'documento_baixado_' + Date.now() + '.pdf';
                        a.style.display = 'none';
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(downloadUrl);
                        log('✅ PDF baixado para pasta de downloads!', 'success');
                    })
                    .catch(error => {
                        log('❌ Falha na captura via proxy: ' + error.message, 'error');
                        
                        // Estratégia 2: Download direto (pode só abrir no navegador)
                        log('Tentando download direto...');
                        const a = document.createElement('a');
                        a.href = pdfUrl;
                        a.download = 'documento_direto_' + Date.now() + '.pdf';
                        a.target = '_blank';
                        // Forçar atributo download
                        a.setAttribute('download', 'documento_direto_' + Date.now() + '.pdf');
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        log('⚠️ Download direto tentado (pode abrir no navegador)', 'warning');
                    });
                    
            } catch (error) {
                log('❌ Erro no download: ' + error.message, 'error');
            }
        }
        
        function extrairDoIframe() {
            log('🎯 Tentando extrair PDF do iframe autenticado...');
            
            const iframe = document.getElementById('pdfViewer');
            if (!iframe || !iframe.src) {
                return log('❌ Iframe não carregado', 'error');
            }
            
            try {
                // Estratégia 1: Verificar se consegue acessar URL atual
                try {
                    const iframeUrl = iframe.contentWindow.location.href;
                    log('URL do iframe: ' + iframeUrl);
                    
                    if (iframeUrl.includes('download') || iframeUrl.includes('.pdf')) {
                        log('🎯 URL de PDF detectada no iframe!', 'success');
                        
                        // Tentar baixar via fetch usando a URL autenticada
                        fetch(iframeUrl)
                            .then(response => {
                                if (response.ok && response.headers.get('content-type').includes('application/pdf')) {
                                    return response.blob();
                                } else {
                                    throw new Error('Resposta não é PDF');
                                }
                            })
                            .then(blob => {
                                const downloadUrl = URL.createObjectURL(blob);
                                const a = document.createElement('a');
                                a.href = downloadUrl;
                                a.download = 'pdf_extraido_' + Date.now() + '.pdf';
                                document.body.appendChild(a);
                                a.click();
                                document.body.removeChild(a);
                                URL.revokeObjectURL(downloadUrl);
                                log('✅ PDF extraído e baixado com sucesso!', 'success');
                            })
                            .catch(error => {
                                log('❌ Falha na extração: ' + error.message, 'error');
                                // Fallback: tentar via proxy
                                tentarViaProxy(iframeUrl);
                            });
                    } else {
                        log('⚠️ URL do iframe não parece ser PDF', 'warning');
                    }
                    
                } catch (corsError) {
                    log('❌ CORS bloqueou acesso à URL do iframe', 'error');
                    
                    // Estratégia 2: Tentar injetar script no iframe
                    try {
                        const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                        if (iframeDoc) {
                            // Verificar se há link de download no PDF
                            const downloadLinks = iframeDoc.querySelectorAll('a[href*="download"], a[download]');
                            if (downloadLinks.length > 0) {
                                log('🔗 Link de download encontrado no iframe!', 'success');
                                const downloadUrl = downloadLinks[0].href;
                                tentarViaProxy(downloadUrl);
                            } else {
                                log('❌ Nenhum link de download encontrado', 'error');
                            }
                        }
                    } catch (error2) {
                        log('❌ Não foi possível acessar conteúdo do iframe', 'error');
                    }
                }
                
            } catch (error) {
                log('❌ Erro na extração: ' + error.message, 'error');
            }
        }
        
        function tentarViaProxy(url) {
            log('🔄 Tentando capturar via proxy: ' + url);
            
            const proxyUrl = `pdf_proxy.php?url=${encodeURIComponent(url)}&action=download&force=1`;
            
            fetch(proxyUrl)
                .then(response => {
                    if (response.ok && response.headers.get('content-type').includes('application/pdf')) {
                        return response.blob();
                    } else {
                        throw new Error('Proxy falhou');
                    }
                })
                .then(blob => {
                    const downloadUrl = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = downloadUrl;
                    a.download = 'pdf_proxy_' + Date.now() + '.pdf';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(downloadUrl);
                    log('✅ PDF capturado via proxy!', 'success');
                })
                .catch(error => {
                    log('❌ Proxy também falhou: ' + error.message, 'error');
                });
        }
            const url = window.currentPdfUrl || document.getElementById('pdfUrl').value;
            if (!url) return log('❌ Nenhuma URL para capturar', 'error');
            
            log('Capturando via servidor...');
            try {
                const captureUrl = `pdf_proxy.php?url=${encodeURIComponent(url)}&action=download`;
                const response = await fetch(captureUrl);
                
                if (response.ok && response.headers.get('content-type').includes('application/pdf')) {
                    const blob = await response.blob();
                    const downloadUrl = URL.createObjectURL(blob);
                    
                    const a = document.createElement('a');
                    a.href = downloadUrl;
                    a.download = 'capturado_' + Date.now() + '.pdf';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    
                    URL.revokeObjectURL(downloadUrl);
                    log('✅ Capturado e baixado pelo servidor', 'success');
                } else {
                    log('❌ Servidor não conseguiu capturar', 'error');
                }
            } catch (error) {
                log('❌ Erro captura: ' + error.message, 'error');
            }
        }
        
        // Log inicial
        document.addEventListener('DOMContentLoaded', function() {
            log('🚀 Sistema carregado - Teste básico de funcionalidade');
        });
    </script>
</body>
</html>