<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste PDF Proxy</title>
    <style>
        body { font-family: sans-serif; max-width: 900px; margin: 0 auto; padding: 20px; }
        .container { background: white; padding: 20px; border: 1px solid #ddd; margin-bottom: 20px; }
        input[type="url"], select { width: 100%; padding: 8px; margin: 5px 0; }
        button { padding: 8px 15px; margin: 5px; cursor: pointer; }
        .example-url { background: #f0f0f0; padding: 8px; margin: 5px 0; cursor: pointer; border: 1px solid #ddd; }
        #log { background: #f8f8f8; padding: 10px; height: 300px; overflow-y: auto; font-family: monospace; font-size: 12px; }
        .pdf-viewer { width: 100%; height: 500px; border: 1px solid #ddd; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Teste PDF Proxy v2.2</h1>
        
        <label>URL do PDF:</label>
        <input type="url" id="pdfUrl" placeholder="Cole aqui a URL do PDF">
        
        <label><input type="checkbox" id="debugMode"> Modo Debug</label>
        
        <label>Estrat√©gia:</label>
        <select id="strategy">
            <option value="auto">Autom√°tica</option>
            <option value="direct">Direta</option>
            <option value="pje">PJe</option>
        </select>
        
        <div>
            <button onclick="testarPing()">Testar Conex√£o</button>
            <button onclick="testarProxy()">Testar Proxy</button>
            <button onclick="testarDireto()">Testar Direto</button>
            <button onclick="testarIframe()">Testar Iframe</button>
            <button onclick="limparLog()">Limpar Log</button>
        </div>
        
        <h3>URLs de Exemplo:</h3>
        <div class="example-url" onclick="usarUrl(this)">
            https://www.w3.org/WAI/ER/tests/xhtml/testfiles/resources/pdf/dummy.pdf
        </div>
        <div class="example-url" onclick="usarUrl(this)">
            https://www.adobe.com/support/products/enterprise/knowledgecenter/media/c4611_sample_explain.pdf
        </div>
        <div class="example-url" onclick="usarUrl(this)">
            https://pje.cloud.tjpe.jus.br/1g/seam/resource/rest/pje-legacy/documento/download/147308979
        </div>
    </div>
    
    <div class="container" id="resultContainer" style="display: none;">
        <h3>Resultado</h3>
        <iframe id="pdfViewer" class="pdf-viewer"></iframe>
        <div>
            <button onclick="forcarDownload()">For√ßar Download</button>
            <button onclick="capturarServidor()">Capturar Servidor</button>
        </div>
    </div>
    
    <div class="container">
        <h3>Log</h3>
        <div id="log"></div>
    </div>

    <script>
        function log(message, type = 'info') {
            const now = new Date().toLocaleTimeString();
            const logEl = document.getElementById('log');
            const colors = { info: '#000', success: '#0a0', error: '#a00', warning: '#fa0' };
            logEl.innerHTML += `<div style="color: ${colors[type] || '#000'}">[${now}] ${message}</div>`;
            logEl.scrollTop = logEl.scrollHeight;
        }
        
        function usarUrl(element) {
            const text = element.textContent.trim();
            document.getElementById('pdfUrl').value = text;
            log('URL selecionada: ' + text);
        }
        
        function limparLog() {
            document.getElementById('log').innerHTML = '';
            document.getElementById('resultContainer').style.display = 'none';
        }
        
        async function testarPing() {
            log('Testando conex√£o...');
            try {
                const response = await fetch('pdf_proxy.php?test=ping');
                if (response.ok) {
                    const data = await response.json();
                    log('‚úÖ Conex√£o OK: ' + data.message, 'success');
                } else {
                    log('‚ùå Erro HTTP: ' + response.status, 'error');
                }
            } catch (error) {
                log('‚ùå Erro: ' + error.message, 'error');
            }
        }
        
        async function testarDireto() {
            const url = document.getElementById('pdfUrl').value.trim();
            if (!url) return log('‚ùå URL vazia', 'error');
            
            log('Testando acesso direto...');
            try {
                const response = await fetch(url);
                log(`Resposta: ${response.status} ${response.statusText}`);
                if (response.ok) {
                    const contentType = response.headers.get('content-type');
                    if (contentType && contentType.includes('application/pdf')) {
                        log('‚úÖ PDF acess√≠vel diretamente', 'success');
                        mostrarPDF(url);
                    } else {
                        log('‚ö†Ô∏è N√£o √© PDF: ' + contentType, 'warning');
                    }
                } else {
                    log('‚ùå Falha no acesso direto', 'error');
                }
            } catch (error) {
                log('‚ùå Erro direto: ' + error.message, 'error');
            }
        }
        
        async function testarProxy() {
            const url = document.getElementById('pdfUrl').value.trim();
            if (!url) return log('‚ùå URL vazia', 'error');
            
            const debug = document.getElementById('debugMode').checked;
            const strategy = document.getElementById('strategy').value;
            
            let proxyUrl = `pdf_proxy.php?url=${encodeURIComponent(url)}`;
            if (debug) proxyUrl += '&debug=1';
            if (strategy !== 'auto') proxyUrl += `&strategy=${strategy}`;
            
            log('Testando via proxy...');
            try {
                const response = await fetch(proxyUrl);
                log(`Proxy resposta: ${response.status}`);
                
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/pdf')) {
                    log('‚úÖ PDF via proxy OK', 'success');
                    mostrarPDF(proxyUrl);
                } else if (contentType && contentType.includes('application/json')) {
                    const data = await response.json();
                    log('‚ùå Erro proxy: ' + data.message, 'error');
                } else {
                    log('‚ö†Ô∏è Proxy retornou HTML', 'warning');
                }
            } catch (error) {
                log('‚ùå Erro proxy: ' + error.message, 'error');
            }
        }
        
        function testarIframe() {
            const url = document.getElementById('pdfUrl').value.trim();
            if (!url) return log('‚ùå URL vazia', 'error');
            
            log('Carregando no iframe...');
            mostrarPDF(url);
            log('‚úÖ Iframe carregado. Fa√ßa login se necess√°rio.', 'success');
        }
        
        function mostrarPDF(url) {
            document.getElementById('pdfViewer').src = url;
            document.getElementById('resultContainer').style.display = 'block';
            window.currentPdfUrl = url;
        }
        
        function forcarDownload() {
            const url = window.currentPdfUrl || document.getElementById('pdfUrl').value;
            if (!url) return log('‚ùå Nenhuma URL para download', 'error');
            
            const a = document.createElement('a');
            a.href = url;
            a.download = 'documento_' + Date.now() + '.pdf';
            a.target = '_blank';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            log('‚úÖ Download iniciado', 'success');
        }
        
        async function capturarServidor() {
            const url = window.currentPdfUrl || document.getElementById('pdfUrl').value;
            if (!url) return log('‚ùå Nenhuma URL para capturar', 'error');
            
            log('Capturando via servidor...');
            try {
                const captureUrl = `pdf_proxy.php?url=${encodeURIComponent(url)}&action=download`;
                const response = await fetch(captureUrl);
                
                if (response.ok && response.headers.get('content-type').includes('application/pdf')) {
                    const blob = await response.blob();
                    const downloadUrl = URL.createObjectURL(blob);
                    
                    const a = document.createElement('a');
                    a.href = downloadUrl;
                    a.download = 'capturado_' + Date.now() + '.pdf';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    
                    URL.revokeObjectURL(downloadUrl);
                    log('‚úÖ Capturado e baixado pelo servidor', 'success');
                } else {
                    log('‚ùå Servidor n√£o conseguiu capturar', 'error');
                }
            } catch (error) {
                log('‚ùå Erro captura: ' + error.message, 'error');
            }
        }
        
        // Log inicial
        document.addEventListener('DOMContentLoaded', function() {
            log('üöÄ Sistema carregado - Teste b√°sico de funcionalidade');
        });
    </script>
</body>
</html>