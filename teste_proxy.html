<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste PDF Proxy</title>
    <style>
        body { font-family: sans-serif; max-width: 900px; margin: 0 auto; padding: 20px; }
        .container { background: white; padding: 20px; border: 1px solid #ddd; margin-bottom: 20px; }
        input[type="url"], select { width: 100%; padding: 8px; margin: 5px 0; }
        button { padding: 8px 15px; margin: 5px; cursor: pointer; }
        .example-url { background: #f0f0f0; padding: 8px; margin: 5px 0; cursor: pointer; border: 1px solid #ddd; }
        #log { background: #f8f8f8; padding: 10px; height: 300px; overflow-y: auto; font-family: monospace; font-size: 12px; }
        .pdf-viewer { width: 100%; height: 500px; border: 1px solid #ddd; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Teste PDF Proxy v2.4</h1>
        
        <label>URL do PDF:</label>
        <input type="url" id="pdfUrl" placeholder="Cole aqui a URL do PDF">
        
        <label><input type="checkbox" id="debugMode"> Modo Debug</label>
        
        <div>
            <button onclick="testarPing()">Testar Conex√£o</button>
            <button onclick="testarProxy()">Testar Proxy</button>
            <button onclick="testarIframe()">Testar Iframe</button>
            <button onclick="simularClique()">ü§ñ Simular Clique</button>
            <button onclick="limparLog()">Limpar</button>
        </div>
        
        <h3>URLs de Exemplo:</h3>
        <div class="example-url" onclick="usarUrl('https://www.w3.org/WAI/ER/tests/xhtml/testfiles/resources/pdf/dummy.pdf')">
            https://www.w3.org/WAI/ER/tests/xhtml/testfiles/resources/pdf/dummy.pdf
        </div>
        <div class="example-url" onclick="usarUrl('https://pje.cloud.tjpe.jus.br/1g/seam/resource/rest/pje-legacy/documento/download/147308979')">
            https://pje.cloud.tjpe.jus.br/1g/seam/resource/rest/pje-legacy/documento/download/147308979
        </div>
    </div>
    
    <div class="container" id="resultContainer" style="display: none;">
        <h3>Resultado</h3>
        <iframe id="pdfViewer" class="pdf-viewer"></iframe>
        <div>
            <button onclick="baixarPDF()">Baixar PDF</button>
            <button onclick="procurarBotao()">üîç Procurar Bot√£o</button>
        </div>
    </div>
    
    <div class="container">
        <h3>Log</h3>
        <div id="log"></div>
    </div>

    <script>
        function log(message, type = 'info') {
            const now = new Date().toLocaleTimeString();
            const logEl = document.getElementById('log');
            const colors = { info: '#000', success: '#0a0', error: '#a00', warning: '#fa0' };
            logEl.innerHTML += `<div style="color: ${colors[type] || '#000'}">[${now}] ${message}</div>`;
            logEl.scrollTop = logEl.scrollHeight;
        }
        
        function usarUrl(url) {
            document.getElementById('pdfUrl').value = url;
            log('URL selecionada: ' + url);
        }
        
        function limparLog() {
            document.getElementById('log').innerHTML = '';
            document.getElementById('resultContainer').style.display = 'none';
            log('Log limpo');
        }
        
        async function testarPing() {
            log('Testando conex√£o...');
            try {
                const response = await fetch('pdf_proxy.php?test=ping');
                if (response.ok) {
                    const data = await response.json();
                    log('‚úÖ Conex√£o OK: ' + data.message, 'success');
                } else {
                    log('‚ùå Erro HTTP: ' + response.status, 'error');
                }
            } catch (error) {
                log('‚ùå Erro: ' + error.message, 'error');
            }
        }
        
        async function testarProxy() {
            const url = document.getElementById('pdfUrl').value.trim();
            if (!url) {
                log('‚ùå URL vazia', 'error');
                return;
            }
            
            const debug = document.getElementById('debugMode').checked;
            let proxyUrl = `pdf_proxy.php?url=${encodeURIComponent(url)}`;
            if (debug) proxyUrl += '&debug=1';
            
            log('Testando via proxy...');
            try {
                const response = await fetch(proxyUrl);
                log(`Proxy resposta: ${response.status}`);
                
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/pdf')) {
                    log('‚úÖ PDF via proxy OK', 'success');
                    mostrarPDF(proxyUrl);
                } else if (contentType && contentType.includes('application/json')) {
                    const data = await response.json();
                    log('‚ùå Erro proxy: ' + data.message, 'error');
                } else {
                    log('‚ö†Ô∏è Proxy retornou HTML', 'warning');
                }
            } catch (error) {
                log('‚ùå Erro proxy: ' + error.message, 'error');
            }
        }
        
        function testarIframe() {
            const url = document.getElementById('pdfUrl').value.trim();
            if (!url) {
                log('‚ùå URL vazia', 'error');
                return;
            }
            
            log('Carregando no iframe...');
            mostrarPDF(url);
            log('‚úÖ Iframe carregado. Fa√ßa login se necess√°rio.', 'success');
        }
        
        function mostrarPDF(url) {
            document.getElementById('pdfViewer').src = url;
            document.getElementById('resultContainer').style.display = 'block';
            window.currentPdfUrl = url;
            log('PDF carregado na visualiza√ß√£o');
        }
        
        function simularClique() {
            log('ü§ñ Simulando clique no bot√£o de download...');
            
            const iframe = document.getElementById('pdfViewer');
            if (!iframe) {
                log('‚ùå Iframe n√£o encontrado', 'error');
                return;
            }
            
            try {
                const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                
                if (iframeDoc) {
                    log('‚úÖ Acesso ao iframe obtido!');
                    
                    // Procurar bot√µes de download
                    const botoes = iframeDoc.querySelectorAll('button, a, [role="button"]');
                    log(`Encontrados ${botoes.length} elementos clic√°veis`);
                    
                    let encontrou = false;
                    botoes.forEach((botao, index) => {
                        const texto = (botao.textContent || botao.title || '').toLowerCase();
                        const attrs = Array.from(botao.attributes).map(a => a.name + '=' + a.value).join(' ').toLowerCase();
                        
                        if (texto.includes('download') || texto.includes('baixar') || 
                            attrs.includes('download') || attrs.includes('baixar')) {
                            
                            log(`üéØ Bot√£o encontrado: "${texto}" - clicando...`);
                            botao.click();
                            encontrou = true;
                        }
                    });
                    
                    if (!encontrou) {
                        log('‚ùå Nenhum bot√£o de download encontrado');
                        // Tentar Ctrl+S
                        log('‚ö° Tentando Ctrl+S...');
                        const event = new KeyboardEvent('keydown', { key: 's', ctrlKey: true });
                        iframe.contentWindow.dispatchEvent(event);
                    } else {
                        log('‚úÖ Clique simulado!', 'success');
                    }
                    
                } else {
                    log('‚ùå CORS bloqueou acesso ao iframe', 'error');
                }
                
            } catch (error) {
                log('‚ùå Erro na simula√ß√£o: ' + error.message, 'error');
            }
        }
        
        function procurarBotao() {
            log('üîç Procurando bot√µes no iframe...');
            
            const iframe = document.getElementById('pdfViewer');
            if (!iframe) {
                log('‚ùå Iframe n√£o encontrado', 'error');
                return;
            }
            
            try {
                const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                
                if (iframeDoc) {
                    const botoes = iframeDoc.querySelectorAll('button, a, input[type="button"]');
                    log(`üìä Total: ${botoes.length} bot√µes`);
                    
                    botoes.forEach((botao, index) => {
                        if (index < 5) { // Mostrar apenas os primeiros 5
                            const texto = botao.textContent || botao.value || '';
                            log(`${index + 1}: "${texto}" - ${botao.tagName}`);
                        }
                    });
                    
                } else {
                    log('‚ùå CORS bloqueou an√°lise', 'error');
                }
                
            } catch (error) {
                log('‚ùå Erro: ' + error.message, 'error');
            }
        }
        
        async function baixarPDF() {
            const url = window.currentPdfUrl || document.getElementById('pdfUrl').value;
            if (!url) {
                log('‚ùå Nenhuma URL para download', 'error');
                return;
            }
            
            log('Baixando PDF...');
            
            try {
                const response = await fetch(`pdf_proxy.php?url=${encodeURIComponent(url)}&action=download`);
                
                if (response.ok && response.headers.get('content-type').includes('application/pdf')) {
                    const blob = await response.blob();
                    const downloadUrl = URL.createObjectURL(blob);
                    
                    const a = document.createElement('a');
                    a.href = downloadUrl;
                    a.download = 'documento_' + Date.now() + '.pdf';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    
                    URL.revokeObjectURL(downloadUrl);
                    log('‚úÖ PDF baixado!', 'success');
                } else {
                    log('‚ùå Falha no download via servidor', 'error');
                }
            } catch (error) {
                log('‚ùå Erro: ' + error.message, 'error');
            }
        }
        
        // Inicializa√ß√£o
        log('üöÄ Sistema carregado');
        log('üìù Para PJe: Iframe ‚Üí Login ‚Üí Simular Clique');
    </script>
</body>
</html>